<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Blue Banded Bee - Job Dashboard</title>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 20px;
        background: #f5f5f5;
      }
      .dashboard {
        max-width: 1200px;
        margin: 0 auto;
      }
      .header {
        background: white;
        padding: 20px;
        border-radius: 8px;
        margin-bottom: 20px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }
      .stats {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin-bottom: 20px;
      }
      .stat-card {
        background: white;
        padding: 20px;
        border-radius: 8px;
        text-align: center;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }
      .stat-value {
        font-size: 2em;
        font-weight: bold;
        color: #333;
      }
      .stat-label {
        color: #666;
        margin-top: 5px;
      }
      .jobs-table {
        background: white;
        border-radius: 8px;
        overflow: hidden;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }
      table {
        width: 100%;
        border-collapse: collapse;
      }
      th,
      td {
        padding: 12px;
        text-align: left;
        border-bottom: 1px solid #eee;
      }
      th {
        background: #f8f9fa;
        font-weight: 600;
      }
      .status {
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 12px;
        font-weight: bold;
      }
      .status.running {
        background: #e3f2fd;
        color: #1976d2;
      }
      .status.completed {
        background: #e8f5e8;
        color: #388e3c;
      }
      .status.failed {
        background: #ffebee;
        color: #d32f2f;
      }
      .status.pending {
        background: #fff3e0;
        color: #f57c00;
      }
      .progress-bar {
        width: 100%;
        height: 8px;
        background: #eee;
        border-radius: 4px;
        overflow: hidden;
      }
      .progress-fill {
        height: 100%;
        background: #4caf50;
        transition: width 0.3s;
      }
      .chart-container {
        background: white;
        padding: 20px;
        border-radius: 8px;
        margin-bottom: 20px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }
      .refresh-btn {
        background: #1976d2;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 4px;
        cursor: pointer;
      }
      .refresh-btn:hover {
        background: #1565c0;
      }
    </style>
  </head>
  <body>
    <div class="dashboard">
      <div class="header">
        <h1>üêù Blue Banded Bee Dashboard</h1>
        <div style="display: flex; align-items: center; gap: 15px; margin-top: 15px; flex-wrap: wrap;">
          <label>From:</label>
          <input type="date" id="dateFrom" />
          <label>To:</label>
          <input type="date" id="dateTo" />
          <label>Group by:</label>
          <select id="groupBy">
            <option value="auto">Auto</option>
            <option value="minute">Per Minute</option>
            <option value="hour">Per Hour</option>
            <option value="6hour">Per 6 Hours</option>
            <option value="day">Per Day</option>
          </select>
          <button class="refresh-btn" onclick="loadDashboard()">Refresh</button>
        </div>
      </div>

      <div class="stats" id="stats">
        <!-- Stats will be populated here -->
      </div>

      <div class="chart-container">
        <h3>Tasks Completed Over Time</h3>
        <canvas id="progressChart" width="400" height="100"></canvas>
      </div>

      <div class="jobs-table">
        <table>
          <thead>
            <tr>
              <th>Domain</th>
              <th>Status</th>
              <th>Sitemap</th>
              <th>Found</th>
              <th>Total</th>
              <th>Complete</th>
              <th>Failed</th>
              <th>Progress</th>
              <th>Avg Time/Task</th>
              <th>Started</th>
              <th>Completed</th>
            </tr>
          </thead>
          <tbody id="jobsTable">
            <!-- Jobs will be populated here -->
          </tbody>
        </table>
      </div>
    </div>

    <script>
      // Configure Supabase
      const SUPABASE_URL = "https://gpzjtbgtdjxnacdfujvx.supabase.co";
      const SUPABASE_ANON_KEY =
        "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imdwemp0Ymd0ZGp4bmFjZGZ1anZ4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDUwNjYxNjMsImV4cCI6MjA2MDY0MjE2M30.eJjM2-3X8oXsFex_lQKvFkP1-_yLMHsueIn7_hCF6YI";
      const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

      let progressChart = null;

      async function loadDashboard() {
        try {
          await Promise.all([loadStats(), loadJobs(), loadChart()]);
        } catch (error) {
          console.error("Dashboard load error:", error);
        }
      }

      async function loadStats() {
        const { data: jobs } = await supabase.from("job_list").select("*");

        const stats = {
          total: jobs.length,
          running: jobs.filter((j) => j.status === "running").length,
          completed: jobs.filter((j) => j.status === "completed").length,
          failed: jobs.filter((j) => j.status === "failed").length,
        };

        document.getElementById("stats").innerHTML = `
                <div class="stat-card">
                    <div class="stat-value">${stats.total}</div>
                    <div class="stat-label">Total Jobs</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${stats.running}</div>
                    <div class="stat-label">Running</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${stats.completed}</div>
                    <div class="stat-label">Completed</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${stats.failed}</div>
                    <div class="stat-label">Failed</div>
                </div>
            `;
      }

      async function loadJobs() {
        const { data: jobs } = await supabase.from("job_list").select("*").limit(20);

        const tbody = document.getElementById("jobsTable");
        tbody.innerHTML = jobs
          .map(
            (job) => `
                <tr>
                    <td>${job.domain}</td>
                    <td><span class="status ${job.status}">${job.status}</span></td>
                    <td>${job.sitemap_tasks || 0}</td>
                    <td>${job.found_tasks || 0}</td>
                    <td>${job.total_tasks || 0}</td>
                    <td>${job.completed_tasks || 0}</td>
                    <td>${job.failed_tasks || 0}</td>
                    <td>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: ${job.progress_percent || 0}%"></div>
                        </div>
                        ${Math.round(job.progress_percent || 0)}%
                    </td>
                    <td>${job.avg_seconds_per_task ? Math.round(job.avg_seconds_per_task) + "s" : "-"}</td>
                    <td>${job.started_at ? formatDate(job.started_at) : "-"}</td>
                    <td>${job.completed_at ? formatDate(job.completed_at) : "-"}</td>
                </tr>
            `
          )
          .join("");
      }

      async function loadChart() {
        // First try to get any tasks to see if we have access
        const { data: allTasks, error: accessError } = await supabase
          .from("tasks")
          .select("id, status, completed_at")
          .limit(5);

        console.log('Access test:', { allTasks, accessError, count: allTasks?.length });

        // If we can't access tasks table, show job progress instead
        if (accessError || !allTasks) {
          console.log('Cannot access tasks table, showing job progress instead');
          const { data: jobs } = await supabase.from("job_list").select("*").order("created_at", { ascending: true }).limit(20);
          
          const ctx = document.getElementById("progressChart").getContext("2d");
          if (progressChart) {
            progressChart.destroy();
          }
          
          progressChart = new Chart(ctx, {
            type: "line",
            data: {
              labels: jobs?.map(j => formatDate(j.created_at)) || ['No Data'],
              datasets: [{
                label: "Job Progress (%)",
                data: jobs?.map(j => j.progress_percent || 0) || [0],
                borderColor: "#1976d2",
                backgroundColor: "rgba(25, 118, 210, 0.1)",
                fill: true,
              }],
            },
            options: {
              responsive: true,
              scales: { y: { beginAtZero: true, max: 100 } },
            },
          });
          return;
        }

        // Get date range and grouping from inputs
        const dateFrom = document.getElementById('dateFrom').value;
        const dateTo = document.getElementById('dateTo').value;
        const groupByValue = document.getElementById('groupBy').value;
        
        let query = supabase
          .from("tasks")
          .select("completed_at")
          .eq("status", "completed")
          .not("completed_at", "is", null)
          .order("completed_at", { ascending: true });
          
        // Apply date filters if set (convert to full day ranges in local timezone)
        if (dateFrom) {
          const startOfDay = new Date(dateFrom + 'T00:00:00');
          query = query.gte('completed_at', startOfDay.toISOString());
        }
        if (dateTo) {
          const endOfDay = new Date(dateTo + 'T23:59:59.999');
          query = query.lte('completed_at', endOfDay.toISOString());
        }
        
        const { data: tasks, error } = await query.limit(50000);

        console.log('Completed tasks:', { tasks, error, count: tasks?.length, dateFrom, dateTo, groupBy: groupByValue });
        
        // Debug: Show first few tasks if we have them
        if (tasks && tasks.length > 0) {
          console.log('Sample tasks:', tasks.slice(0, 3));
        }
        
        // Debug: Check if we have tasks with different statuses
        const { data: allTaskStatuses } = await supabase
          .from("tasks")
          .select("status")
          .limit(10);
        console.log('Task statuses sample:', allTaskStatuses);

        if (!tasks || tasks.length === 0) {
          console.log('No completed tasks found, trying job progress fallback');
          
          // Fallback: Show job progress over time instead
          const { data: jobs } = await supabase.from("job_list").select("created_at, progress_percent, completed_tasks, total_tasks").order("created_at", { ascending: true }).limit(20);
          console.log('Fallback jobs data:', jobs);
          
          const ctx = document.getElementById("progressChart").getContext("2d");
          if (progressChart) {
            progressChart.destroy();
          }
          
          if (jobs && jobs.length > 0) {
            progressChart = new Chart(ctx, {
              type: "bar",
              data: {
                labels: jobs.map(j => formatDate(j.created_at)),
                datasets: [{
                  label: "Tasks Completed per Job",
                  data: jobs.map(j => j.completed_tasks || 0),
                  backgroundColor: "rgba(76, 175, 80, 0.7)",
                  borderColor: "#4caf50",
                  borderWidth: 1,
                }],
              },
              options: {
                responsive: true,
                scales: { y: { beginAtZero: true } },
              },
            });
          } else {
            progressChart = new Chart(ctx, {
              type: "bar",
              data: {
                labels: ['No Data'],
                datasets: [{
                  label: "Tasks Completed",
                  data: [0],
                  backgroundColor: "rgba(76, 175, 80, 0.7)",
                }],
              },
            });
          }
          return;
        }

        // Determine date range and grouping strategy
        const startDate = dateFrom ? new Date(dateFrom) : new Date(Math.min(...tasks.map(t => new Date(t.completed_at))));
        const endDate = dateTo ? new Date(dateTo) : new Date(Math.max(...tasks.map(t => new Date(t.completed_at))));
        const rangeDays = (endDate - startDate) / (1000 * 60 * 60 * 24);
        
        // Determine grouping method
        let grouping;
        if (groupByValue === 'auto') {
          if (rangeDays <= 1) grouping = 'minute';
          else if (rangeDays <= 5) grouping = 'hour';
          else if (rangeDays <= 30) grouping = '6hour';
          else grouping = 'day';
        } else {
          grouping = groupByValue;
        }
        
        // Define grouping functions
        function getTimeKey(date, groupType) {
          const d = new Date(date);
          switch (groupType) {
            case 'minute':
              return d.toISOString().slice(0, 16) + ':00.000Z'; // YYYY-MM-DDTHH:MM:00.000Z
            case 'hour':
              return d.toISOString().slice(0, 13) + ':00:00.000Z'; // YYYY-MM-DDTHH:00:00.000Z
            case '6hour':
              const hour6 = Math.floor(d.getUTCHours() / 6) * 6;
              return d.toISOString().slice(0, 11) + String(hour6).padStart(2, '0') + ':00:00.000Z';
            case 'day':
              return d.toISOString().slice(0, 10) + 'T00:00:00.000Z'; // YYYY-MM-DDTHH:00:00.000Z
            default:
              return d.toISOString().slice(0, 16) + ':00.000Z';
          }
        }
        
        function formatTimeLabel(timeKey, groupType) {
          const d = new Date(timeKey);
          switch (groupType) {
            case 'minute':
              return d.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit', hour12: true});
            case 'hour':
              return d.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit', hour12: true});
            case '6hour':
              return d.toLocaleDateString([], {month: 'short', day: 'numeric'}) + ' ' + 
                     d.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit', hour12: true});
            case 'day':
              return d.toLocaleDateString([], {month: 'short', day: 'numeric'});
            default:
              return d.toLocaleString();
          }
        }
        
        function getGroupLabel(groupType) {
          return 'Tasks Completed';
        }
        
        // Group tasks by time period
        const timeBuckets = {};
        tasks.forEach((task) => {
          // Use the UTC timestamp directly for grouping
          const utcTime = new Date(task.completed_at);
          const key = getTimeKey(utcTime, grouping);
          timeBuckets[key] = (timeBuckets[key] || 0) + 1;
        });

        // Convert to arrays for Chart.js
        const labels = Object.keys(timeBuckets).sort();
        const data = labels.map((label) => timeBuckets[label]);

        const ctx = document.getElementById("progressChart").getContext("2d");

        if (progressChart) {
          progressChart.destroy();
        }

        progressChart = new Chart(ctx, {
          type: "bar",
          data: {
            labels: labels.map((label) => formatTimeLabel(label, grouping)),
            datasets: [
              {
                label: getGroupLabel(grouping),
                data: data,
                backgroundColor: "rgba(76, 175, 80, 0.7)",
                borderColor: "#4caf50",
                borderWidth: 1,
              },
            ],
          },
          options: {
            responsive: true,
            interaction: {
              intersect: false,
              mode: 'index',
            },
            scales: {
              y: {
                beginAtZero: true,
              },
              x: {
                display: true,
                ticks: {
                  maxTicksLimit: 20
                }
              }
            },
          },
        });
      }

      function formatDuration(seconds) {
        if (!seconds) return "-";
        const mins = Math.floor(seconds / 60);
        const secs = Math.floor(seconds % 60);
        return `${mins}m ${secs}s`;
      }

      function formatDate(dateStr) {
        return new Date(dateStr).toLocaleString();
      }

      // Initialize date pickers with default range (today)
      function initializeDatePickers() {
        const today = new Date();
        const todayStr = today.getFullYear() + '-' + 
          String(today.getMonth() + 1).padStart(2, '0') + '-' + 
          String(today.getDate()).padStart(2, '0');
        
        document.getElementById('dateFrom').value = todayStr;
        document.getElementById('dateTo').value = todayStr;
      }

      // Auto-refresh every 10 seconds for live monitoring
      setInterval(loadDashboard, 10000);

      // Initial setup
      initializeDatePickers();
      loadDashboard();
    </script>
  </body>
</html>
