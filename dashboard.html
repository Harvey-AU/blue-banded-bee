<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Blue Banded Bee - Dashboard</title>

    <!-- Supabase CDN -->
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>

    <!-- Password strength library -->
    <script src="https://cdn.jsdelivr.net/npm/zxcvbn@4.4.2/dist/zxcvbn.js"></script>

    <!-- Cloudflare Turnstile CAPTCHA -->
    <script src="https://challenges.cloudflare.com/turnstile/v0/api.js" async defer></script>

    <style>
      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
        margin: 0;
        padding: 0;
        background: #f5f7fa;
        min-height: 100vh;
      }

      .page-header {
        background: white;
        border-bottom: 1px solid #e5e7eb;
        padding: 24px 0;
        position: sticky;
        top: 0;
        z-index: 100;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
      }

      .page-header .container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 0 24px;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .page-title {
        display: flex;
        align-items: center;
        gap: 12px;
        margin: 0;
        font-size: 1.5rem;
        font-weight: 700;
        color: #1a1a1a;
      }

      .bee-icon {
        font-size: 1.8rem;
      }

      .page-nav {
        display: flex;
        gap: 24px;
        align-items: center;
      }

      .nav-link {
        color: #6b7280;
        text-decoration: none;
        font-weight: 500;
        transition: color 0.2s ease;
      }

      .nav-link:hover,
      .nav-link.active {
        color: #3b82f6;
      }

      .user-menu {
        display: flex;
        align-items: center;
        gap: 12px;
      }

      .auth-buttons {
        display: flex;
        gap: 8px;
      }

      .user-info {
        display: flex;
        align-items: center;
        gap: 12px;
        font-size: 14px;
      }

      .bb-button {
        padding: 8px 16px;
        border-radius: 6px;
        border: none;
        font-size: 14px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s ease;
      }

      .bb-button-primary {
        background: #3b82f6;
        color: white;
      }

      .bb-button-primary:hover {
        background: #2563eb;
      }

      .bb-button-outline {
        background: transparent;
        color: #6b7280;
        border: 1px solid #d1d5db;
      }

      .bb-button-outline:hover {
        background: #f9fafb;
        border-color: #9ca3af;
      }

      .user-avatar {
        width: 32px;
        height: 32px;
        border-radius: 50%;
        background: #3b82f6;
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 600;
        font-size: 14px;
      }

      .main-content {
        max-width: 1200px;
        margin: 0 auto;
        padding: 24px;
      }

      .dashboard-actions {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 24px;
        padding: 20px;
        background: white;
        border-radius: 12px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      }

      .dashboard-filters {
        display: flex;
        gap: 16px;
        align-items: center;
      }

      .filter-group {
        display: flex;
        flex-direction: column;
        gap: 4px;
      }

      .filter-label {
        font-size: 12px;
        font-weight: 500;
        color: #6b7280;
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }

      .filter-select {
        padding: 8px 12px;
        border: 1px solid #d1d5db;
        border-radius: 6px;
        font-size: 14px;
        background: white;
        color: #374151;
      }

      .filter-select:focus {
        outline: none;
        border-color: #3b82f6;
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
      }

      .filter-tabs {
        display: flex;
        gap: 8px;
        align-items: center;
      }

      .filter-tab {
        padding: 8px 16px;
        border-radius: 6px;
        text-decoration: none;
        color: #6b7280;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s ease;
        border: 1px solid #d1d5db;
      }

      .filter-tab:hover {
        background-color: #f3f4f6;
        border-color: #9ca3af;
      }

      .filter-tab.active {
        background-color: #3b82f6;
        color: white;
        border-color: #3b82f6;
      }

      .page-actions {
        display: flex;
        gap: 12px;
      }

      .status-indicator {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        font-size: 12px;
        color: #6b7280;
      }

      .status-dot {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background: #22c55e;
        animation: pulse 2s infinite;
      }

      @keyframes pulse {
        0%,
        100% {
          opacity: 1;
        }
        50% {
          opacity: 0.5;
        }
      }

      /* Job status visual enhancements */
      .job-running {
        border-left: 4px solid #3b82f6;
        background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
      }

      .job-completed {
        border-left: 4px solid #22c55e;
      }

      .job-failed {
        border-left: 4px solid #ef4444;
      }

      .job-cancelled {
        border-left: 4px solid #6b7280;
        opacity: 0.7;
      }

      .progress-pulsing {
        animation: progressPulse 2s ease-in-out infinite;
      }

      @keyframes progressPulse {
        0%,
        100% {
          opacity: 1;
          transform: scaleY(1);
        }
        50% {
          opacity: 0.8;
          transform: scaleY(0.95);
        }
      }

      .bb-btn {
        padding: 8px 16px;
        border-radius: 6px;
        border: none;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s ease;
        display: inline-flex;
        align-items: center;
        gap: 6px;
        text-decoration: none;
      }

      .bb-btn-primary {
        background: #3b82f6;
        color: white;
      }

      .bb-btn-primary:hover {
        background: #2563eb;
      }

      .bb-btn-secondary {
        background: #f3f4f6;
        color: #374151;
      }

      .bb-btn-secondary:hover {
        background: #e5e7eb;
      }

      .bb-status-running {
        background: #dbeafe;
        color: #1d4ed8;
      }
      .bb-status-completed {
        background: #dcfce7;
        color: #16a34a;
      }
      .bb-status-failed {
        background: #fee2e2;
        color: #dc2626;
      }
      .bb-status-pending {
        background: #fef3c7;
        color: #d97706;
      }
      .bb-status-cancelled {
        background: #f3f4f6;
        color: #6b7280;
      }

      .bb-stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
      }

      .bb-stat-card {
        background: white;
        padding: 24px;
        border-radius: 12px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        text-align: center;
        border: 1px solid #f0f0f0;
      }

      .bb-stat-value {
        font-size: 2.5em;
        font-weight: 700;
        margin-bottom: 8px;
        color: #1a1a1a;
      }

      .bb-stat-label {
        color: #666;
        font-size: 14px;
        font-weight: 500;
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }

      .bb-jobs-section {
        background: white;
        border-radius: 12px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        overflow: hidden;
        margin-bottom: 30px;
      }

      .bb-section-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 24px 24px 0 24px;
        margin-bottom: 20px;
      }

      .bb-section-header h3 {
        margin: 0;
        font-size: 1.25em;
        font-weight: 600;
      }

      .bb-section-actions {
        display: flex;
        gap: 12px;
      }

      .bb-jobs-list {
        padding: 0 24px 24px 24px;
      }

      .bb-job-card {
        background: #f8f9fa;
        border: 1px solid #e9ecef;
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 16px;
      }

      .bb-job-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 16px;
      }

      .bb-job-domain {
        font-weight: 600;
        font-size: 1.1em;
        color: #1a1a1a;
      }

      .bb-job-status {
        padding: 6px 12px;
        border-radius: 20px;
        font-size: 12px;
        font-weight: 600;
        text-transform: uppercase;
      }

      .bb-job-progress {
        margin-bottom: 16px;
      }

      .bb-progress-bar {
        width: 100%;
        height: 8px;
        background: #e5e7eb;
        border-radius: 4px;
        overflow: hidden;
        margin-bottom: 8px;
      }

      .bb-progress-fill {
        height: 100%;
        background: linear-gradient(90deg, #3b82f6, #1d4ed8);
        transition: width 0.3s ease;
      }

      .bb-job-details {
        font-size: 14px;
        color: #6b7280;
      }

      .bb-job-footer {
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-size: 14px;
      }

      .bb-job-started {
        color: #6b7280;
      }

      .bb-job-actions {
        display: flex;
        gap: 8px;
      }

      .bb-job-link {
        background: none;
        border: none;
        color: #3b82f6;
        cursor: pointer;
        text-decoration: underline;
        font-size: 14px;
        margin-right: 12px;
      }

      .bb-job-link:hover {
        color: #2563eb;
      }

      .bb-job-link[data-bb-show-if] {
        display: none;
      }

      /* Modal Styles */
      .bb-modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 1000;
      }

      .bb-modal.show {
        display: flex;
      }

      .bb-modal-content {
        background: white;
        border-radius: 12px;
        padding: 32px;
        max-width: 800px;
        width: 90%;
        max-height: 80vh;
        overflow-y: auto;
        box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
      }

      .bb-modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 24px;
        padding-bottom: 16px;
        border-bottom: 1px solid #e5e7eb;
      }

      .bb-modal-title {
        font-size: 1.5rem;
        font-weight: 600;
        margin: 0;
      }

      .bb-modal-close {
        background: none;
        border: none;
        font-size: 24px;
        cursor: pointer;
        color: #6b7280;
      }

      .bb-modal-close:hover {
        color: #374151;
      }

      .bb-modal-section {
        margin-bottom: 24px;
      }

      .bb-modal-section-title {
        font-size: 1.1rem;
        font-weight: 600;
        margin-bottom: 12px;
        color: #374151;
      }

      .bb-job-info-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 16px;
        margin-bottom: 24px;
      }

      .bb-info-item {
        background: #f9fafb;
        padding: 16px;
        border-radius: 8px;
        border: 1px solid #e5e7eb;
      }

      .bb-info-label {
        font-size: 12px;
        font-weight: 500;
        color: #6b7280;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-bottom: 4px;
      }

      .bb-info-value {
        font-size: 16px;
        font-weight: 600;
        color: #1f2937;
      }

      .bb-tasks-table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 16px;
      }

      .bb-tasks-table th,
      .bb-tasks-table td {
        padding: 12px;
        text-align: left;
        border-bottom: 1px solid #e5e7eb;
      }

      .bb-tasks-table th {
        background: #f9fafb;
        font-weight: 600;
        color: #374151;
        font-size: 14px;
      }

      .bb-tasks-table td {
        font-size: 14px;
        color: #6b7280;
      }

      .bb-task-path {
        font-family: "Monaco", "Menlo", monospace;
        background: #f3f4f6;
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 12px;
      }

      .bb-task-status {
        padding: 4px 8px;
        border-radius: 12px;
        font-size: 11px;
        font-weight: 600;
        text-transform: uppercase;
      }

      .bb-loading {
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 40px;
        color: #6b7280;
      }

      .bb-error {
        color: #dc2626;
        background: #fee2e2;
        padding: 12px 16px;
        border-radius: 8px;
        margin: 16px 0;
      }

      .loading {
        color: #6b7280;
        font-style: italic;
      }

      /* Authentication Modal Styles */
      .bb-auth-form {
        padding: 8px 0;
      }

      .bb-form-group {
        margin-bottom: 20px;
      }

      .bb-form-group label {
        display: block;
        margin-bottom: 6px;
        font-weight: 500;
        color: #374151;
        font-size: 14px;
      }

      .bb-form-input {
        width: 100%;
        padding: 12px 16px;
        border: 1px solid #d1d5db;
        border-radius: 6px;
        font-size: 14px;
        background: white;
        color: #374151;
        box-sizing: border-box;
      }

      .bb-form-input:focus {
        outline: none;
        border-color: #3b82f6;
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
      }

      .bb-button-full {
        width: 100%;
        margin-bottom: 16px;
      }

      .bb-auth-divider {
        text-align: center;
        margin: 24px 0;
        position: relative;
        color: #6b7280;
        font-size: 14px;
      }

      .bb-auth-divider::before {
        content: "";
        position: absolute;
        top: 50%;
        left: 0;
        right: 0;
        height: 1px;
        background: #e5e7eb;
        z-index: 1;
      }

      .bb-auth-divider span {
        background: white;
        padding: 0 16px;
        position: relative;
        z-index: 2;
      }

      .bb-social-buttons {
        display: flex;
        flex-direction: column;
        gap: 12px;
        margin-bottom: 24px;
      }

      .bb-social-btn {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 12px;
        position: relative;
      }

      .bb-social-icon {
        width: 20px;
        height: 20px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        font-size: 12px;
      }

      .bb-auth-links {
        text-align: center;
      }

      .bb-auth-links a {
        color: #3b82f6;
        text-decoration: none;
        font-size: 14px;
        display: block;
        margin-bottom: 8px;
      }

      .bb-auth-links a:hover {
        text-decoration: underline;
      }

      .bb-auth-loading {
        text-align: center;
        padding: 40px 20px;
      }

      .bb-spinner {
        width: 32px;
        height: 32px;
        border: 3px solid #e5e7eb;
        border-top: 3px solid #3b82f6;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin: 0 auto 16px;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      .bb-auth-error {
        background: #fee2e2;
        color: #dc2626;
        padding: 12px 16px;
        border-radius: 6px;
        margin-bottom: 16px;
        font-size: 14px;
        border: 1px solid #fecaca;
      }

      /* Password Strength Indicator */
      .bb-password-strength {
        margin-top: 8px;
        padding: 12px;
        background: #f9fafb;
        border-radius: 6px;
        border: 1px solid #e5e7eb;
      }

      .bb-strength-meter {
        width: 100%;
        height: 8px;
        background: #e5e7eb;
        border-radius: 4px;
        overflow: hidden;
        margin-bottom: 8px;
      }

      .bb-strength-fill {
        height: 100%;
        transition: all 0.3s ease;
        border-radius: 4px;
      }

      .bb-strength-fill.weak {
        width: 25%;
        background: #ef4444;
      }

      .bb-strength-fill.fair {
        width: 50%;
        background: #f59e0b;
      }

      .bb-strength-fill.good {
        width: 75%;
        background: #eab308;
      }

      .bb-strength-fill.strong {
        width: 100%;
        background: #22c55e;
      }

      .bb-strength-text {
        font-size: 12px;
        font-weight: 600;
        margin-bottom: 4px;
      }

      .bb-strength-text.weak {
        color: #ef4444;
      }

      .bb-strength-text.fair {
        color: #f59e0b;
      }

      .bb-strength-text.good {
        color: #eab308;
      }

      .bb-strength-text.strong {
        color: #22c55e;
      }

      .bb-strength-feedback {
        font-size: 11px;
        color: #6b7280;
        line-height: 1.4;
      }

      /* Field validation states */
      .bb-field-valid {
        border-color: #22c55e !important;
        box-shadow: 0 0 0 3px rgba(34, 197, 94, 0.1) !important;
      }

      .bb-field-invalid {
        border-color: #ef4444 !important;
        box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.1) !important;
      }

      .bb-field-error {
        color: #dc2626;
        font-size: 12px;
        margin-top: 4px;
      }

      /* Global notification system */
      .bb-notification {
        position: fixed;
        top: 20px;
        right: 20px;
        max-width: 400px;
        z-index: 10000;
        transform: translateX(100%);
        transition: transform 0.3s ease;
        opacity: 0;
      }

      .bb-notification-show {
        transform: translateX(0);
        opacity: 1;
      }

      .bb-notification-content {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 16px 20px;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        font-size: 14px;
        font-weight: 500;
      }

      .bb-notification-error .bb-notification-content {
        background: #fee2e2;
        color: #dc2626;
        border: 1px solid #fecaca;
      }

      .bb-notification-success .bb-notification-content {
        background: #dcfce7;
        color: #16a34a;
        border: 1px solid #bbf7d0;
      }

      .bb-notification-info .bb-notification-content {
        background: #dbeafe;
        color: #1d4ed8;
        border: 1px solid #bfdbfe;
      }

      .bb-notification-icon {
        font-size: 16px;
        flex-shrink: 0;
      }

      .bb-notification-message {
        flex: 1;
        line-height: 1.4;
      }

      .bb-notification-close {
        background: none;
        border: none;
        font-size: 18px;
        font-weight: bold;
        cursor: pointer;
        color: inherit;
        opacity: 0.7;
        transition: opacity 0.2s ease;
        padding: 0;
        width: 20px;
        height: 20px;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .bb-notification-close:hover {
        opacity: 1;
      }

      /* Dropdown menu styles */
      .bb-dropdown {
        position: relative;
        display: inline-block;
      }

      .bb-dropdown-menu {
        position: absolute;
        top: 100%;
        right: 0;
        margin-top: 4px;
        background: white;
        border: 1px solid #e5e7eb;
        border-radius: 6px;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        min-width: 160px;
        z-index: 10;
        display: none;
      }

      .bb-dropdown-menu.show {
        display: block;
      }

      .bb-dropdown-item {
        display: block;
        width: 100%;
        padding: 8px 16px;
        text-align: left;
        background: none;
        border: none;
        cursor: pointer;
        font-size: 14px;
        color: #374151;
        transition: background-color 0.2s;
      }

      .bb-dropdown-item:hover {
        background-color: #f3f4f6;
      }

      .bb-dropdown-item:first-child {
        border-radius: 5px 5px 0 0;
      }

      .bb-dropdown-item:last-child {
        border-radius: 0 0 5px 5px;
      }

      @media (max-width: 768px) {
        .page-header .container {
          padding: 0 16px;
        }

        .page-nav {
          display: none;
        }

        .main-content {
          padding: 16px;
        }

        .dashboard-actions {
          flex-direction: column;
          align-items: stretch;
          gap: 16px;
        }

        .dashboard-filters {
          justify-content: space-between;
        }

        .page-actions {
          justify-content: center;
        }
      }

      /* Analysis sections styles */
      .bb-analysis-section {
        background: white;
        border-radius: 8px;
        padding: 24px;
        margin-bottom: 24px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
      }

      .bb-analysis-card {
        border: 1px solid #e5e7eb;
        border-radius: 6px;
        padding: 16px;
        margin-bottom: 12px;
        background: #fafbfc;
      }

      .bb-analysis-card:last-child {
        margin-bottom: 0;
      }

      .bb-analysis-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 8px;
      }

      .bb-analysis-url {
        font-family: 'Monaco', 'Consolas', monospace;
        font-size: 0.9rem;
        font-weight: 500;
        color: #1f2937;
        word-break: break-all;
      }

      .bb-analysis-metric {
        font-size: 0.9rem;
        color: #6b7280;
        white-space: nowrap;
      }

      .bb-analysis-details {
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-size: 0.85rem;
        color: #9ca3af;
      }

      .bb-analysis-domain {
        color: #059669;
        font-weight: 500;
      }

      .bb-redirect-url {
        font-family: 'Monaco', 'Consolas', monospace;
        font-size: 0.85rem;
        color: #dc2626;
        word-break: break-all;
        margin-top: 4px;
      }

      .bb-analysis-empty {
        text-align: center;
        color: #6b7280;
        font-style: italic;
        padding: 32px 16px;
      }
    </style>
  <!-- Google tag (gtag.js) -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-D990P29YMF"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'G-D990P29YMF');
  </script>
  </head>

  <body>
    <!-- Page Header -->
    <header class="page-header">
      <div class="container">
        <h1 class="page-title">
          <span class="bee-icon">üêù</span>
          Blue Banded Bee
        </h1>


        <div class="user-menu">
          <div class="status-indicator">
            <span class="status-dot"></span>
            <span>Live</span>
          </div>

          <!-- Show when logged out -->
          <div data-bb-auth="guest" class="auth-buttons">
            <button id="loginBtn" class="bb-button bb-button-primary">Sign In</button>
          </div>

          <!-- Show when logged in -->
          <div data-bb-auth="required" class="user-info">
            <span id="userEmail">Loading...</span>
            <div class="user-avatar" id="userAvatar">?</div>
            <button id="logoutBtn" class="bb-button bb-button-outline">Sign Out</button>
          </div>
        </div>
      </div>
    </header>

    <!-- Main Content -->
    <main class="main-content">
      <!-- Job Creation Form -->
      <div style="background: white; border-radius: 12px; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1); margin-bottom: 24px; padding: 24px;">
        <h2 style="margin: 0 0 16px 0; font-size: 1.25rem; font-weight: 600; color: #374151;">Start Cache Warming</h2>
        
        <form id="dashboardJobForm" style="display: grid; grid-template-columns: 1fr 120px 120px auto; gap: 16px; align-items: end;">
          <div>
            <label style="display: block; margin-bottom: 6px; font-weight: 500; color: #374151; font-size: 14px;">Domain</label>
            <input 
              type="text" 
              id="dashboardDomain" 
              name="domain" 
              required 
              placeholder="example.com" 
              style="width: 100%; padding: 12px 16px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 14px; background: white; color: #374151; box-sizing: border-box;"
            />
          </div>
          
          <div>
            <label style="display: block; margin-bottom: 6px; font-weight: 500; color: #374151; font-size: 14px;">Max Pages</label>
            <input 
              type="number" 
              id="dashboardMaxPages" 
              name="max_pages" 
              min="0" 
              max="10000" 
              value="0" 
              style="width: 100%; padding: 12px 16px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 14px; background: white; color: #374151; box-sizing: border-box;"
            />
          </div>
          
          <div>
            <label style="display: block; margin-bottom: 6px; font-weight: 500; color: #374151; font-size: 14px;">Refresh</label>
            <select class="filter-select" id="refreshInterval" style="width: 100%; padding: 12px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 14px; background: white;">
              <option value="0">Manual</option>
              <option value="10" selected>10 seconds</option>
              <option value="30">30 seconds</option>
              <option value="60">1 minute</option>
            </select>
          </div>
          
          <button 
            type="submit" 
            class="bb-button bb-button-primary" 
            style="padding: 12px 24px; white-space: nowrap;"
          >
            Start Crawl
          </button>
        </form>
      </div>
      
      <!-- Dashboard Controls -->
      <div class="dashboard-actions">
        <div class="dashboard-filters">
          <div class="filter-group">
            <label class="filter-label">Date Range</label>
            <select class="filter-select" id="dateRange">
              <option value="today" selected>Today</option>
              <option value="last7">Last 7 Days</option>
              <option value="last30">Last 30 Days</option>
              <option value="last90">Last 90 Days</option>
              <option value="all">All Time</option>
            </select>
          </div>
        </div>

        <div class="page-actions">
          <button class="bb-btn bb-btn-secondary" bb-action="refresh-dashboard"><span>‚Üª</span> Refresh</button>
        </div>
      </div>

      <!-- Login Interface for Unauthenticated Users -->
      <div id="loginContent" data-bb-auth="guest">
        <div style="max-width: 400px; margin: 80px auto; padding: 40px; background: white; border-radius: 12px; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);">
          <div style="text-align: center; margin-bottom: 32px;">
            <div style="font-size: 48px; margin-bottom: 16px;">üêù</div>
            <h1 style="font-size: 1.875rem; font-weight: 700; margin-bottom: 8px; color: #1a1a1a;">Blue Banded Bee</h1>
            <p style="color: #6b7280; font-size: 14px;">Cache warming service dashboard</p>
          </div>
          
          <div style="display: flex; gap: 12px; margin-bottom: 24px;">
            <button id="showLoginBtn" class="bb-button bb-button-primary" style="flex: 1;">Sign In</button>
            <button id="showSignupBtn" class="bb-button bb-button-outline" style="flex: 1;">Create Account</button>
          </div>
          
          <div style="text-align: center; color: #6b7280; font-size: 14px;">
            Sign in to access your dashboard
          </div>
        </div>
      </div>

      <!-- Dashboard Content for Authenticated Users -->
      <div id="dashboardContent" data-bb-auth="required" style="display: none;">
        <!-- Stats Overview Cards -->
        <div class="bb-stats-grid">
          <div class="bb-stat-card">
            <div class="bb-stat-value" data-bb-bind="stats.total_jobs">-</div>
            <div class="bb-stat-label">Total Jobs</div>
          </div>
          <div class="bb-stat-card">
            <div class="bb-stat-value" data-bb-bind="stats.running_jobs">-</div>
            <div class="bb-stat-label">Running</div>
          </div>
          <div class="bb-stat-card">
            <div class="bb-stat-value" data-bb-bind="stats.completed_jobs">-</div>
            <div class="bb-stat-label">Completed</div>
          </div>
          <div class="bb-stat-card">
            <div class="bb-stat-value" data-bb-bind="stats.failed_jobs">-</div>
            <div class="bb-stat-label">Failed</div>
          </div>
        </div>

        <!-- Recent Jobs Section with Data Binding Templates -->
        <div class="bb-jobs-section">
          <div class="bb-section-header">
            <h3>Recent Jobs</h3>
            <div class="bb-section-actions">
              <button class="bb-btn bb-btn-secondary" bb-action="refresh-dashboard"><span>‚Üª</span> Refresh</button>
              <button class="bb-btn bb-btn-primary" bb-action="create-job"><span>+</span> New Job</button>
            </div>
          </div>

          <div class="bb-jobs-list">
            <!-- Job Template (uses data-bb-template for automatic rendering) -->
            <div class="bb-job-card" data-bb-template="job">
              <div class="bb-job-header">
                <div class="bb-job-domain" data-bb-bind="domain">example.com</div>
                <div class="bb-job-status" data-bb-bind-attr="class:bb-status-{status}" data-bb-bind="status">pending</div>
              </div>
              <div class="bb-job-progress">
                <div class="bb-progress-bar">
                  <div class="bb-progress-fill" data-bb-bind-style="width:{progress}%"></div>
                </div>
                <div class="bb-job-details">
                  <span data-bb-bind="completed_tasks">0</span> / <span data-bb-bind="total_tasks">0</span> tasks (<span data-bb-bind="progress"
                    >0</span
                  >%)
                </div>
              </div>
              <div class="bb-job-footer">
                <div class="bb-job-started">
                  <span style="font-weight: 500">Started:</span>
                  <span data-bb-bind="started_at_formatted">-</span>
                </div>
                <div class="bb-job-actions">
                  <button class="bb-job-link" bb-action="view-job-details" data-bb-bind-attr="bb-data-job-id:{id}">View Details</button>
                  <button
                    class="bb-job-link"
                    bb-action="restart-job"
                    data-bb-bind-attr="bb-data-job-id:{id}"
                    data-bb-show-if="status=completed,failed,cancelled"
                  >
                    Restart
                  </button>
                  <button class="bb-job-link" bb-action="cancel-job" data-bb-bind-attr="bb-data-job-id:{id}" data-bb-show-if="status=running,pending">
                    Cancel
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Slow Pages Analysis Section -->
        <div class="bb-analysis-section">
          <div class="bb-section-header">
            <h3>Slow Pages Analysis</h3>
            <div class="bb-section-actions">
              <button class="bb-btn bb-btn-secondary" bb-action="refresh-slow-pages"><span>‚Üª</span> Refresh</button>
            </div>
          </div>
          <div class="bb-analysis-list">
            <!-- Slow Page Template -->
            <div class="bb-analysis-card" data-bb-template="slow_page">
              <div class="bb-analysis-header">
                <div class="bb-analysis-url" data-bb-bind="url">https://example.com/slow-page</div>
                <div class="bb-analysis-metric">
                  <span data-bb-bind="second_response_time">0</span>ms
                </div>
              </div>
              <div class="bb-analysis-details">
                <span class="bb-analysis-domain" data-bb-bind="domain">example.com</span>
                <span data-bb-bind="completed_at">2024-01-01T12:00:00Z</span>
              </div>
            </div>
            <!-- Empty state -->
            <div class="bb-analysis-empty" data-bb-show-if="slow_pages.length=0">
              No slow pages found in the selected time period.
            </div>
          </div>
        </div>

        <!-- External Redirects Analysis Section -->
        <div class="bb-analysis-section">
          <div class="bb-section-header">
            <h3>External Redirects</h3>
            <div class="bb-section-actions">
              <button class="bb-btn bb-btn-secondary" bb-action="refresh-redirects"><span>‚Üª</span> Refresh</button>
            </div>
          </div>
          <div class="bb-analysis-list">
            <!-- External Redirect Template -->
            <div class="bb-analysis-card" data-bb-template="external_redirect">
              <div class="bb-analysis-header">
                <div class="bb-analysis-url" data-bb-bind="url">https://example.com/redirect</div>
              </div>
              <div class="bb-redirect-url">
                ‚Üí <span data-bb-bind="redirect_url">https://external-site.com/target</span>
              </div>
              <div class="bb-analysis-details">
                <span class="bb-analysis-domain" data-bb-bind="domain">example.com</span>
                <span data-bb-bind="completed_at">2024-01-01T12:00:00Z</span>
              </div>
            </div>
            <!-- Empty state -->
            <div class="bb-analysis-empty" data-bb-show-if="external_redirects.length=0">
              No external redirects found in the selected time period.
            </div>
          </div>
        </div>
      </div>
    </main>

    <!-- Load shared authentication modal -->
    <div id="authModalContainer"></div>

    <!-- Job Details Modal -->
    <div id="jobDetailsModal" class="bb-modal">
      <div class="bb-modal-content">
        <div class="bb-modal-header">
          <h2 class="bb-modal-title">Job Details</h2>
          <button class="bb-modal-close" bb-action="close-modal">&times;</button>
        </div>

        <div class="bb-modal-section">
          <div class="bb-job-info-grid">
            <div class="bb-info-item">
              <div class="bb-info-label">Job ID</div>
              <div class="bb-info-value" id="modal-job-id" style="font-family: monospace; font-size: 12px">-</div>
            </div>
            <div class="bb-info-item">
              <div class="bb-info-label">Domain</div>
              <div class="bb-info-value" id="modal-domain">-</div>
            </div>
            <div class="bb-info-item">
              <div class="bb-info-label">Status</div>
              <div class="bb-info-value" id="modal-status">-</div>
            </div>
            <div class="bb-info-item">
              <div class="bb-info-label">Progress</div>
              <div class="bb-info-value" id="modal-progress">-</div>
            </div>
            <div class="bb-info-item">
              <div class="bb-info-label">Total Tasks</div>
              <div class="bb-info-value" id="modal-total-tasks">-</div>
            </div>
            <div class="bb-info-item">
              <div class="bb-info-label">Completed</div>
              <div class="bb-info-value" id="modal-completed-tasks">-</div>
            </div>
            <div class="bb-info-item">
              <div class="bb-info-label">Failed</div>
              <div class="bb-info-value" id="modal-failed-tasks">-</div>
            </div>
            <div class="bb-info-item">
              <div class="bb-info-label">Start Time</div>
              <div class="bb-info-value" id="modal-started-at">-</div>
            </div>
            <div class="bb-info-item">
              <div class="bb-info-label">End Time</div>
              <div class="bb-info-value" id="modal-completed-at">-</div>
            </div>
            <div class="bb-info-item">
              <div class="bb-info-label">Total Time</div>
              <div class="bb-info-value" id="modal-total-time">-</div>
            </div>
            <div class="bb-info-item">
              <div class="bb-info-label">Avg Time/Task</div>
              <div class="bb-info-value" id="modal-avg-time">-</div>
            </div>
          </div>
        </div>

        <div class="bb-modal-section">
          <div class="bb-modal-section-title">
            Task Details
            <div style="float: right; display: flex; gap: 8px; align-items: center">
              <select id="tasksLimit" style="font-size: 12px; padding: 4px">
                <option value="50">50</option>
                <option value="100">100</option>
                <option value="200">200</option>
                <option value="500">500</option>
                <option value="1000">1000</option>
              </select>
              <div class="bb-dropdown">
                <button class="bb-btn bb-btn-secondary" style="font-size: 12px" bb-action="toggle-export-menu">Export ‚ñº</button>
                <div class="bb-dropdown-menu" id="exportDropdownMenu">
                  <button class="bb-dropdown-item" bb-action="export-job">All Tasks</button>
                  <button class="bb-dropdown-item" bb-action="export-broken-links">Broken Links</button>
                  <button class="bb-dropdown-item" bb-action="export-slow-pages">Slow Pages</button>
                </div>
              </div>
              <button class="bb-btn bb-btn-secondary" style="font-size: 12px" bb-action="refresh-tasks">‚Üª Refresh</button>
            </div>
          </div>
          <div style="margin: 16px 0;">
            <div class="filter-tabs" id="modalTaskFilterTabs" style="justify-content: center;">
              <a href="#" class="filter-tab active" data-status="">All</a>
              <a href="#" class="filter-tab" data-status="completed">Complete</a>
              <a href="#" class="filter-tab" data-status="pending">In Progress</a>
              <a href="#" class="filter-tab" data-status="failed">Failed</a>
            </div>
          </div>
          <div id="tasksContent">
            <div class="bb-loading">Loading tasks...</div>
          </div>
          <div id="tasksPagination" style="text-align: center; margin-top: 16px; display: none">
            <button id="prevTasksBtn" class="bb-btn bb-btn-secondary" style="font-size: 12px; margin-right: 8px" bb-action="tasks-prev-page">
              ‚Üê Previous
            </button>
            <span id="tasksPageInfo" style="margin: 0 16px; font-size: 14px"></span>
            <button id="nextTasksBtn" class="bb-btn bb-btn-secondary" style="font-size: 12px; margin-left: 8px" bb-action="tasks-next-page">
              Next ‚Üí
            </button>
          </div>
        </div>

        <div class="bb-modal-section">
          <div style="display: flex; gap: 12px; justify-content: flex-end">
            <button class="bb-btn bb-btn-secondary" bb-action="close-modal">Close</button>
            <button class="bb-btn bb-btn-primary" bb-action="restart-job-modal" id="modal-restart-btn" style="display: none">Restart Job</button>
            <button class="bb-btn bb-btn-primary" bb-action="cancel-job-modal" id="modal-cancel-btn" style="display: none">Cancel Job</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Job Creation Modal -->
    <div id="createJobModal" class="bb-modal">
      <div class="bb-modal-content" style="max-width: 600px">
        <div class="bb-modal-header">
          <h2 class="bb-modal-title">Create New Job</h2>
          <button class="bb-modal-close" bb-action="close-create-job-modal">&times;</button>
        </div>

        <form id="createJobForm" class="bb-auth-form">
          <div class="bb-form-group">
            <label for="jobDomain">Domain</label>
            <input type="text" id="jobDomain" name="domain" required placeholder="example.com" class="bb-form-input" />
            <div class="bb-field-error" id="domainError" style="display: none"></div>
          </div>

          <div class="bb-form-group">
            <label for="maxPages">Maximum Pages</label>
            <input type="number" id="maxPages" name="max_pages" min="0" max="10000" value="0" class="bb-form-input" />
            <div style="font-size: 12px; color: #6b7280; margin-top: 4px">Maximum number of pages to crawl (set to 0 for unlimited)</div>
          </div>

          <!-- Hidden fields with sensible defaults -->
          <input type="hidden" id="useSitemap" name="use_sitemap" value="on" />
          <input type="hidden" id="findLinks" name="find_links" value="on" />
          <input type="hidden" id="concurrency" name="concurrency" value="5" />

          <div style="display: flex; gap: 12px; justify-content: flex-end; margin-top: 32px">
            <button type="button" class="bb-button bb-button-outline" bb-action="close-create-job-modal">Cancel</button>
            <button type="submit" class="bb-button bb-button-primary" id="createJobSubmitBtn">Create Job</button>
          </div>
        </form>

        <!-- Loading State -->
        <div id="createJobLoading" class="bb-auth-loading" style="display: none">
          <div class="bb-spinner"></div>
          <p>Creating job...</p>
        </div>

        <!-- Error Message -->
        <div id="createJobError" class="bb-auth-error" style="display: none"></div>
      </div>
    </div>

    <!-- Include the data binding library -->
    <script src="/js/bb-data-binder.min.js"></script>

    <script>
      // Supabase configuration
      const SUPABASE_URL = "https://auth.bluebandedbee.co";
      const SUPABASE_ANON_KEY =
        "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imdwemp0Ymd0ZGp4bmFjZGZ1anZ4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDUwNjYxNjMsImV4cCI6MjA2MDY0MjE2M30.eJjM2-3X8oXsFex_lQKvFkP1-_yLMHsueIn7_hCF6YI";

      // Wait for Supabase to be available, then create client
      let supabase;

      // Load the shared authentication modal
      async function loadAuthModal() {
        try {
          const response = await fetch('/auth-modal.html');
          const modalHTML = await response.text();
          document.getElementById('authModalContainer').innerHTML = modalHTML;
          
          // Set default to login form for dashboard
          setTimeout(() => {
            if (window.showLoginForm) {
              showLoginForm();
            }
          }, 10);
        } catch (error) {
          console.error('Failed to load auth modal:', error);
        }
      }

      function initializeSupabase() {
        if (window.supabase && window.supabase.createClient) {
          supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
          window.supabase = supabase; // Ensure it's globally available
          console.log("Supabase client created successfully");
          return true;
        }
        return false;
      }

      // Initialize data binder and dashboard
      let dataBinder;

      document.addEventListener("DOMContentLoaded", async () => {
        console.log("Enhanced dashboard initializing...");

        // Load the shared authentication modal
        await loadAuthModal();
        
        // Wait for auth modal DOM to be ready
        await new Promise(resolve => setTimeout(resolve, 50));

        // Ensure Supabase is ready
        if (!initializeSupabase()) {
          console.error("Supabase not available");
          return;
        }

        // Handle auth callback tokens
        const hasToken = await handleAuthCallback();

        // Create data binder with production config
        dataBinder = new BBDataBinder({
          apiBaseUrl: "",
          debug: true, // Enable debug for auth troubleshooting
          refreshInterval: 10, // Auto-refresh every 10 seconds
        });

        // Initialize data binder
        await dataBinder.init();

        // Check if user exists in backend on page load
        const { data: { session } } = await supabase.auth.getSession();
        if (session?.user) {
          await registerUserWithBackend(session.user);
        }

        // Update user info in header
        updateUserInfo();
        
        // Set initial auth state
        updateAuthState(!!session?.user);

        // Set up auth state change listener to update user info
        if (supabase) {
          supabase.auth.onAuthStateChange(async (event, session) => {
            console.log("Auth state changed:", event, session?.user?.email);
            
            // Register user with backend on sign in (handles OAuth returns)
            if ((event === 'SIGNED_IN' || event === 'USER_UPDATED') && session?.user) {
              await registerUserWithBackend(session.user);
            }
            
            // Update auth state in UI
            updateAuthState(!!session?.user);
            
            // Wait a moment for the data binder to update its auth manager
            setTimeout(updateUserInfo, 100);
            
            // Handle pending domain after successful auth
            if (session?.user) {
              await handlePendingDomain();
            }
          });
        }

        // Log auth state for debugging
        console.log("Auth state after init:", {
          hasAuth: !!dataBinder.authManager,
          isAuthenticated: dataBinder.authManager?.isAuthenticated,
          user: dataBinder.authManager?.user?.email,
        });
        
        // Update auth state after data binder init
        const currentSession = await supabase.auth.getSession();
        updateAuthState(!!currentSession.data.session?.user);

        // Override the refresh method to load dashboard data
        dataBinder.refresh = async function () {
          // Only load dashboard data if user is authenticated
          if (!this.authManager || !this.authManager.isAuthenticated) {
            console.log("User not authenticated, skipping dashboard data load");
            return;
          }
          
          try {
            console.log("Refreshing dashboard data...");

            // Show refresh indicator
            const statusIndicator = document.querySelector(".status-indicator");
            if (statusIndicator) {
              statusIndicator.innerHTML = '<span class="status-dot"></span><span>Refreshing...</span>';
            }

            // Load stats and jobs data
            let data;
            try {
              data = await this.loadAndBind({
                stats: "/v1/dashboard/stats?range=today",
              });
            } catch (error) {
              // Handle stats API errors gracefully
              console.log("Stats API error (likely no data yet):", error);
              data = {
                stats: {
                  total_jobs: 0,
                  running_jobs: 0,
                  completed_jobs: 0,
                  failed_jobs: 0,
                }
              };
            }

            // Load jobs separately for template binding
            let jobsResponse, jobs;
            try {
              jobsResponse = await this.fetchData("/v1/jobs?limit=10&range=today");
              jobs = jobsResponse.jobs || [];
            } catch (error) {
              console.log("Jobs API error (likely no jobs yet):", error);
              jobs = [];
            }

            // Process jobs data for better display
            const processedJobs = jobs.map((job) => ({
              ...job,
              domain: job.domains?.name || "Unknown Domain",
              progress: Math.round(job.progress || 0),
              started_at_formatted: job.started_at ? new Date(job.started_at).toLocaleString() : "-",
            }));

            // Load slow pages data
            let slowPagesResponse, slowPages;
            try {
              slowPagesResponse = await this.fetchData("/v1/dashboard/slow-pages?range=today");
              slowPages = slowPagesResponse.slow_pages || [];
            } catch (error) {
              console.log("Slow pages API error (likely no data yet):", error);
              slowPages = [];
            }

            // Process slow pages data for better display
            const processedSlowPages = slowPages.map((page) => ({
              ...page,
              completed_at: page.completed_at ? new Date(page.completed_at).toLocaleString() : "-",
            }));

            // Load external redirects data
            let redirectsResponse, externalRedirects;
            try {
              redirectsResponse = await this.fetchData("/v1/dashboard/external-redirects?range=today");
              externalRedirects = redirectsResponse.external_redirects || [];
            } catch (error) {
              console.log("Redirects API error (likely no data yet):", error);
              externalRedirects = [];
            }

            // Process external redirects data for better display
            const processedRedirects = externalRedirects.map((redirect) => ({
              ...redirect,
              completed_at: redirect.completed_at ? new Date(redirect.completed_at).toLocaleString() : "-",
            }));

            // Bind all templates
            this.bindTemplates({ 
              job: processedJobs,
              slow_page: processedSlowPages,
              external_redirect: processedRedirects
            });

            // Show simple empty state if no jobs
            if (processedJobs.length === 0) {
              const jobsList = document.querySelector(".bb-jobs-list");
              if (jobsList) {
                jobsList.innerHTML = `
                <div style="text-align: center; padding: 40px 20px; color: #6b7280;">
                  <div style="font-size: 48px; margin-bottom: 16px;">üêù</div>
                  <h3 style="margin: 0 0 8px 0; color: #374151;">No jobs yet</h3>
                  <p style="margin: 0; font-size: 14px;">Use the form above to start your first cache warming job</p>
                </div>
              `;
              }
            } else {
              // Update job action visibility and visual states
              setTimeout(() => {
                updateJobActionVisibility();
                updateJobVisualStates();
              }, 100); // Small delay to ensure DOM updates are complete
            }

            console.log("Dashboard data refreshed", { stats: data.stats, jobs: processedJobs.length });
          } catch (error) {
            console.error("Dashboard refresh failed:", error);

            // Only show error if it's not a 404 or empty data response
            if (error.status !== 404 && !error.message?.includes('No jobs found')) {
              showDashboardError("Unable to refresh dashboard data. Please check your connection and try again.");
            }

            // Set error state for stats only if there's a real error
            if (error.status !== 404) {
              this.updateElements({
                stats: {
                  total_jobs: "‚Äì",
                  running_jobs: "‚Äì",
                  completed_jobs: "‚Äì",
                  failed_jobs: "‚Äì",
                },
              });
            } else {
              // For 404/no data, show zero stats instead of error state
              this.updateElements({
                stats: {
                  total_jobs: "0",
                  running_jobs: "0",
                  completed_jobs: "0",
                  failed_jobs: "0",
                },
              });
            }
          } finally {
            // Reset status indicator
            const statusIndicator = document.querySelector(".status-indicator");
            if (statusIndicator) {
              statusIndicator.innerHTML = '<span class="status-dot"></span><span>Live</span>';
            }
          }
        };

        // Set up attribute-based event handling
        setupAttributeHandlers();
        
        // Close dropdown when clicking outside
        document.addEventListener("click", (e) => {
          const dropdown = document.getElementById("exportDropdownMenu");
          const exportButton = e.target.closest('[bb-action="toggle-export-menu"]');
          const dropdownItem = e.target.closest('.bb-dropdown-item');
          
          if (!exportButton && !dropdownItem && dropdown && dropdown.classList.contains("show")) {
            closeExportDropdown();
          }
        });

        // Set up filters
        setupFilters();

        // Set up modal functionality
        setupModal();

        // Check for pending domain from domain-first flow
        await handlePendingDomain();
        
        // Initial load (only if authenticated)
        await dataBinder.refresh();

        // Setup authentication event handlers
        setupAuthHandlers();
        
        // Setup login page handlers
        setupLoginPageHandlers();
        
        // Setup dashboard form handler
        setupDashboardFormHandler();

        // Set up network status monitoring
        setupNetworkMonitoring();

        console.log("Enhanced dashboard initialized");
      });
      
      // Setup dashboard form handler
      function setupDashboardFormHandler() {
        const dashboardForm = document.getElementById('dashboardJobForm');
        if (dashboardForm) {
          dashboardForm.addEventListener('submit', handleDashboardJobCreation);
        }
      }
      
      // Handle dashboard job creation form
      async function handleDashboardJobCreation(event) {
        event.preventDefault();
        const formData = new FormData(event.target);
        
        const domain = formData.get('domain');
        const maxPages = parseInt(formData.get('max_pages'));
        
        // Basic validation
        if (!domain) {
          showDashboardError('Domain is required');
          return;
        }
        
        if (maxPages < 0 || maxPages > 10000) {
          showDashboardError('Maximum pages must be between 0 and 10000');
          return;
        }
        
        try {
          console.log('Creating job from dashboard form:', { domain, maxPages });
          
          const response = await dataBinder.fetchData('/v1/jobs', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              domain: domain,
              max_pages: maxPages,
              concurrency: 5,
              use_sitemap: true,
              find_links: true
            })
          });
          
          console.log('Dashboard job created successfully:', response);
          
          // Clear the form
          document.getElementById('dashboardDomain').value = '';
          document.getElementById('dashboardMaxPages').value = '0';
          
          // Refresh dashboard to show new job
          await dataBinder.refresh();
          
          // Show success message
          showSuccessMessage(`Job created successfully for ${domain}`);
          
        } catch (error) {
          console.error('Failed to create dashboard job:', error);
          showDashboardError(error.message || 'Failed to create job. Please try again.');
        }
      }
      
      // Handle pending domain after authentication
      async function handlePendingDomain() {
        const pendingDomain = sessionStorage.getItem('bb_pending_domain');
        if (pendingDomain && dataBinder.authManager?.isAuthenticated) {
          console.log('Found pending domain after auth:', pendingDomain);
          
          // Clear the stored domain
          sessionStorage.removeItem('bb_pending_domain');
          
          // Auto-create job
          try {
            const response = await dataBinder.fetchData('/v1/jobs', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                domain: pendingDomain,
                use_sitemap: true,
                find_links: true,
                max_pages: 0,
                concurrency: 5
              })
            });
            
            showSuccessMessage(`Started crawling ${pendingDomain}! Your cache warming has begun.`);
            
            // Refresh dashboard to show new job
            await dataBinder.refresh();
          } catch (error) {
            console.error('Failed to create job from pending domain:', error);
            showDashboardError(`Failed to start crawling ${pendingDomain}. Please try creating the job manually.`);
          }
        }
      }
      
      // Setup login page event handlers
      function setupLoginPageHandlers() {
        // Login page buttons
        const showLoginBtn = document.getElementById('showLoginBtn');
        const showSignupBtn = document.getElementById('showSignupBtn');
        
        if (showLoginBtn) {
          showLoginBtn.addEventListener('click', () => {
            showAuthModal();
            showAuthForm('login');
          });
        }
        
        if (showSignupBtn) {
          showSignupBtn.addEventListener('click', () => {
            showAuthModal();
            showAuthForm('signup');
          });
        }
      }

      function setupNetworkMonitoring() {
        // Check initial network status
        updateNetworkStatus();

        // Listen for network status changes
        window.addEventListener("online", () => {
          updateNetworkStatus();
          showInfoMessage("Connection restored. Refreshing data...", 2000);
          setTimeout(() => dataBinder.refresh(), 500);
        });

        window.addEventListener("offline", () => {
          updateNetworkStatus();
          showDashboardError("Connection lost. Some features may not work.", "error", 0);
        });
      }

      function updateNetworkStatus() {
        const statusIndicator = document.querySelector(".status-indicator");
        if (statusIndicator && !navigator.onLine) {
          statusIndicator.innerHTML = '<span style="background: #ef4444;" class="status-dot"></span><span>Offline</span>';
        } else if (statusIndicator && navigator.onLine) {
          statusIndicator.innerHTML = '<span class="status-dot"></span><span>Live</span>';
        }
      }

      async function updateUserInfo() {
        const userEmailElement = document.getElementById("userEmail");
        const userAvatarElement = document.getElementById("userAvatar");

        if (!userEmailElement || !userAvatarElement) return;

        try {
          // Get current user from Supabase directly
          const {
            data: { session },
          } = await supabase.auth.getSession();

          if (session && session.user && session.user.email) {
            const email = session.user.email;

            // Update email display
            userEmailElement.textContent = email;

            // Update avatar with user initials
            const initials = getInitials(email);
            userAvatarElement.textContent = initials;

            console.log("User info updated:", email);
          } else {
            // No session, reset to defaults
            userEmailElement.textContent = "Loading...";
            userAvatarElement.textContent = "?";
          }
        } catch (error) {
          console.error("Failed to update user info:", error);
          userEmailElement.textContent = "Error";
          userAvatarElement.textContent = "?";
        }
      }
      
      // Update UI elements based on authentication state
      function updateAuthState(isAuthenticated) {
        console.log('Updating auth state:', isAuthenticated);
        
        // Show/hide elements based on authentication
        const guestElements = document.querySelectorAll('[data-bb-auth="guest"]');
        const requiredElements = document.querySelectorAll('[data-bb-auth="required"]');
        
        guestElements.forEach(el => {
          el.style.display = isAuthenticated ? 'none' : el.dataset.originalDisplay || 'block';
        });
        
        requiredElements.forEach(el => {
          if (!isAuthenticated) {
            el.dataset.originalDisplay = el.style.display || 'block';
          }
          el.style.display = isAuthenticated ? (el.dataset.originalDisplay || 'block') : 'none';
        });
        
        // If user just authenticated, load dashboard data
        if (isAuthenticated && dataBinder) {
          setTimeout(() => dataBinder.refresh(), 100);
        }
      }

      function getInitials(email) {
        if (!email) return "?";

        // Try to get name parts from email or use email prefix
        const emailPrefix = email.split("@")[0];

        // Check if email has recognizable name patterns (firstname.lastname, etc.)
        if (emailPrefix.includes(".")) {
          const parts = emailPrefix.split(".");
          return parts
            .map((part) => part.charAt(0).toUpperCase())
            .slice(0, 2)
            .join("");
        } else if (emailPrefix.includes("_")) {
          const parts = emailPrefix.split("_");
          return parts
            .map((part) => part.charAt(0).toUpperCase())
            .slice(0, 2)
            .join("");
        } else {
          // Just use first two characters of email prefix
          return emailPrefix.slice(0, 2).toUpperCase();
        }
      }

      function setupAttributeHandlers() {
        // Set up attribute-based event handling using event delegation
        document.addEventListener("click", (e) => {
          const action = e.target.getAttribute("bb-action");
          if (action) {
            e.preventDefault();
            handleBBAction(action, e.target);
          }
        });
      }

      function handleBBAction(action, element) {
        switch (action) {
          case "refresh-dashboard":
            refreshDashboard();
            break;
          case "refresh-slow-pages":
            refreshSlowPages();
            break;
          case "refresh-redirects":
            refreshExternalRedirects();
            break;
          case "create-job":
            createJob();
            break;
          case "view-job-details":
            const jobId = element.getAttribute("bb-data-job-id");
            viewJobDetails(jobId);
            break;
          case "restart-job":
          case "restart-job-modal":
            const restartJobId = element.getAttribute("bb-data-job-id") || currentJobId;
            restartJob(restartJobId);
            break;
          case "cancel-job":
          case "cancel-job-modal":
            const cancelJobId = element.getAttribute("bb-data-job-id") || currentJobId;
            cancelJob(cancelJobId);
            break;
          case "close-modal":
            closeModal();
            break;
          case "close-auth-modal":
            closeAuthModal();
            break;
          case "close-create-job-modal":
            closeCreateJobModal();
            break;
          case "show-login":
            showAuthForm("login");
            break;
          case "show-signup":
            showAuthForm("signup");
            break;
          case "forgot-password":
            showAuthForm("reset");
            break;
          case "refresh-tasks":
            if (currentJobId) {
              loadJobTasks(currentJobId);
            }
            break;
          case "tasks-prev-page":
            if (currentJobId && tasksCurrentPage > 0) {
              tasksCurrentPage--;
              loadJobTasks(currentJobId);
            }
            break;
          case "tasks-next-page":
            if (currentJobId && tasksHasNext) {
              tasksCurrentPage++;
              loadJobTasks(currentJobId);
            }
            break;
          case "toggle-export-menu":
            toggleExportDropdown();
            break;
          case "export-job":
            if (currentJobId) {
              exportJobToCSV(currentJobId);
              closeExportDropdown();
            }
            break;
          case "export-broken-links":
            if (currentJobId) {
              exportBrokenLinks(currentJobId);
              closeExportDropdown();
            }
            break;
          case "export-slow-pages":
            if (currentJobId) {
              exportSlowPages(currentJobId);
              closeExportDropdown();
            }
            break;
          default:
            console.warn("Unknown bb-action:", action);
        }
      }


      async function exportJobToCSV(jobId) {
        if (!jobId) {
          console.error("No job ID provided for export");
          return;
        }

        try {
          // Show loading state on export button
          const exportButton = document.querySelector('[bb-action="export-job"]');
          if (exportButton) {
            exportButton.disabled = true;
            exportButton.textContent = "Exporting...";
          }

          // Fetch job details
          const job = await dataBinder.fetchData(`/v1/jobs/${jobId}`);
          
          // Get current status filter
          const activeTab = document.querySelector("#modalTaskFilterTabs .filter-tab.active");
          const statusFilter = activeTab ? activeTab.dataset.status : "";
          
          // Fetch all tasks for this job with status filter
          let allTasks = [];
          let tasksOffset = 0;
          const tasksLimit = 500;
          let tasksHasMore = true;

          while(tasksHasMore) {
            let url = `/v1/jobs/${jobId}/tasks?limit=${tasksLimit}&offset=${tasksOffset}`;
            if (statusFilter) {
              url += `&status=${statusFilter}`;
            }
            const tasksResponse = await dataBinder.fetchData(url);
            const newTasks = tasksResponse.tasks || [];
            allTasks = allTasks.concat(newTasks);
            tasksOffset += tasksLimit;
            tasksHasMore = newTasks.length === tasksLimit;
          }

          if (allTasks.length === 0) {
            showInfoMessage("No tasks found for this job.", 3000);
            return;
          }

          // Add job info to each task
          allTasks.forEach(task => {
            task.job_id = jobId;
            task.domain = job.domain || job.domains?.name || "Unknown";
          });

          // Convert to CSV and download
          const csv = convertToCSV(allTasks);
          const date = new Date().toISOString().slice(0, 10);
          const domain = (job.domain || job.domains?.name || "unknown").replace(/[^a-z0-9]/gi, '_');
          downloadCSV(csv, `crawl_${domain}_${date}.csv`);

          showInfoMessage(`Exported ${allTasks.length} tasks successfully.`, 3000);

        } catch (error) {
          console.error("Export failed:", error);
          showDashboardError("Failed to export job data. Please try again.");
        } finally {
          // Reset export button
          const exportButton = document.querySelector('[bb-action="export-job"]');
          if (exportButton) {
            exportButton.disabled = false;
            exportButton.textContent = "Export";
          }
        }
      }

      async function exportBrokenLinks(jobId) {
        if (!jobId) {
          console.error("No job ID provided for export");
          return;
        }

        try {
          // Show loading state
          showInfoMessage("Exporting broken links...", 2000);

          // Fetch job details
          const job = await dataBinder.fetchData(`/v1/jobs/${jobId}`);
          
          // Fetch all tasks for this job (no status filter, we'll filter by status code)
          let allTasks = [];
          let tasksOffset = 0;
          const tasksLimit = 500;
          let tasksHasMore = true;

          while(tasksHasMore) {
            const url = `/v1/jobs/${jobId}/tasks?limit=${tasksLimit}&offset=${tasksOffset}`;
            const tasksResponse = await dataBinder.fetchData(url);
            const newTasks = tasksResponse.tasks || [];
            allTasks = allTasks.concat(newTasks);
            tasksOffset += tasksLimit;
            tasksHasMore = newTasks.length === tasksLimit;
          }

          // Filter for broken links (non-2xx status codes)
          const brokenLinks = allTasks.filter(task => task.status && task.status === "failed");
          

          if (brokenLinks.length === 0) {
            showInfoMessage("No broken links found in this job.", 3000);
            return;
          }

          // Convert to CSV with broken links specific format using actual columns
          const headers = ["path", "status_code", "error", "source_url", "created_at"];
          const rows = brokenLinks.map(task => {
            return [
              `"${task.path || ''}"`,
              task.status_code || '',
              `"${(task.error || '').replace(/"/g, '""')}"`,
              `"${task.source_url || ''}"`,
              `"${task.created_at || ''}"`
            ].join(',');
          });
          
          const csv = [headers.join(',')].concat(rows).join('\r\n');
          const date = new Date().toISOString().slice(0, 10);
          const domain = (job.domain || job.domains?.name || "unknown").replace(/[^a-z0-9]/gi, '_');
          downloadCSV(csv, `crawl_${domain}_broken_links_${date}.csv`);

          showInfoMessage(`Exported ${brokenLinks.length} broken links successfully.`, 3000);

        } catch (error) {
          console.error("Export failed:", error);
          showDashboardError("Failed to export broken links. Please try again.");
        }
      }

      async function exportSlowPages(jobId) {
        if (!jobId) {
          console.error("No job ID provided for export");
          return;
        }

        try {
          // Show loading state
          showInfoMessage("Exporting slow pages...", 2000);

          // Fetch job details
          const job = await dataBinder.fetchData(`/v1/jobs/${jobId}`);
          
          // Fetch all tasks for this job
          let allTasks = [];
          let tasksOffset = 0;
          const tasksLimit = 500;
          let tasksHasMore = true;

          while(tasksHasMore) {
            const url = `/v1/jobs/${jobId}/tasks?limit=${tasksLimit}&offset=${tasksOffset}`;
            const tasksResponse = await dataBinder.fetchData(url);
            const newTasks = tasksResponse.tasks || [];
            allTasks = allTasks.concat(newTasks);
            tasksOffset += tasksLimit;
            tasksHasMore = newTasks.length === tasksLimit;
          }

          // Filter for slow pages (response time > 2000ms)
          const slowPages = allTasks.filter(task => 
            task.response_time && task.response_time > 2000
          );

          if (slowPages.length === 0) {
            showInfoMessage("No slow pages found in this job.", 3000);
            return;
          }

          // Convert to CSV with slow pages specific format using actual columns
          const headers = ["path", "response_time_ms", "status_code", "cache_status", "created_at"];
          const rows = slowPages.map(task => {
            return [
              `"${task.path || ''}"`,
              task.response_time || '',
              task.status_code || '',
              `"${task.cache_status || ''}"`,
              `"${task.created_at || ''}"`
            ].join(',');
          });
          
          const csv = [headers.join(',')].concat(rows).join('\r\n');
          const date = new Date().toISOString().slice(0, 10);
          const domain = (job.domain || job.domains?.name || "unknown").replace(/[^a-z0-9]/gi, '_');
          downloadCSV(csv, `crawl_${domain}_slow_pages_${date}.csv`);

          showInfoMessage(`Exported ${slowPages.length} slow pages successfully.`, 3000);

        } catch (error) {
          console.error("Export failed:", error);
          showDashboardError("Failed to export slow pages. Please try again.");
        }
      }


      function convertToCSV(data) {
          const headers = [
              "job_id", "domain", "path", "status", "status_code", 
              "response_time", "cache_status", "error", "created_at"
          ];
          const rows = data.map(row => {
              return headers.map(header => {
                  let value = row[header];
                  if (value === null || value === undefined) {
                      value = "";
                  } else if (typeof value === 'string') {
                      // Escape quotes by doubling them
                      value = `"${value.replace(/"/g, '""')}"`;
                  }
                  return value;
              }).join(',');
          });
          return [headers.join(',')].concat(rows).join('\r\n');
      }

      function downloadCSV(csvContent, filename) {
          const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
          const link = document.createElement("a");
          if (link.download !== undefined) {
              const url = URL.createObjectURL(blob);
              link.setAttribute("href", url);
              link.setAttribute("download", filename || `export_${new Date().toISOString().slice(0, 10)}.csv`);
              link.style.visibility = 'hidden';
              document.body.appendChild(link);
              link.click();
              document.body.removeChild(link);
          }
      }

      function setupFilters() {
        const dateRange = document.getElementById("dateRange");
        const statusFilterTabs = document.getElementById("statusFilterTabs");
        const refreshInterval = document.getElementById("refreshInterval");

        if (dateRange) {
          dateRange.addEventListener("change", () => {
            updateJobsData(); // Reload with new filters
          });
        }

        // Modal task filter tabs
        const modalTaskFilterTabs = document.getElementById("modalTaskFilterTabs");
        if (modalTaskFilterTabs) {
            modalTaskFilterTabs.addEventListener("click", (e) => {
                if (e.target.classList.contains("filter-tab")) {
                    e.preventDefault();
                    // Check if the clicked tab is already active
                    if(e.target.classList.contains("active")) {
                        return;
                    }
                    
                    const currentActive = modalTaskFilterTabs.querySelector(".active");
                    if(currentActive) {
                        currentActive.classList.remove("active");
                    }
                    e.target.classList.add("active");
                    
                    // Reset pagination and reload tasks
                    tasksCurrentPage = 0;
                    if (currentJobId) {
                        loadJobTasks(currentJobId);
                    }
                }
            });
        }

        if (refreshInterval) {
          refreshInterval.addEventListener("change", () => {
            const interval = parseInt(refreshInterval.value);

            // Stop current auto-refresh
            dataBinder.stopAutoRefresh();

            // Start new auto-refresh if interval > 0
            if (interval > 0) {
              dataBinder.refreshInterval = interval;
              dataBinder.startAutoRefresh();
            }
          });
        }

      }

      // Global variables
      let currentJobId = null;
      let tasksCurrentPage = 0;
      let tasksHasNext = false;
      let tasksSortColumn = "created_at";
      let tasksSortDirection = "desc";

      function refreshDashboard() {
        // Add loading state to refresh buttons
        document.querySelectorAll('[bb-action="refresh-dashboard"]').forEach((btn) => {
          const originalText = btn.innerHTML;
          btn.innerHTML = "<span>‚ü≥</span> Refreshing...";
          btn.disabled = true;

          // Reset button after refresh completes
          setTimeout(() => {
            btn.innerHTML = originalText;
            btn.disabled = false;
          }, 2000);
        });

        dataBinder.refresh();
      }

      function refreshSlowPages() {
        // Add loading state to refresh buttons
        document.querySelectorAll('[bb-action="refresh-slow-pages"]').forEach((btn) => {
          const originalText = btn.innerHTML;
          btn.innerHTML = "<span>‚ü≥</span> Refreshing...";
          btn.disabled = true;

          // Reset button after refresh completes
          setTimeout(() => {
            btn.innerHTML = originalText;
            btn.disabled = false;
          }, 2000);
        });

        // Refresh slow pages data
        dataBinder.refresh();
      }

      function refreshExternalRedirects() {
        // Add loading state to refresh buttons
        document.querySelectorAll('[bb-action="refresh-redirects"]').forEach((btn) => {
          const originalText = btn.innerHTML;
          btn.innerHTML = "<span>‚ü≥</span> Refreshing...";
          btn.disabled = true;

          // Reset button after refresh completes
          setTimeout(() => {
            btn.innerHTML = originalText;
            btn.disabled = false;
          }, 2000);
        });

        // Refresh external redirects data
        dataBinder.refresh();
      }

      function updateJobsData() {
        const dateRange = document.getElementById("dateRange").value;

        // Build query parameters (no status filter on dashboard anymore)
        let params = `limit=10&range=${dateRange}`;

        // Load jobs with filters
        dataBinder
          .fetchData(`/v1/jobs?${params}`)
          .then((response) => {
            const jobs = response.jobs || [];
            const processedJobs = jobs.map((job) => ({
              ...job,
              domain: job.domains?.name || "Unknown Domain",
              progress: Math.round(job.progress || 0),
              started_at_formatted: job.started_at ? new Date(job.started_at).toLocaleString() : "-",
            }));

            dataBinder.bindTemplates({ job: processedJobs });

            // Update visibility of action buttons and visual states
            setTimeout(() => {
              updateJobActionVisibility();
              updateJobVisualStates();
            }, 100);
          })
          .catch((error) => {
            console.error("Failed to load jobs:", error);
          });
      }

      function updateJobActionVisibility() {
        // Show/hide action buttons based on job status
        document.querySelectorAll("[data-bb-show-if]").forEach((element) => {
          const showIf = element.getAttribute("data-bb-show-if");
          const jobCard = element.closest('[data-bb-template="job"]');

          if (jobCard && showIf) {
            const statusElement = jobCard.querySelector('[data-bb-bind="status"]');
            const currentStatus = statusElement ? statusElement.textContent.toLowerCase() : "";

            if (showIf.includes("status=")) {
              const allowedStatuses = showIf.split("status=")[1].split(",");
              element.style.display = allowedStatuses.includes(currentStatus) ? "inline-block" : "none";
            }
          }
        });
      }

      function updateJobVisualStates() {
        // Add visual indicators for running jobs
        document.querySelectorAll('[data-bb-template="job"]').forEach((jobCard) => {
          const statusElement = jobCard.querySelector('[data-bb-bind="status"]');
          const progressBar = jobCard.querySelector(".bb-progress-fill");
          const currentStatus = statusElement ? statusElement.textContent.toLowerCase() : "";

          // Remove existing animation classes
          jobCard.classList.remove("job-running", "job-completed", "job-failed", "job-cancelled");
          if (progressBar) {
            progressBar.classList.remove("progress-pulsing");
          }

          // Add status-specific visual effects
          if (currentStatus === "running") {
            jobCard.classList.add("job-running");
            if (progressBar) {
              progressBar.classList.add("progress-pulsing");
            }
          } else if (currentStatus === "completed") {
            jobCard.classList.add("job-completed");
          } else if (currentStatus === "failed") {
            jobCard.classList.add("job-failed");
          } else if (currentStatus === "cancelled") {
            jobCard.classList.add("job-cancelled");
          }
        });
      }

      function createJob() {
        showCreateJobModal();
      }

      async function viewJobDetails(jobId) {
        if (!jobId) {
          console.error("No job ID provided");
          return;
        }

        currentJobId = jobId;

        // Reset pagination state
        tasksCurrentPage = 0;
        tasksSortColumn = "created_at";
        tasksSortDirection = "desc";
        
        // Reset filter tabs to "All"
        const modalTabs = document.querySelectorAll("#modalTaskFilterTabs .filter-tab");
        modalTabs.forEach((tab) => {
          tab.classList.remove("active");
          if (tab.dataset.status === "") {
            tab.classList.add("active");
          }
        });

        try {
          // Load job details
          const job = await dataBinder.fetchData(`/v1/jobs/${jobId}`);

          // Update modal content
          document.getElementById("modal-job-id").textContent = jobId;
          document.getElementById("modal-domain").textContent = job.domain || "-";
          document.getElementById("modal-status").textContent = job.status || "-";
          document.getElementById("modal-progress").textContent = `${Math.round(job.progress || 0)}%`;
          document.getElementById("modal-total-tasks").textContent = job.total_tasks || 0;
          document.getElementById("modal-completed-tasks").textContent = job.completed_tasks || 0;
          document.getElementById("modal-failed-tasks").textContent = job.failed_tasks || 0;

          // Format time fields
          const startedAt = job.started_at ? new Date(job.started_at) : null;
          const completedAt = job.completed_at ? new Date(job.completed_at) : null;

          document.getElementById("modal-started-at").textContent = startedAt ? startedAt.toLocaleString() : "-";
          document.getElementById("modal-completed-at").textContent = completedAt ? completedAt.toLocaleString() : "-";

          // Calculate total time
          let totalTimeText = "-";
          let avgTimeText = "-";

          if (startedAt && completedAt) {
            const totalMs = completedAt - startedAt;
            const totalMinutes = Math.round(totalMs / 60000);
            const hours = Math.floor(totalMinutes / 60);
            const minutes = totalMinutes % 60;

            if (hours > 0) {
              totalTimeText = `${hours}h ${minutes}m`;
            } else {
              totalTimeText = `${minutes}m`;
            }

            // Calculate average time per completed task
            const completedTasks = job.completed_tasks || 0;
            if (completedTasks > 0) {
              const avgMs = totalMs / completedTasks;
              const avgSeconds = Math.round(avgMs / 1000);
              if (avgSeconds < 60) {
                avgTimeText = `${avgSeconds}s`;
              } else {
                const avgMin = Math.floor(avgSeconds / 60);
                const avgSec = avgSeconds % 60;
                avgTimeText = `${avgMin}m ${avgSec}s`;
              }
            }
          }

          document.getElementById("modal-total-time").textContent = totalTimeText;
          document.getElementById("modal-avg-time").textContent = avgTimeText;

          // Show/hide action buttons
          const restartBtn = document.getElementById("modal-restart-btn");
          const cancelBtn = document.getElementById("modal-cancel-btn");

          if (["completed", "failed", "cancelled"].includes(job.status)) {
            restartBtn.style.display = "inline-block";
            cancelBtn.style.display = "none";
          } else if (["running", "pending"].includes(job.status)) {
            restartBtn.style.display = "none";
            cancelBtn.style.display = "inline-block";
          } else {
            restartBtn.style.display = "none";
            cancelBtn.style.display = "none";
          }

          // Load tasks
          await loadJobTasks(jobId);

          // Show modal
          showModal();
        } catch (error) {
          console.error("Failed to load job details:", error);
          showDashboardError("Failed to load job details. Please check your connection and try again.");
        }
      }

      async function loadJobTasks(jobId) {
        const tasksContent = document.getElementById("tasksContent");
        const pagination = document.getElementById("tasksPagination");
        const limitSelect = document.getElementById("tasksLimit");

        tasksContent.innerHTML = '<div class="bb-loading">Loading tasks...</div>';
        pagination.style.display = "none";

        try {
          const limit = limitSelect ? limitSelect.value : 50;
          const offset = tasksCurrentPage * limit;
          const sort = tasksSortDirection === "desc" ? "-" + tasksSortColumn : tasksSortColumn;
          
          // Get current status filter
          const activeTab = document.querySelector("#modalTaskFilterTabs .filter-tab.active");
          const statusFilter = activeTab ? activeTab.dataset.status : "";
          
          // Build URL with status filter
          let url = `/v1/jobs/${jobId}/tasks?limit=${limit}&offset=${offset}&sort=${sort}`;
          if (statusFilter) {
            url += `&status=${statusFilter}`;
          }

          const response = await dataBinder.fetchData(url);
          const tasks = response.tasks || [];

          if (tasks.length === 0 && tasksCurrentPage === 0) {
            tasksContent.innerHTML = '<div class="bb-loading">No tasks found</div>';
            return;
          }

          // Build sortable table header
          const getSortIcon = (column) => {
            if (tasksSortColumn === column) {
              return tasksSortDirection === "desc" ? " ‚Üì" : " ‚Üë";
            }
            return "";
          };

          // Build tasks table with sortable headers
          let tableHTML = `
          <table class="bb-tasks-table">
            <thead>
              <tr>
                <th style="cursor: pointer;" onclick="sortTasks('path')">Path${getSortIcon("path")}</th>
                <th style="cursor: pointer;" onclick="sortTasks('status')">Status${getSortIcon("status")}</th>
                <th style="cursor: pointer;" onclick="sortTasks('response_time')">Response Time${getSortIcon("response_time")}</th>
                <th style="cursor: pointer;" onclick="sortTasks('cache_status')">Cache Status${getSortIcon("cache_status")}</th>
                <th style="cursor: pointer;" onclick="sortTasks('second_response_time')">2nd Request${getSortIcon("second_response_time")}</th>
                <th style="cursor: pointer;" onclick="sortTasks('status_code')">Status Code${getSortIcon("status_code")}</th>
              </tr>
            </thead>
            <tbody>
        `;

          tasks.forEach((task) => {
            const statusClass = `bb-status-${task.status}`;

            // Format second request data (just response time, no cache status)
            const secondRequest = task.second_response_time ? `${task.second_response_time}ms` : "-";

            tableHTML += `
              <tr>
                <td><a href="${task.url}" target="_blank"><code class="bb-task-path">${task.path}</code></a></td>
                <td><span class="bb-task-status ${statusClass}" ${task.error ? `title="${task.error.substring(0, 50)}${task.error.length > 50 ? "..." : ""}"` : ""}>${task.status}</span></td>
                <td>${task.response_time ? `${task.response_time}ms` : "-"}</td>
                <td ${task.error ? `title="${task.error.substring(0, 50)}${task.error.length > 50 ? "..." : ""}"` : ""}>${task.cache_status || "-"}</td>
                <td>${secondRequest}</td>
                <td>${task.status_code || "-"}</td>
              </tr>
              `;
          });

          tableHTML += "</tbody></table>";
          tasksContent.innerHTML = tableHTML;

          // Update pagination
          if (response.pagination) {
            const { total, has_next, has_prev } = response.pagination;
            tasksHasNext = has_next;

            const startItem = offset + 1;
            const endItem = Math.min(offset + parseInt(limit), total);

            document.getElementById("tasksPageInfo").textContent = `${startItem}-${endItem} of ${total} tasks`;

            document.getElementById("prevTasksBtn").disabled = !has_prev;
            document.getElementById("nextTasksBtn").disabled = !has_next;

            pagination.style.display = total > limit ? "block" : "none";
          }
        } catch (error) {
          console.error("Failed to load tasks:", error);
          tasksContent.innerHTML = '<div class="bb-error">Failed to load tasks</div>';
        }
      }

      // Add sorting function
      function sortTasks(column) {
        if (tasksSortColumn === column) {
          tasksSortDirection = tasksSortDirection === "desc" ? "asc" : "desc";
        } else {
          tasksSortColumn = column;
          tasksSortDirection = "desc";
        }
        tasksCurrentPage = 0; // Reset to first page when sorting
        if (currentJobId) {
          loadJobTasks(currentJobId);
        }
      }

      async function restartJob(jobId) {
        if (!jobId) return;

        if (!confirm("Are you sure you want to restart this job?")) {
          return;
        }

        try {
          const response = await dataBinder.fetchData(`/v1/jobs/${jobId}`, {
            method: "PUT",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ action: "restart" }),
          });

          console.log("Job restart initiated:", response);

          // Show success message with better UX
          const jobDetails = response.data || response;
          showSuccessMessage(`Job restart initiated successfully for ${jobDetails.domain || "domain"}`);

          // Refresh dashboard and modal if open
          await dataBinder.refresh();
          if (currentJobId === jobId) {
            await viewJobDetails(jobId);
          }
        } catch (error) {
          console.error("Failed to restart job:", error);
          const errorMessage = error.message || "Failed to restart job. Please try again.";
          showDashboardError(`Restart failed: ${errorMessage}`);
        }
      }

      async function cancelJob(jobId) {
        if (!jobId) return;

        if (!confirm("Are you sure you want to cancel this job?")) {
          return;
        }

        try {
          const response = await dataBinder.fetchData(`/v1/jobs/${jobId}`, {
            method: "PUT",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ action: "cancel" }),
          });

          console.log("Job cancelled:", response);

          // Show success message with better UX
          const jobDetails = response.data || response;
          showSuccessMessage(`Job cancelled successfully for ${jobDetails.domain || "domain"}`);

          // Refresh dashboard and close modal if open
          await dataBinder.refresh();
          if (currentJobId === jobId) {
            closeModal();
          }
        } catch (error) {
          console.error("Failed to cancel job:", error);
          const errorMessage = error.message || "Failed to cancel job. Please try again.";
          showDashboardError(`Cancel failed: ${errorMessage}`);
        }
      }

      function setupModal() {
        // Close modal when clicking outside
        document.getElementById("jobDetailsModal").addEventListener("click", (e) => {
          if (e.target.id === "jobDetailsModal") {
            closeModal();
          }
        });
      }

      function showModal() {
        document.getElementById("jobDetailsModal").classList.add("show");
      }

      function closeModal() {
        document.getElementById("jobDetailsModal").classList.remove("show");
        currentJobId = null;
        closeExportDropdown(); // Close dropdown when modal closes
      }

      function toggleExportDropdown() {
        const dropdown = document.getElementById("exportDropdownMenu");
        if (dropdown) {
          dropdown.classList.toggle("show");
        }
      }

      function closeExportDropdown() {
        const dropdown = document.getElementById("exportDropdownMenu");
        if (dropdown) {
          dropdown.classList.remove("show");
        }
      }

      function showCreateJobModal() {
        document.getElementById("createJobModal").classList.add("show");
        // Reset form
        document.getElementById("createJobForm").reset();
        clearCreateJobError();
        hideCreateJobLoading();

        // Defaults are already set in HTML
      }

      function closeCreateJobModal() {
        document.getElementById("createJobModal").classList.remove("show");
        clearCreateJobError();
        hideCreateJobLoading();
      }

      function showCreateJobLoading() {
        document.getElementById("createJobLoading").style.display = "block";
        document.getElementById("createJobForm").style.display = "none";
      }

      function hideCreateJobLoading() {
        document.getElementById("createJobLoading").style.display = "none";
        document.getElementById("createJobForm").style.display = "block";
      }

      function showCreateJobError(message) {
        const errorDiv = document.getElementById("createJobError");
        errorDiv.textContent = message;
        errorDiv.style.display = "block";
      }

      function clearCreateJobError() {
        document.getElementById("createJobError").style.display = "none";
      }

      // Global error notification system
      function showDashboardError(message, type = "error", duration = 5000) {
        // Remove existing notifications
        const existingNotification = document.querySelector(".bb-notification");
        if (existingNotification) {
          existingNotification.remove();
        }

        // Create notification element
        const notification = document.createElement("div");
        notification.className = `bb-notification bb-notification-${type}`;
        notification.innerHTML = `
        <div class="bb-notification-content">
          <span class="bb-notification-icon">${type === "error" ? "‚ö†Ô∏è" : type === "success" ? "‚úÖ" : "‚ÑπÔ∏è"}</span>
          <span class="bb-notification-message">${message}</span>
          <button class="bb-notification-close" onclick="this.parentElement.parentElement.remove()">√ó</button>
        </div>
      `;

        // Add to page
        document.body.appendChild(notification);

        // Auto-remove after duration
        if (duration > 0) {
          setTimeout(() => {
            if (notification.parentNode) {
              notification.remove();
            }
          }, duration);
        }

        // Animate in
        setTimeout(() => {
          notification.classList.add("bb-notification-show");
        }, 10);
      }

      function showSuccessMessage(message, duration = 3000) {
        showDashboardError(message, "success", duration);
      }

      function showInfoMessage(message, duration = 4000) {
        showDashboardError(message, "info", duration);
      }

      // Handle authentication callback
      async function handleAuthCallback() {
        try {
          // Check if we have auth tokens in the URL hash
          const hashParams = new URLSearchParams(window.location.hash.substring(1));
          const accessToken = hashParams.get("access_token");
          const refreshToken = hashParams.get("refresh_token");

          if (accessToken) {
            console.log("Processing auth callback with tokens...");

            // Set the session in Supabase using the tokens
            const {
              data: { session },
              error,
            } = await supabase.auth.setSession({
              access_token: accessToken,
              refresh_token: refreshToken,
            });

            if (session) {
              console.log("User authenticated via callback:", session.user.email);

              // Clear the URL hash to clean up the URL
              history.replaceState(null, null, window.location.pathname);

              // Update user info will be called after dataBinder init
              return true;
            } else if (error) {
              console.error("Auth session setup error:", error);
            }
          } else {
            // Check if already authenticated
            const {
              data: { session },
            } = await supabase.auth.getSession();
            if (session) {
              console.log("User already authenticated:", session.user.email);
              return true;
            }
          }

          return false;
        } catch (error) {
          console.error("Auth callback processing error:", error);
          return false;
        }
      }

      // CAPTCHA token storage
      let captchaToken = null;

      // CAPTCHA success callback
      window.onTurnstileSuccess = function (token) {
        captchaToken = token;
        const signupBtn = document.getElementById("signupSubmitBtn");
        if (signupBtn) {
          signupBtn.disabled = false;
        }
      };

      // Authentication event handlers
      function setupAuthHandlers() {
        const loginBtn = document.getElementById("loginBtn");
        const logoutBtn = document.getElementById("logoutBtn");

        // Show auth modal instead of immediate OAuth
        if (loginBtn) {
          loginBtn.addEventListener("click", () => {
            showAuthModal();
          });
        }

        // Logout functionality
        if (logoutBtn) {
          logoutBtn.addEventListener("click", async () => {
            try {
              const { error } = await supabase.auth.signOut();
              if (error) {
                console.error("Logout error:", error);
                alert("Logout failed. Please try again.");
              } else {
                console.log("Logout successful");
                // The auth state change listener will update the UI automatically
                // Refresh the page to ensure clean state
                window.location.reload();
              }
            } catch (error) {
              console.error("Logout error:", error);
              alert("Logout failed. Please try again.");
            }
          });
        }

        // Set up modal form handlers
        setupAuthModalHandlers();
        setupCreateJobHandler();

        // Set up password strength checking
        setupPasswordStrength();
      }

      function setupAuthModalHandlers() {
        // Email login form
        const emailLoginForm = document.getElementById("emailLoginForm");
        if (emailLoginForm) {
          emailLoginForm.addEventListener("submit", handleEmailLogin);
        }

        // Email signup form
        const emailSignupForm = document.getElementById("emailSignupForm");
        if (emailSignupForm) {
          emailSignupForm.addEventListener("submit", handleEmailSignup);
        }

        // Password reset form
        const passwordResetForm = document.getElementById("passwordResetForm");
        if (passwordResetForm) {
          passwordResetForm.addEventListener("submit", handlePasswordReset);
        }

        // Social login buttons
        const socialButtons = document.querySelectorAll(".bb-social-btn[data-provider]");
        socialButtons.forEach((button) => {
          button.addEventListener("click", (e) => {
            const provider = e.currentTarget.dataset.provider;
            handleSocialLogin(provider);
          });
        });
      }

      function setupCreateJobHandler() {
        const createJobForm = document.getElementById("createJobForm");
        if (createJobForm) {
          createJobForm.addEventListener("submit", handleCreateJob);
        }

        // Close modal when clicking outside
        document.getElementById("createJobModal").addEventListener("click", (e) => {
          if (e.target.id === "createJobModal") {
            closeCreateJobModal();
          }
        });
      }

      async function handleCreateJob(event) {
        event.preventDefault();
        const formData = new FormData(event.target);

        const domain = formData.get("domain");
        const maxPages = parseInt(formData.get("max_pages"));
        const concurrency = parseInt(formData.get("concurrency"));
        const useSitemap = formData.get("use_sitemap") === "on";
        const findLinks = formData.get("find_links") === "on";

        // Basic validation
        if (!domain) {
          showCreateJobError("Domain is required");
          return;
        }

        if (maxPages < 0 || maxPages > 10000) {
          showCreateJobError("Maximum pages must be between 0 and 10000");
          return;
        }

        showCreateJobLoading();
        clearCreateJobError();

        try {
          console.log("Creating job with data:", {
            domain: domain,
            max_pages: maxPages,
            concurrency: concurrency,
            use_sitemap: useSitemap,
            find_links: findLinks,
          });

          console.log("Auth state before request:", {
            hasAuth: !!dataBinder.authManager,
            isAuthenticated: dataBinder.authManager?.isAuthenticated,
            user: dataBinder.authManager?.user?.email,
          });

          const requestOptions = {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              domain: domain,
              max_pages: maxPages,
              concurrency: concurrency,
              use_sitemap: useSitemap,
              find_links: findLinks,
            }),
          };

          console.log("Request options:", requestOptions);
          console.log("Request body:", requestOptions.body);

          const response = await dataBinder.fetchData("/v1/jobs", requestOptions);

          console.log("Job creation response:", response);

          console.log("Job created successfully:", response);

          // Close modal and refresh dashboard
          closeCreateJobModal();
          await dataBinder.refresh();

          // Show success message
          showSuccessMessage(`Job created successfully for ${domain}`);
        } catch (error) {
          console.error("Failed to create job:", error);
          showCreateJobError(error.message || "Failed to create job. Please try again.");
        } finally {
          hideCreateJobLoading();
        }
      }

      function showAuthModal() {
        document.getElementById("authModal").classList.add("show");
        showAuthForm("login");
      }

      function closeAuthModal() {
        document.getElementById("authModal").classList.remove("show");
        clearAuthError();
        hideAuthLoading();
      }

      function showAuthForm(formType) {
        // Hide all forms
        document.getElementById("loginForm").style.display = "none";
        document.getElementById("signupForm").style.display = "none";
        document.getElementById("resetForm").style.display = "none";

        // Show selected form
        const titles = {
          login: "Sign In",
          signup: "Create Account",
          reset: "Reset Password",
        };

        document.getElementById("authModalTitle").textContent = titles[formType];
        document.getElementById(`${formType}Form`).style.display = "block";

        // Reset CAPTCHA state for signup form
        if (formType === "signup") {
          captchaToken = null;
          const signupBtn = document.getElementById("signupSubmitBtn");
          if (signupBtn) {
            signupBtn.disabled = true;
          }
          // Reset Turnstile widget if it exists
          if (window.turnstile) {
            const turnstileWidget = document.querySelector(".cf-turnstile");
            if (turnstileWidget) {
              window.turnstile.reset(turnstileWidget);
            }
          }
        }

        clearAuthError();
        hideAuthLoading();
      }

      async function handleEmailLogin(event) {
        event.preventDefault();
        const formData = new FormData(event.target);
        const email = formData.get("email");
        const password = formData.get("password");

        showAuthLoading();
        clearAuthError();

        try {
          const { data, error } = await supabase.auth.signInWithPassword({
            email,
            password,
          });

          if (error) throw error;

          console.log("Email login successful:", data.user.email);
          
          // Register user with backend (in case they don't exist)
          await registerUserWithBackend(data.user);
          
          closeAuthModal();

          // Update user info immediately
          updateUserInfo();
          
          // Update auth state
          updateAuthState(true);

          // Refresh dashboard data
          await dataBinder.refresh();
          
          // Handle any pending domain
          await handlePendingDomain();
        } catch (error) {
          console.error("Email login error:", error);
          showAuthError(error.message || "Login failed. Please check your credentials.");
        } finally {
          hideAuthLoading();
        }
      }

      async function handleEmailSignup(event) {
        event.preventDefault();
        const formData = new FormData(event.target);
        const email = formData.get("email");
        const password = formData.get("password");
        const passwordConfirm = formData.get("passwordConfirm");

        if (password !== passwordConfirm) {
          showAuthError("Passwords do not match.");
          return;
        }

        if (password.length < 6) {
          showAuthError("Password must be at least 6 characters long.");
          return;
        }

        if (!captchaToken) {
          showAuthError("Please complete the CAPTCHA verification.");
          return;
        }

        showAuthLoading();
        clearAuthError();

        try {
          const { data, error } = await supabase.auth.signUp({
            email,
            password,
            options: { captchaToken },
          });

          if (error) throw error;

          console.log("Email signup successful:", data.user?.email);

          if (data.user && !data.user.email_confirmed_at) {
            showAuthError("Please check your email and click the confirmation link before signing in.");
            showAuthForm("login");
          } else if (data.user) {
            // Register user with backend
            await registerUserWithBackend(data.user);
            
            closeAuthModal();
            // Update user info and refresh dashboard
            updateUserInfo();
            updateAuthState(true);
            await dataBinder.refresh();
            await handlePendingDomain();
          }
        } catch (error) {
          console.error("Email signup error:", error);
          showAuthError(error.message || "Signup failed. Please try again.");
        } finally {
          hideAuthLoading();
        }
      }

      // Register user with backend database
      async function registerUserWithBackend(user) {
        if (!user || !user.id || !user.email) {
          console.error("Invalid user data for registration");
          return false;
        }

        try {
          const session = await supabase.auth.getSession();
          if (!session.data.session) {
            console.error("No session available for registration");
            return false;
          }

          const response = await fetch("/v1/auth/register", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              Authorization: `Bearer ${session.data.session.access_token}`,
            },
            body: JSON.stringify({
              user_id: user.id,
              email: user.email,
              full_name: user.user_metadata?.full_name || null,
            }),
          });

          if (!response.ok) {
            // If user already exists (409 Conflict), that's fine
            if (response.status === 409) {
              console.log("User already registered in backend");
              return true;
            }
            const errorData = await response.json();
            console.error("Backend registration failed:", errorData);
            return false;
          }

          const data = await response.json();
          console.log("User registered with backend:", data);
          return true;
        } catch (error) {
          console.error("Failed to register user with backend:", error);
          return false;
        }
      }

      async function handlePasswordReset(event) {
        event.preventDefault();
        const formData = new FormData(event.target);
        const email = formData.get("email");

        showAuthLoading();
        clearAuthError();

        try {
          const { error } = await supabase.auth.resetPasswordForEmail(email, {
            redirectTo: "https://app.bluebandedbee.co/dashboard",
          });

          if (error) throw error;

          showAuthError("Password reset email sent! Check your inbox.", "success");
          setTimeout(() => {
            showAuthForm("login");
          }, 2000);
        } catch (error) {
          console.error("Password reset error:", error);
          showAuthError(error.message || "Failed to send reset email.");
        } finally {
          hideAuthLoading();
        }
      }

      async function handleSocialLogin(provider) {
        showAuthLoading();
        clearAuthError();

        try {
          const { data, error } = await supabase.auth.signInWithOAuth({
            provider,
            options: {
              redirectTo: "https://app.bluebandedbee.co/dashboard",
            },
          });

          if (error) throw error;

          // OAuth will redirect, so no need to handle success here
        } catch (error) {
          console.error("Social login error:", error);
          showAuthError(error.message || `${provider} login failed.`);
          hideAuthLoading();
        }
      }

      function showAuthLoading() {
        document.getElementById("authLoading").style.display = "block";
        document.querySelector('.bb-auth-form:not([style*="display: none"])').style.display = "none";
      }

      function hideAuthLoading() {
        document.getElementById("authLoading").style.display = "none";
        document.querySelector('.bb-auth-form:not([style*="display: none"])').style.display = "block";
      }

      function showAuthError(message, type = "error") {
        const errorDiv = document.getElementById("authError");
        errorDiv.textContent = message;
        errorDiv.style.display = "block";

        if (type === "success") {
          errorDiv.style.background = "#dcfce7";
          errorDiv.style.color = "#16a34a";
          errorDiv.style.borderColor = "#bbf7d0";
        } else {
          errorDiv.style.background = "#fee2e2";
          errorDiv.style.color = "#dc2626";
          errorDiv.style.borderColor = "#fecaca";
        }
      }

      function clearAuthError() {
        document.getElementById("authError").style.display = "none";
      }

      // Password strength checking using zxcvbn
      function setupPasswordStrength() {
        const passwordInput = document.getElementById("signupPassword");
        const confirmInput = document.getElementById("signupPasswordConfirm");
        const strengthIndicator = document.getElementById("passwordStrength");
        const strengthFill = document.getElementById("strengthFill");
        const strengthText = document.getElementById("strengthText");
        const strengthFeedback = document.getElementById("strengthFeedback");

        if (!passwordInput || typeof zxcvbn === "undefined") {
          console.warn("Password strength checking not available");
          return;
        }

        // Show strength indicator when password field gets focus
        passwordInput.addEventListener("focus", () => {
          strengthIndicator.style.display = "block";
        });

        // Real-time password strength checking
        passwordInput.addEventListener("input", (e) => {
          const password = e.target.value;

          if (password.length === 0) {
            strengthIndicator.style.display = "none";
            return;
          }

          strengthIndicator.style.display = "block";

          // Use zxcvbn to evaluate password strength
          const result = zxcvbn(password);
          const score = result.score; // 0-4 scale

          // Clear previous classes
          strengthFill.className = "bb-strength-fill";
          strengthText.className = "bb-strength-text";

          // Apply strength classes and text
          let strengthLabel = "";
          switch (score) {
            case 0:
            case 1:
              strengthFill.classList.add("weak");
              strengthText.classList.add("weak");
              strengthLabel = "Weak";
              break;
            case 2:
              strengthFill.classList.add("fair");
              strengthText.classList.add("fair");
              strengthLabel = "Fair";
              break;
            case 3:
              strengthFill.classList.add("good");
              strengthText.classList.add("good");
              strengthLabel = "Good";
              break;
            case 4:
              strengthFill.classList.add("strong");
              strengthText.classList.add("strong");
              strengthLabel = "Strong";
              break;
          }

          strengthText.textContent = `Password strength: ${strengthLabel}`;

          // Show feedback and suggestions
          let feedback = "";
          if (result.feedback.warning) {
            feedback += result.feedback.warning + ". ";
          }
          if (result.feedback.suggestions.length > 0) {
            feedback += result.feedback.suggestions.join(". ");
          }
          if (password.length < 8) {
            feedback = "Password must be at least 8 characters long. " + feedback;
          }

          strengthFeedback.textContent = feedback;

          // Validate confirm password if it has content
          if (confirmInput.value) {
            validatePasswordMatch();
          }
        });

        // Real-time password confirmation checking
        confirmInput.addEventListener("input", validatePasswordMatch);

        function validatePasswordMatch() {
          const password = passwordInput.value;
          const confirm = confirmInput.value;

          // Remove existing validation styling
          confirmInput.classList.remove("bb-field-valid", "bb-field-invalid");
          const existingError = confirmInput.parentElement.querySelector(".bb-field-error");
          if (existingError) {
            existingError.remove();
          }

          if (confirm.length > 0) {
            if (password === confirm) {
              confirmInput.classList.add("bb-field-valid");
            } else {
              confirmInput.classList.add("bb-field-invalid");
              const errorDiv = document.createElement("div");
              errorDiv.className = "bb-field-error";
              errorDiv.textContent = "Passwords do not match";
              errorDiv.style.cssText = "color: #dc2626; font-size: 12px; margin-top: 4px;";
              confirmInput.parentElement.appendChild(errorDiv);
            }
          }
        }
      }

      // Setup tasks controls
      function setupTasksControls() {
        const limitSelect = document.getElementById("tasksLimit");
        if (limitSelect) {
          limitSelect.addEventListener("change", () => {
            tasksCurrentPage = 0; // Reset to first page when changing limit
            if (currentJobId) {
              loadJobTasks(currentJobId);
            }
          });
        }
      }

      // Initialize when page loads
      document.addEventListener("DOMContentLoaded", () => {
        setupTasksControls();
      });
    </script>
  </body>
</html>
