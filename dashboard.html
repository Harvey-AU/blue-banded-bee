<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Blue Banded Bee - Dashboard</title>

    <!-- Supabase CDN -->
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>

    <!-- Unified Auth Components -->
    <script src="/web/src/auth.js"></script>
    <script src="/js/bb-data-binder.min.js"></script>
    <script src="/web/src/bb-auth-extension.js"></script>

    <style>
      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
        margin: 0;
        padding: 0;
        background: #f5f7fa;
        min-height: 100vh;
      }

      .page-header {
        background: white;
        border-bottom: 1px solid #e5e7eb;
        padding: 24px 0;
        position: sticky;
        top: 0;
        z-index: 100;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
      }

      .page-header .container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 0 24px;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .page-title {
        display: flex;
        align-items: center;
        gap: 12px;
        margin: 0;
        font-size: 1.5rem;
        font-weight: 700;
        color: #1a1a1a;
      }

      .bee-icon {
        font-size: 1.8rem;
      }

      .user-menu {
        display: flex;
        align-items: center;
        gap: 12px;
      }

      .auth-buttons {
        display: flex;
        gap: 8px;
      }

      .user-info {
        display: flex;
        align-items: center;
        gap: 12px;
        font-size: 14px;
      }

      .bb-button {
        padding: 8px 16px;
        border-radius: 6px;
        border: none;
        font-size: 14px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s ease;
      }

      .bb-button-primary {
        background: #3b82f6;
        color: white;
      }

      .bb-button-primary:hover {
        background: #2563eb;
      }

      .bb-button-outline {
        background: transparent;
        color: #6b7280;
        border: 1px solid #d1d5db;
      }

      .bb-button-outline:hover {
        background: #f9fafb;
        border-color: #9ca3af;
      }

      .user-avatar {
        width: 32px;
        height: 32px;
        border-radius: 50%;
        background: #3b82f6;
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 600;
        font-size: 14px;
      }

      .main-content {
        max-width: 1200px;
        margin: 0 auto;
        padding: 24px;
      }

      .status-indicator {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        font-size: 12px;
        color: #6b7280;
      }

      .status-dot {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background: #22c55e;
        animation: pulse 2s infinite;
      }

      @keyframes pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.5; }
      }

      /* Auth loading state */
      .auth-loading {
        text-align: center;
        padding: 40px 20px;
        color: #6b7280;
      }

      .auth-spinner {
        width: 32px;
        height: 32px;
        border: 3px solid #e5e7eb;
        border-top: 3px solid #3b82f6;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin: 0 auto 16px;
      }

      @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
      }

      /* Login prompt for unauthenticated users */
      .login-prompt {
        max-width: 400px;
        margin: 80px auto;
        padding: 40px;
        background: white;
        border-radius: 12px;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        text-align: center;
      }

      .login-prompt .bee-icon {
        font-size: 48px;
        margin-bottom: 16px;
      }

      .login-prompt h1 {
        font-size: 1.875rem;
        font-weight: 700;
        margin-bottom: 8px;
        color: #1a1a1a;
      }

      .login-prompt p {
        color: #6b7280;
        font-size: 14px;
        margin-bottom: 24px;
      }

      .login-prompt .auth-buttons {
        gap: 12px;
        margin-bottom: 24px;
      }

      .login-prompt .bb-button {
        flex: 1;
      }

      /* Dashboard content styles */
      .dashboard-form {
        background: white;
        border-radius: 12px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        margin-bottom: 24px;
        padding: 24px;
      }

      .dashboard-form h2 {
        margin: 0 0 16px 0;
        font-size: 1.25rem;
        font-weight: 600;
        color: #374151;
      }

      .form-grid {
        display: grid;
        grid-template-columns: 1fr 120px 120px auto;
        gap: 16px;
        align-items: end;
      }

      .form-group {
        display: flex;
        flex-direction: column;
        gap: 6px;
      }

      .form-group label {
        font-weight: 500;
        color: #374151;
        font-size: 14px;
      }

      .form-input {
        width: 100%;
        padding: 12px 16px;
        border: 1px solid #d1d5db;
        border-radius: 6px;
        font-size: 14px;
        background: white;
        color: #374151;
        box-sizing: border-box;
      }

      .form-input:focus {
        outline: none;
        border-color: #3b82f6;
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
      }

      .form-submit {
        padding: 12px 24px;
        white-space: nowrap;
      }

      /* Statistics and dashboard content */
      .bb-stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
      }

      .bb-stat-card {
        background: white;
        padding: 24px;
        border-radius: 12px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        text-align: center;
        border: 1px solid #f0f0f0;
      }

      .bb-stat-value {
        font-size: 2.5em;
        font-weight: 700;
        margin-bottom: 8px;
        color: #1a1a1a;
      }

      .bb-stat-label {
        color: #666;
        font-size: 14px;
        font-weight: 500;
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }

      .bb-section {
        background: white;
        border-radius: 12px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        overflow: hidden;
        margin-bottom: 30px;
      }

      .bb-section-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 24px 24px 0 24px;
        margin-bottom: 20px;
      }

      .bb-section-header h3 {
        margin: 0;
        font-size: 1.25em;
        font-weight: 600;
      }

      .bb-btn {
        padding: 8px 16px;
        border-radius: 6px;
        border: none;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s ease;
        display: inline-flex;
        align-items: center;
        gap: 6px;
        text-decoration: none;
      }

      .bb-btn-primary {
        background: #3b82f6;
        color: white;
      }

      .bb-btn-primary:hover {
        background: #2563eb;
      }

      .bb-btn-secondary {
        background: #f3f4f6;
        color: #374151;
      }

      .bb-btn-secondary:hover {
        background: #e5e7eb;
      }

      /* Empty state */
      .empty-state {
        text-align: center;
        padding: 40px 20px;
        color: #6b7280;
      }

      .empty-state .bee-icon {
        font-size: 48px;
        margin-bottom: 16px;
      }

      .empty-state h3 {
        margin: 0 0 8px 0;
        color: #374151;
      }

      .empty-state p {
        margin: 0;
        font-size: 14px;
      }

      @media (max-width: 768px) {
        .page-header .container {
          padding: 0 16px;
        }

        .main-content {
          padding: 16px;
        }

        .form-grid {
          grid-template-columns: 1fr;
          gap: 16px;
        }
      }
    </style>

    <!-- Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-D990P29YMF"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-D990P29YMF');
    </script>
  </head>

  <body>
    <!-- Page Header -->
    <header class="page-header">
      <div class="container">
        <h1 class="page-title">
          <span class="bee-icon">üêù</span>
          Blue Banded Bee
        </h1>

        <div class="user-menu">
          <div class="status-indicator">
            <span class="status-dot"></span>
            <span>Live</span>
          </div>

          <!-- Show when not authenticated -->
          <div data-bb-auth="guest" class="auth-buttons">
            <button data-bb-action="show-login" class="bb-button bb-button-primary">Sign In</button>
          </div>

          <!-- Show when authenticated -->
          <div data-bb-auth="required" class="user-info">
            <span data-bb-bind="user.email">Loading...</span>
            <div class="user-avatar" data-bb-bind="user.initials">?</div>
            <button data-bb-action="sign-out" class="bb-button bb-button-outline">Sign Out</button>
          </div>
        </div>
      </div>
    </header>

    <!-- Main Content -->
    <main class="main-content">
      <!-- Loading state while auth initializes -->
      <div data-bb-auth="loading" class="auth-loading">
        <div class="auth-spinner"></div>
        <div>Loading...</div>
      </div>

      <!-- Login prompt for unauthenticated users -->
      <div data-bb-auth="guest" class="login-prompt">
        <div class="bee-icon">üêù</div>
        <h1>Blue Banded Bee</h1>
        <p>Cache warming service dashboard</p>
        
        <div class="auth-buttons">
          <button data-bb-action="show-login" class="bb-button bb-button-primary">Sign In</button>
          <button data-bb-action="show-signup" class="bb-button bb-button-outline">Create Account</button>
        </div>
        
        <div style="text-align: center; color: #6b7280; font-size: 14px;">
          Sign in to access your dashboard
        </div>
      </div>

      <!-- Dashboard content for authenticated users -->
      <div data-bb-auth="required" style="display: none;">
        <!-- Job Creation Form -->
        <div class="dashboard-form">
          <h2>Start Cache Warming</h2>
          
          <form data-bb-form="start-crawling" data-bb-auth-required="true" class="form-grid">
            <div class="form-group">
              <label>Domain</label>
              <input 
                type="text" 
                name="domain" 
                required 
                placeholder="example.com" 
                class="form-input"
              />
            </div>
            
            <div class="form-group">
              <label>Max Pages</label>
              <input 
                type="number" 
                name="max_pages" 
                min="0" 
                max="10000" 
                value="0" 
                class="form-input"
              />
            </div>
            
            <div class="form-group">
              <label>Refresh</label>
              <select class="form-input" id="refreshInterval">
                <option value="0">Manual</option>
                <option value="10" selected>10 seconds</option>
                <option value="30">30 seconds</option>
                <option value="60">1 minute</option>
              </select>
            </div>
            
            <button type="submit" class="bb-button bb-button-primary form-submit">
              Start Crawl
            </button>
          </form>
        </div>

        <!-- Stats Overview -->
        <div class="bb-stats-grid">
          <div class="bb-stat-card">
            <div class="bb-stat-value" data-bb-bind="stats.total_jobs">-</div>
            <div class="bb-stat-label">Total Jobs</div>
          </div>
          <div class="bb-stat-card">
            <div class="bb-stat-value" data-bb-bind="stats.running_jobs">-</div>
            <div class="bb-stat-label">Running</div>
          </div>
          <div class="bb-stat-card">
            <div class="bb-stat-value" data-bb-bind="stats.completed_jobs">-</div>
            <div class="bb-stat-label">Completed</div>
          </div>
          <div class="bb-stat-card">
            <div class="bb-stat-value" data-bb-bind="stats.failed_jobs">-</div>
            <div class="bb-stat-label">Failed</div>
          </div>
        </div>

        <!-- Recent Jobs Section -->
        <div class="bb-section">
          <div class="bb-section-header">
            <h3>Recent Jobs</h3>
            <div style="display: flex; gap: 12px;">
              <button class="bb-btn bb-btn-secondary" data-bb-action="refresh-dashboard">
                <span>‚Üª</span> Refresh
              </button>
            </div>
          </div>

          <div style="padding: 0 24px 24px 24px;">
            <!-- Jobs will be rendered here by data binding -->
            <div data-bb-template="job" style="display: none;">
              <div style="background: #f8f9fa; border: 1px solid #e9ecef; border-radius: 8px; padding: 20px; margin-bottom: 16px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                  <div style="font-weight: 600; font-size: 1.1em; color: #1a1a1a;" data-bb-bind="domain">example.com</div>
                  <div style="padding: 6px 12px; border-radius: 20px; font-size: 12px; font-weight: 600; text-transform: uppercase;" data-bb-bind="status">pending</div>
                </div>
                <div style="margin-bottom: 16px;">
                  <div style="width: 100%; height: 8px; background: #e5e7eb; border-radius: 4px; overflow: hidden; margin-bottom: 8px;">
                    <div style="height: 100%; background: linear-gradient(90deg, #3b82f6, #1d4ed8); transition: width 0.3s ease;" data-bb-bind-style="width:{progress}%"></div>
                  </div>
                  <div style="font-size: 14px; color: #6b7280;">
                    <span data-bb-bind="completed_tasks">0</span> / <span data-bb-bind="total_tasks">0</span> tasks 
                    (<span data-bb-bind="progress">0</span>%)
                  </div>
                </div>
                <div style="display: flex; justify-content: space-between; align-items: center; font-size: 14px;">
                  <div style="color: #6b7280;">
                    <span style="font-weight: 500;">Started:</span>
                    <span data-bb-bind="started_at_formatted">-</span>
                  </div>
                  <div style="display: flex; gap: 8px;">
                    <button style="background: none; border: none; color: #3b82f6; cursor: pointer; text-decoration: underline; font-size: 14px;" 
                            data-bb-action="view-job-details" data-bb-bind-attr="data-job-id:{id}">
                      View Details
                    </button>
                  </div>
                </div>
              </div>
            </div>

            <!-- Empty state -->
            <div class="empty-state" data-bb-show-if="jobs.length=0">
              <div class="bee-icon">üêù</div>
              <h3>No jobs yet</h3>
              <p>Use the form above to start your first cache warming job</p>
            </div>
          </div>
        </div>
      </div>
    </main>

    <!-- Auth Modal Container -->
    <div id="authModalContainer"></div>

    <script>
      // Initialize unified auth system
      document.addEventListener('DOMContentLoaded', async () => {
        console.log('Initializing unified dashboard...');

        // Create data binder with auth extension
        const dataBinder = new BBDataBinder({
          apiBaseUrl: '',
          debug: true,
          refreshInterval: 10,
          auth: {
            autoLoadAuthModal: true,
            authModalUrl: '/auth-modal.html'
          }
        });

        // Initialize the system
        await dataBinder.init();

        // Set up refresh interval control
        const refreshInterval = document.getElementById('refreshInterval');
        if (refreshInterval) {
          refreshInterval.addEventListener('change', () => {
            const interval = parseInt(refreshInterval.value);
            dataBinder.stopAutoRefresh();
            if (interval > 0) {
              dataBinder.refreshInterval = interval;
              dataBinder.startAutoRefresh();
            }
          });
        }

        // Override refresh method to load dashboard data
        dataBinder.refresh = async function() {
          if (!this.authManager?.isAuthenticated) {
            console.log('User not authenticated, skipping dashboard data load');
            return;
          }

          try {
            console.log('Refreshing dashboard data...');

            // Load stats
            let statsData;
            try {
              statsData = await this.fetchData('/v1/dashboard/stats?range=today');
            } catch (error) {
              console.log('Stats API error (likely no data yet):', error);
              statsData = {
                total_jobs: 0,
                running_jobs: 0,
                completed_jobs: 0,
                failed_jobs: 0
              };
            }

            // Load jobs
            let jobsData;
            try {
              const jobsResponse = await this.fetchData('/v1/jobs?limit=10&range=today');
              jobsData = jobsResponse.jobs || [];
            } catch (error) {
              console.log('Jobs API error (likely no jobs yet):', error);
              jobsData = [];
            }

            // Process jobs data
            const processedJobs = jobsData.map(job => ({
              ...job,
              domain: job.domains?.name || 'Unknown Domain',
              progress: Math.round(job.progress || 0),
              started_at_formatted: job.started_at ? new Date(job.started_at).toLocaleString() : '-'
            }));

            // Update elements
            this.updateElements({
              stats: statsData,
              jobs: processedJobs
            });

            // Update user info
            if (this.authManager?.user) {
              const email = this.authManager.user.email;
              const initials = this.getInitials(email);
              this.updateElements({
                user: {
                  email: email,
                  initials: initials
                }
              });
            }

            // Bind templates
            this.bindTemplates({
              job: processedJobs
            });

            console.log('Dashboard data refreshed successfully');
          } catch (error) {
            console.error('Dashboard refresh failed:', error);
          }
        };

        // Helper function for user initials
        dataBinder.getInitials = function(email) {
          if (!email) return '?';
          const emailPrefix = email.split('@')[0];
          if (emailPrefix.includes('.')) {
            const parts = emailPrefix.split('.');
            return parts.map(part => part.charAt(0).toUpperCase()).slice(0, 2).join('');
          } else if (emailPrefix.includes('_')) {
            const parts = emailPrefix.split('_');
            return parts.map(part => part.charAt(0).toUpperCase()).slice(0, 2).join('');
          } else {
            return emailPrefix.slice(0, 2).toUpperCase();
          }
        };

        // Store globally for debugging
        window.dataBinder = dataBinder;

        console.log('Unified dashboard initialized');
      });
    </script>
  </body>
</html>