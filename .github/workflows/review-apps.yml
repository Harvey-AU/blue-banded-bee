name: Deploy Review App

on:
  pull_request:
    branches:
      - main
    types: [opened, synchronize, reopened, closed]
    paths-ignore:
      - "**.md"
      - "docs/**"
      - "LICENSE"
      - ".gitignore"
      - "CHANGELOG.md"
      - "SECURITY.md"
      - "Roadmap.md"
      - "QandA.md"

jobs:
  deploy-review:
    name: Deploy Review App
    runs-on: blacksmith-4vcpu-ubuntu-2404
    if: |
      github.event.pull_request.draft == false &&
      github.event.action != 'closed' &&
      !contains(github.event.pull_request.title, '[preview skip]') &&
      !contains(github.event.pull_request.body || '', '[preview skip]')
    permissions:
      pull-requests: write

    concurrency:
      group: preview-${{ github.event.number }}
      cancel-in-progress: true

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.26.0"

      - name: Setup Fly.io CLI
        uses: superfly/flyctl-actions/setup-flyctl@master

      - name: Setup Supabase CLI
        uses: supabase/setup-cli@v1
        with:
          version: "2.67.1"

      - name: Get Supabase Preview Branch URL
        id: supabase
        run: |
          echo "üîç Listing all Supabase branches..."
          supabase branches list --project-ref "$SUPABASE_PROJECT_REF" || echo "Failed to list branches"

          echo ""
          echo "üîç Looking for branch: $BRANCH_NAME"

          # Get branch details as JSON for robust parsing
          BRANCH_JSON=$(supabase branches get "$BRANCH_NAME" --project-ref "$SUPABASE_PROJECT_REF" --output json 2>/dev/null) || true

          # Debug: show available fields (keys only, not values)
          echo "üîë Available JSON fields:"
          echo "$BRANCH_JSON" | jq -r 'keys[]' 2>/dev/null || echo "  (none)"

          # Extract pooler URL (for general queries) - try multiple field names
          PREVIEW_DB_URL=$(echo "$BRANCH_JSON" | jq -r '.POSTGRES_URL // .postgres_url // .db_url // empty' 2>/dev/null)

          # Extract direct URL (for LISTEN/NOTIFY) - Supabase uses POSTGRES_URL_NON_POOLING
          DIRECT_DB_URL=$(echo "$BRANCH_JSON" | jq -r '.POSTGRES_URL_NON_POOLING // empty' 2>/dev/null)

          echo "üìä URLs found:"
          echo "  Pooler URL present: $([ -n "$PREVIEW_DB_URL" ] && echo 'yes' || echo 'no')"
          echo "  Direct URL present: $([ -n "$DIRECT_DB_URL" ] && echo 'yes' || echo 'no')"

          if [ -n "$PREVIEW_DB_URL" ]; then
            echo "‚úÖ Found Supabase preview branch!"
            echo "preview_db_url=$PREVIEW_DB_URL" >> $GITHUB_OUTPUT
            echo "direct_db_url=$DIRECT_DB_URL" >> $GITHUB_OUTPUT
            echo "branch_exists=true" >> $GITHUB_OUTPUT
          else
            echo "‚ö†Ô∏è No Supabase preview branch found"
            echo "branch_exists=false" >> $GITHUB_OUTPUT
          fi
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
          SUPABASE_PROJECT_REF: ${{ secrets.SUPABASE_PROJECT_REF }}
          BRANCH_NAME: ${{ github.head_ref }}

      - name: Log Supabase Branch Status
        run: |
          echo "========================================"
          echo "SUPABASE PREVIEW BRANCH STATUS"
          echo "========================================"
          echo "Branch exists: ${{ steps.supabase.outputs.branch_exists }}"
          echo "Preview DB available: ${{ steps.supabase.outputs.preview_db_url != '' }}"
          echo "========================================"

      - name: Build Docker image locally
        run: docker build -t blue-banded-bee:pr-${{ github.event.number }} .

      - name: Deploy Review App
        id: deploy
        run: |
          # Use Supabase preview branch if available
          if [ "${{ steps.supabase.outputs.branch_exists }}" == "true" ]; then
            DB_URL="${{ steps.supabase.outputs.preview_db_url }}"
            DIRECT_URL="${{ steps.supabase.outputs.direct_db_url }}"
            echo "üîÄ Using Supabase PREVIEW database"
            echo "db_type=preview" >> $GITHUB_OUTPUT
          else
            DB_URL="${{ secrets.TEST_DATABASE_URL }}"
            DIRECT_URL=""
            if [ -z "$DB_URL" ]; then
              DB_URL="${{ secrets.DATABASE_URL }}"
            fi
            echo "üîÄ Using SHARED database (no preview branch)"
            echo "db_type=shared" >> $GITHUB_OUTPUT
          fi
          if [ -z "$DB_URL" ]; then
            echo "‚ùå Database configuration missing. Set either TEST_DATABASE_URL or DATABASE_URL secret." >&2
            exit 1
          fi

          # Create review app name
          APP_NAME="blue-banded-bee-pr-${{ github.event.number }}"

          # Check if app exists, create if not
          if ! flyctl apps list | grep -q "$APP_NAME"; then
            echo "Creating new review app: $APP_NAME"
            flyctl apps create "$APP_NAME" --org personal
          else
            echo "Review app already exists: $APP_NAME"
          fi

          # Set secrets for Review App WITHOUT triggering deployment
          echo "Setting test database connection and auth secrets for review app..."
          if [ -n "$DIRECT_URL" ]; then
            echo "üì° Setting DATABASE_DIRECT_URL for real-time notifications"
            flyctl secrets set \
              DATABASE_URL="$DB_URL" \
              DATABASE_DIRECT_URL="$DIRECT_URL" \
              SUPABASE_JWT_SECRET="${{ secrets.SUPABASE_JWT_SECRET }}" \
              SUPABASE_SERVICE_ROLE_KEY="${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}" \
              SENTRY_DSN="${{ secrets.SENTRY_DSN }}" \
              LOOPS_API_KEY="${{ secrets.LOOPS_API_KEY }}" \
              SLACK_CLIENT_ID="${{ secrets.SLACK_CLIENT_ID }}" \
              SLACK_CLIENT_SECRET="${{ secrets.SLACK_CLIENT_SECRET }}" \
              WEBFLOW_CLIENT_ID="${{ secrets.WEBFLOW_CLIENT_ID }}" \
              WEBFLOW_CLIENT_SECRET="${{ secrets.WEBFLOW_CLIENT_SECRET }}" \
              GOOGLE_CLIENT_ID="${{ secrets.GOOGLE_CLIENT_ID }}" \
              GOOGLE_CLIENT_SECRET="${{ secrets.GOOGLE_CLIENT_SECRET }}" \
              GOOGLE_REDIRECT_URI="https://$APP_NAME.fly.dev/v1/integrations/google/callback" \
              APP_URL="https://$APP_NAME.fly.dev" \
              --app $APP_NAME --stage
          else
            flyctl secrets set \
              DATABASE_URL="$DB_URL" \
              SUPABASE_JWT_SECRET="${{ secrets.SUPABASE_JWT_SECRET }}" \
              SUPABASE_SERVICE_ROLE_KEY="${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}" \
              SENTRY_DSN="${{ secrets.SENTRY_DSN }}" \
              LOOPS_API_KEY="${{ secrets.LOOPS_API_KEY }}" \
              SLACK_CLIENT_ID="${{ secrets.SLACK_CLIENT_ID }}" \
              SLACK_CLIENT_SECRET="${{ secrets.SLACK_CLIENT_SECRET }}" \
              WEBFLOW_CLIENT_ID="${{ secrets.WEBFLOW_CLIENT_ID }}" \
              WEBFLOW_CLIENT_SECRET="${{ secrets.WEBFLOW_CLIENT_SECRET }}" \
              GOOGLE_CLIENT_ID="${{ secrets.GOOGLE_CLIENT_ID }}" \
              GOOGLE_CLIENT_SECRET="${{ secrets.GOOGLE_CLIENT_SECRET }}" \
              GOOGLE_REDIRECT_URI="https://$APP_NAME.fly.dev/v1/integrations/google/callback" \
              APP_URL="https://$APP_NAME.fly.dev" \
              --app $APP_NAME --stage
          fi

          # Deploy to review app with local image (this will apply staged secrets)
          # Region is set via primary_region in .fly/review_apps.toml (syd)
          flyctl deploy \
            --app $APP_NAME \
            --config .fly/review_apps.toml \
            --local-only \
            --image blue-banded-bee:pr-${{ github.event.number }}
        env:
          FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}

      - name: Comment PR with app URL
        uses: actions/github-script@v7
        with:
          script: |
            const appName = `blue-banded-bee-pr-${{ github.event.number }}`;
            const appUrl = `https://${appName}.fly.dev`;
            const dbType = `${{ steps.deploy.outputs.db_type }}`;
            const dbLabel = dbType === 'preview' ? 'Supabase preview branch' : 'Shared test database';

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `üêù **Review App Deployed!**

              <a href="${appUrl}" target="_blank">Homepage: ${appUrl}</a>

              üìã **Test Features:**
              1. <a href="${appUrl}/dashboard" target="_blank">Visit dashboard: ${appUrl}/dashboard</a>
              2. Test authentication and job creation flow
              3. Check dashboard functionality
              4. Verify database operations work correctly

              üóÑÔ∏è **Database**: ${dbLabel}
              ‚ö†Ô∏è *Preview environment - app and database cleaned up when PR closes*`
            });

  cleanup-review:
    name: Cleanup Review App
    runs-on: blacksmith-4vcpu-ubuntu-2404
    if: github.event.action == 'closed'

    steps:
      - name: Setup Fly.io CLI
        uses: superfly/flyctl-actions/setup-flyctl@master

      - name: Destroy Review App
        run: |
          APP_NAME="blue-banded-bee-pr-${{ github.event.number }}"
          flyctl apps destroy $APP_NAME --yes || echo "App may not exist"
        env:
          FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}
