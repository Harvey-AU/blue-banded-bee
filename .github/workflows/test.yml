name: Run Tests
on:
  pull_request:
    branches:
      - main
      - test-branch
    paths-ignore:
      - "**.md"
      - "docs/**"
      - "LICENSE"
      - ".gitignore"
      - "CHANGELOG.md"
      - "SECURITY.md"
      - "Roadmap.md"
      - "QandA.md"
  push:
    branches:
      - main
    paths-ignore:
      - "**.md"
      - "docs/**"
      - "LICENSE"
      - ".gitignore"
      - "CHANGELOG.md"
      - "SECURITY.md"
      - "Roadmap.md"
      - "QandA.md"

jobs:
  lint:
    name: Lint
    runs-on: blacksmith-4vcpu-ubuntu-2404
    env:
      GOFLAGS: "-mod=mod"
      GOPROXY: "https://proxy.golang.org,direct"
    steps:
      - uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.26.0"
          cache: true

      - name: Determine Go cache paths
        id: go-env
        run: |
          echo "gomodcache=$(go env GOMODCACHE)" >> $GITHUB_OUTPUT
          echo "gocache=$(go env GOCACHE)" >> $GITHUB_OUTPUT

      - name: Cache Go modules
        uses: actions/cache@v4
        with:
          path: |
            ${{ steps.go-env.outputs.gomodcache }}
            ${{ steps.go-env.outputs.gocache }}
          key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}
          restore-keys: |
            ${{ runner.os }}-go-

      - name: Download dependencies
        run: go mod download

      - name: Prime module graph (test + prod)
        run: go list -deps -test ./...

      - name: golangci-lint
        uses: golangci/golangci-lint-action@v7
        with:
          version: v2.9.0
          args: --config .golangci.yml --modules-download-mode=mod

  format:
    name: Format Check
    runs-on: blacksmith-4vcpu-ubuntu-2404
    steps:
      - uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.26.0"
          cache: true

      - name: Check Go formatting
        run: |
          echo "=== Checking Go formatting ==="
          UNFORMATTED=$(gofmt -l .)
          if [ -n "$UNFORMATTED" ]; then
            echo "❌ The following files are not formatted with gofmt:"
            echo "$UNFORMATTED"
            echo ""
            echo "Run 'gofmt -w .' to fix formatting"
            exit 1
          fi
          echo "✅ All Go files are properly formatted"

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install Prettier
        run: npm install --global prettier

      - name: Check Prettier formatting
        run: |
          echo "=== Checking Prettier formatting ==="
          prettier --check "**/*.{md,yml,yaml,json,html,css,js}" || {
            echo ""
            echo "❌ Some files are not formatted with Prettier"
            echo "Run 'prettier --write \"**/*.{md,yml,yaml,json,html,css,js}\"' to fix formatting"
            exit 1
          }
          echo "✅ All files are properly formatted with Prettier"

  unit-tests:
    name: Unit Tests
    runs-on: blacksmith-4vcpu-ubuntu-2404
    needs: [lint, format]
    steps:
      - uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.26.0"
          cache: true

      - name: Run unit tests
        run: |
          echo "=== Running Unit Tests ==="
          go test -race -short -shuffle=on -covermode=atomic -coverprofile=coverage-unit.out -coverpkg=./... ./... || \
          go test -v -race -short -shuffle=on -covermode=atomic -coverprofile=coverage-unit.out -coverpkg=./... ./...

      - name: Upload unit test coverage
        uses: actions/upload-artifact@v4
        with:
          name: coverage-unit
          path: coverage-unit.out

      - name: Upload unit test coverage to Codecov
        uses: codecov/codecov-action@v5
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          files: ./coverage-unit.out
          flags: unit
          name: unit-tests
          fail_ci_if_error: false

  integration-tests:
    name: Integration Tests
    runs-on: blacksmith-4vcpu-ubuntu-2404
    needs: [lint, format]
    steps:
      - uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.26.0"
          cache: true

      - name: Skip database setup for dynamic preview branches
        run: |
          echo "Skipping database setup - using Supabase preview branches per PR"
          echo "Integration tests will run on deployed review apps with their own database"

      - name: Run integration tests
        run: |
          echo "=== Running Integration Tests ==="
          go test -race -covermode=atomic -coverprofile=coverage-integration.out -coverpkg=./... -tags=integration ./... -json > test-output.json || \
          go test -v -race -covermode=atomic -coverprofile=coverage-integration.out -coverpkg=./... -tags=integration ./... -json > test-output.json

          # Show test results summary
          echo "=== Test Results ==="
          if grep -q '"Action":"fail"' test-output.json; then
            echo "❌ Found test failures:"
            grep -E '"Action":"fail"' test-output.json | head -10 || true
          else
            echo "✅ All integration tests passed!"
          fi

      - name: Generate JUnit report
        if: always()
        run: |
          go install github.com/jstemmer/go-junit-report/v2@latest
          $(go env GOPATH)/bin/go-junit-report -parser gojson < test-output.json > junit.xml

      - name: Upload integration test coverage
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: coverage-integration
          path: coverage-integration.out

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results
          path: junit.xml

      - name: Upload integration test coverage to Codecov
        if: always()
        uses: codecov/codecov-action@v5
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          files: ./coverage-integration.out
          flags: integration
          name: integration-tests
          fail_ci_if_error: false

      - name: Upload test results to Codecov
        if: always()
        uses: codecov/test-results-action@v1
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          files: ./junit.xml

  coverage-report:
    name: Coverage Report (Informational Only)
    runs-on: blacksmith-4vcpu-ubuntu-2404
    needs: [unit-tests, integration-tests]
    if:
      always() && (needs.unit-tests.result == 'success' ||
      needs.integration-tests.result == 'success')
    steps:
      - uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.26.0"
          cache: true

      - name: Download coverage files
        uses: actions/download-artifact@v4
        with:
          pattern: coverage-*
          merge-multiple: true

      - name: Merge coverage reports
        run: |
          echo "=== Merging Coverage Reports ==="

          # Simple approach - use unit tests coverage primarily  
          if [ -f coverage-unit.out ]; then
            echo "Using unit coverage as primary"
            cp coverage-unit.out coverage.out
          elif [ -f coverage-integration.out ]; then
            echo "Using integration coverage as fallback"  
            cp coverage-integration.out coverage.out
          else
            echo "No coverage files found"
            exit 1
          fi

          # Show total coverage
          if [ -f coverage.out ]; then
            echo "=== Total Coverage ==="
            go tool cover -func=coverage.out | tail -1
          fi

      - name: Upload combined coverage to Codecov
        uses: codecov/codecov-action@v5
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          files: ./coverage.out
          flags: all
          name: all-tests
          fail_ci_if_error: false

      - name: Upload static analysis to Codecov
        uses: codecov/codecov-action@v5
        with:
          token: ${{ secrets.CODECOV_STATIC_TOKEN }}
          flags: static-analysis
          name: static-analysis
          fail_ci_if_error: false
