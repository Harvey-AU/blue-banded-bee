# Fly Review Apps Configuration
# See: https://fly.io/docs/reference/fly-review-apps/

[review_apps]
# Enable automatic deployment for PRs targeting test-branch
auto_deploy = true
# Automatically destroy when PR is closed/merged
auto_destroy = true

# Base branch for review apps (PRs must target this branch)
base_branch = "main"

# Optional: Custom subdomain pattern
# Will create URLs like: blue-banded-bee-pr-123.fly.dev
app_name_pattern = "blue-banded-bee-pr-{pr_number}"
primary_region = "syd"

# Environment overrides for staging
[env]
APP_ENV = "staging"
PORT = "8080"

# Explicitly source DATABASE_URL from secrets
DATABASE_URL = { from_secret = "DATABASE_URL" }
# Public configuration - same as production
SUPABASE_AUTH_URL = "https://auth.bluebandedbee.co"
SUPABASE_PUBLISHABLE_KEY = "sb_publishable_xCn-z8wEo4MPJnbPq6cvXg_09fINjIp"

# Performance settings (preview has own DB now, can align closer to prod)
WORKER_CONCURRENCY = "5"                    # Half of prod (respects 512mb VM)
DB_QUEUE_MAX_CONCURRENCY = "20"             # Half of prod
DB_TX_MAX_RETRIES = "5"                     # Same as prod
BBB_RUNNING_TASK_BATCH_SIZE = "32"          # Same as prod (reduces DB trips)
BBB_RUNNING_TASK_FLUSH_INTERVAL_MS = "200"  # Same as prod

# Use same machine config as production but smaller
[vm]
memory = '512mb'  # Smaller than production for cost savings
cpu_kind = 'shared'
cpus = 1

# Same health checks as production
[http_service]
internal_port = 8080
force_https = true
auto_stop_machines = 'stop'
auto_start_machines = true
min_machines_running = 1

[[http_service.checks]]
grace_period = "10s"  # Reduced from 30s for faster deployments
interval = "10s"      # Reduced from 15s for quicker health checks
method = "GET"
path = "/health"
protocol = "http"
timeout = "5s"        # Reduced from 10s

[http_service.checks.headers]
Content-Type = "text/plain"
