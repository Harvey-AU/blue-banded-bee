# Load Test Metrics Report - 24 October 2025

Generated: 2025-10-24 22:20 UTC (09:20 AEDT)

## Executive Summary

System is processing jobs successfully with consistent throughput of 400-550
tasks/minute. All services responding with excellent latency (3-6ms average).
Database performance issues identified but not blocking operations.

---

## Load Test Batch Summary

### Batch 1 (Started 11:11 UTC / 21:11 AEDT)

| Domain           | Status  | Progress | Tasks  | Completed | Failed | Skipped | Runtime |
| ---------------- | ------- | -------- | ------ | --------- | ------ | ------- | ------- |
| render.com       | Running | 36.8%    | 7,536  | 485       | 1,352  | 2,539   | 11h 6m  |
| railway.app      | Running | 15.2%    | 2,033  | 308       | 0      | 0       | 11h 6m  |
| creativebloq.com | Running | 4.4%     | 16,388 | 221       | 0      | 10,355  | 11h 3m  |

### Batch 2 (Started 11:14 UTC / 21:14 AEDT)

| Domain        | Status  | Progress | Tasks  | Completed | Failed | Skipped | Runtime     |
| ------------- | ------- | -------- | ------ | --------- | ------ | ------- | ----------- |
| kotn.com      | Running | 8.3%     | 1,912  | 158       | 0      | 0       | 11h 3m      |
| jbhifi.com.au | Running | 2.5%     | 14,024 | 125       | 0      | 8,024   | 11h 2m      |
| kmart.com.au  | Pending | 0%       | 0      | 0         | 0      | 0       | Not started |

**Total:** 41,893 tasks across 6 jobs, 1,297 completed in last 15 minutes

---

## Real-Time Throughput (Last 15 Minutes)

| Time (UTC) | Tasks/Min | Avg Response | Server Errors | Client Errors |
| ---------- | --------- | ------------ | ------------- | ------------- |
| 22:17      | 161       | 4ms          | 0             | 0             |
| 22:16      | 414       | 3ms          | 0             | 0             |
| 22:15      | 467       | 4ms          | 0             | 0             |
| 22:14      | 512       | 5ms          | 0             | 0             |
| 22:13      | 546       | 5ms          | 0             | 0             |
| 22:12      | 421       | 4ms          | 0             | 0             |
| 22:11      | 128       | 4ms          | 0             | 0             |

**Peak Throughput:** 546 tasks/minute (~9 tasks/second) **Average:** 400-500
tasks/minute (~7 tasks/second) **Error Rate:** 0% (all errors are legitimate
404s from source sites)

---

## Performance Metrics by Domain

| Domain           | Concurrency | Avg Response | p50    | p95    | Cache Hit Rate |
| ---------------- | ----------- | ------------ | ------ | ------ | -------------- |
| creativebloq.com | 3           | 4.56ms       | 4.71ms | 6.80ms | 0% (warming)   |
| jbhifi.com.au    | 3           | 2.95ms       | 3.02ms | 5.34ms | N/A            |
| render.com       | 3           | 3.97ms       | 4.49ms | 5.68ms | 100%           |
| railway.app      | 3           | 4.17ms       | 4.63ms | 5.85ms | N/A            |
| kotn.com         | 3           | 3.57ms       | 3.45ms | 5.75ms | 100%           |

**All domains responding in 3-6ms range** - excellent performance
characteristics

---

## Database Performance Analysis

### PostgreSQL Lock Contention

**Observed Issues:**

- Multiple processes waiting 1-6 seconds for ShareLock on transactions
- ExclusiveLock waits on tuple updates (1-5 seconds)
- Pattern indicates worker processes competing for job/task row locks

**Sample Log Entries:**

```
process 116238 still waiting for ShareLock on transaction 5238913 after 1000.062 ms
process 116234 still waiting for ShareLock on transaction 5238913 after 1000.116 ms
process 116249 acquired ExclusiveLock on tuple (266,5) after 3099.119 ms
```

**Impact:** Slows task updates but doesn't block processing

### Supabase Performance Advisories

#### üî¥ WARN: RLS Performance Issues (4 tables)

Tables affected: `users`, `organisations`, `jobs`, `tasks`

**Problem:** RLS policies re-evaluating `auth.<function>()` for EVERY row,
causing suboptimal query performance at scale.

**Solution:** Wrap auth functions with `(select ...)`:

```sql
-- Instead of:
WHERE organisation_id = auth.uid()

-- Use:
WHERE organisation_id = (select auth.uid())
```

**Documentation:**
https://supabase.com/docs/guides/database/database-linter?lint=0003_auth_rls_initplan

#### üü° INFO: Missing Indexes (5 foreign keys)

**Unindexed Foreign Keys:**

- `job_share_links.created_by` (low priority)
- `jobs.domain_id` ‚ö†Ô∏è **HIGH PRIORITY** (heavily queried)
- `jobs.user_id` ‚ö†Ô∏è **HIGH PRIORITY** (heavily queried)
- `tasks.page_id` (medium priority)
- `users.organisation_id` (medium priority)

**Recommended Indexes:**

```sql
CREATE INDEX idx_jobs_domain_id ON jobs(domain_id);
CREATE INDEX idx_jobs_user_id ON jobs(user_id);
CREATE INDEX idx_tasks_page_id ON tasks(page_id);
CREATE INDEX idx_users_organisation_id ON users(organisation_id);
CREATE INDEX idx_job_share_links_created_by ON job_share_links(created_by);
```

**Documentation:**
https://supabase.com/docs/guides/database/database-linter?lint=0001_unindexed_foreign_keys

#### üü° INFO: Table Bloat

**Table:** `jobs`

**Issue:** Excessive bloat detected, may benefit from maintenance

**Recommendation:**

- Schedule `VACUUM FULL` during maintenance window (requires downtime)
- Tune autovacuum settings to prevent future bloat

---

## Application Health

### API Response Times (Dashboard Endpoints)

- `/v1/dashboard/stats` - ~6ms average
- `/v1/jobs` - ~8-11ms average
- `/v1/jobs/{id}` - 2-150ms range
- `/v1/metadata/metrics` - <1ms (very fast)

**All endpoints returning 200 OK**

### Worker Activity

**Normal Operation Confirmed:**

- Workers finding and claiming tasks ‚úÖ
- URL warming happening continuously ‚úÖ
- Task completion every few seconds ‚úÖ
- Structured logging functioning correctly ‚úÖ

**Sample Log Entry:**

```json
{
  "level": "info",
  "service": "blue-banded-bee",
  "task_id": "4cad846b-a18b-4ac4-828b-5428822e0600",
  "job_id": "0a1782e3-32e2-4083-8b37-9ac5553b4070",
  "page_id": 6045001,
  "path": "/t/error-deploy-strapi/3832",
  "priority": 0.5,
  "message": "Found and claimed pending task"
}
```

### Expected Errors

**404 Errors (render.com):**

- Forum topics deleted from source site
- System correctly marks as failed and continues
- Not system errors - legitimate "page not found" responses

**Examples:**

```
/t/test-app-much-slower-for-some-requests-on-render-than-on-heroku/3641 ‚Üí 404
/t/getting-502-on-healthy-deployments/3628 ‚Üí 404
/t/managed-mysql-database/3675 ‚Üí 404
```

---

## Why Progress Appears Slow

### Root Causes Identified

1. **Large Sitemaps:**
   - creativebloq.com: 16,388 tasks (massive)
   - jbhifi.com.au: 14,024 tasks (massive)
   - render.com: 7,536 tasks
   - **Total:** 41,893 tasks

2. **Concurrency Limits:**
   - Each job: 3 concurrent workers
   - 5 active jobs: 15 workers total
   - 15 workers processing 41,893 tasks = expected slow progress

3. **Database Lock Contention:**
   - 1-6 second waits for transaction locks
   - Multiple workers competing for row updates
   - RLS policies adding row-by-row overhead

4. **Task Skipping (Deduplication):**
   - render.com: 2,539 skipped (34%)
   - creativebloq.com: 10,355 skipped (63%)
   - jbhifi.com.au: 8,024 skipped (57%)
   - System correctly avoiding duplicate processing

### Expected Completion Times

**At current throughput (450 tasks/min):**

- creativebloq.com (16,388 tasks): ~36 hours
- jbhifi.com.au (14,024 tasks): ~31 hours
- render.com (7,536 tasks): ~17 hours
- railway.app (2,033 tasks): ~4.5 hours
- kotn.com (1,912 tasks): ~4 hours

---

## 24-Hour System Summary

**Job Statistics:**

- Total jobs created: 19
- Completed: 14 (73.7%)
- Running: 5 (26.3%)
- Failed: 2 (10.5%)
- Unique domains processed: 17

**Task Throughput:**

- Total tasks created: 121,757
- Completed: 28,974 (23.8%)
- Failed: 5,347 (4.4%)
- Skipped: 77,365 (63.5%)
- Average task time: 2.179 seconds

---

## Recommendations

### Immediate Actions

1. **Increase Job Concurrency** (Quick Win)
   - Current: 3 workers per job
   - Recommended: 5-10 workers per job
   - Impact: 2-3x faster processing
   - Risk: Low (application handles this well)

2. **Add Missing Indexes** (Medium Priority)

   ```sql
   CREATE INDEX idx_jobs_domain_id ON jobs(domain_id);
   CREATE INDEX idx_jobs_user_id ON jobs(user_id);
   CREATE INDEX idx_tasks_page_id ON tasks(page_id);
   ```

   - Impact: Reduces table scans, improves query performance
   - Risk: Low (standard operation)

3. **Fix RLS Policies** (High Priority)
   - Change all `auth.uid()` to `(select auth.uid())`
   - Impact: Significant performance improvement at scale
   - Risk: Low (documented best practice)
   - [Documentation](https://supabase.com/docs/guides/database/database-linter?lint=0003_auth_rls_initplan)

### Maintenance Window

4. **VACUUM FULL on jobs table** (Scheduled Maintenance)
   - Addresses table bloat
   - Requires downtime
   - Schedule during low-traffic period

---

## Conclusion

**System Status: ‚úÖ Healthy**

The Blue Banded Bee service is operating correctly with:

- Consistent throughput: 400-550 tasks/minute
- Excellent response times: 3-6ms average
- Zero server/client errors
- Proper task deduplication
- Correct cache warming behaviour

**Performance bottlenecks identified:**

- Database lock contention (1-6s waits)
- RLS policy inefficiency (row-by-row auth checks)
- Missing foreign key indexes
- Large job queues with conservative concurrency limits

**The slow progress is expected behaviour** given the massive sitemaps (40,000+
total tasks) and current concurrency settings (3 workers per job). The system is
processing tasks correctly and efficiently within these constraints.

---

## Files Referenced

- Load test batch:
  `/Users/simonsmallchua/Documents/GitHub/blue-banded-bee/load_test_jobs.csv`
- Database schema: See `supabase/migrations/`
- Performance advisories:
  [Supabase Database Linter](https://supabase.com/docs/guides/database/database-linter)
