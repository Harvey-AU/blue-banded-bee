!function(){"use strict";class t{constructor(t={}){this.apiBaseUrl=t.apiBaseUrl||"",this.authManager=null,this.refreshInterval=t.refreshInterval||0,this.refreshTimer=null,this.debug=t.debug||!1,this.boundElements=new Map,this.templates=new Map,this.log("BBDataBinder initialized",t)}async init(){this.log("Initializing data binder..."),window.supabase&&await this.initAuth(),this.scanAndBind(),this.refreshInterval>0&&this.startAutoRefresh(),this.log("Data binder initialized successfully")}async initAuth(){try{const{data:{session:t}}=await window.supabase.auth.getSession();this.authManager={session:t,isAuthenticated:!!t,user:t?.user||null},window.supabase.auth.onAuthStateChange((t,e)=>{this.authManager.session=e,this.authManager.isAuthenticated=!!e,this.authManager.user=e?.user||null,this.updateAuthElements()}),this.log("Auth initialized",{authenticated:this.authManager.isAuthenticated})}catch(t){this.log("Auth initialization failed",t)}}scanAndBind(){this.log("Scanning DOM for data binding attributes...");const t=document.querySelectorAll("[data-bb-bind]"),e=document.querySelectorAll("[data-bb-bind-style]"),a=document.querySelectorAll("[data-bb-bind-attr]"),s=document.querySelectorAll("[data-bb-template]"),r=document.querySelectorAll("[data-bb-auth]"),i=document.querySelectorAll("[data-bb-form]");this.log("Found elements",{bind:t.length,style:e.length,attr:a.length,template:s.length,auth:r.length,forms:i.length}),t.forEach(t=>this.registerBindElement(t)),e.forEach(t=>this.registerStyleElement(t)),a.forEach(t=>this.registerAttrElement(t)),s.forEach(t=>this.registerTemplate(t)),r.forEach(t=>this.updateAuthElement(t)),i.forEach(t=>this.registerForm(t))}registerBindElement(t){const e=t.getAttribute("data-bb-bind");e&&(this.boundElements.has(e)||this.boundElements.set(e,[]),this.boundElements.get(e).push({element:t,type:"text",path:e}),this.log("Registered bind element",{path:e,element:t}))}registerStyleElement(t){const e=t.getAttribute("data-bb-bind-style");if(!e)return;const a=e.match(/^([^:]+):(.+)$/);if(!a)return;const[,s,r]=a,i=r.match(/\{([^}]+)\}/g);i&&i.forEach(e=>{const a=e.slice(1,-1);this.boundElements.has(a)||this.boundElements.set(a,[]),this.boundElements.get(a).push({element:t,type:"style",property:s,template:r,path:a})}),this.log("Registered style element",{property:s,template:r,element:t})}registerAttrElement(t){const e=t.getAttribute("data-bb-bind-attr");if(!e)return;const a=e.match(/^([^:]+):(.+)$/);if(!a)return;const[,s,r]=a,i=r.match(/\{([^}]+)\}/g);i&&i.forEach(e=>{const a=e.slice(1,-1);this.boundElements.has(a)||this.boundElements.set(a,[]),this.boundElements.get(a).push({element:t,type:"attribute",attribute:s,template:r,path:a})}),this.log("Registered attribute element",{attribute:s,template:r,element:t})}registerTemplate(t){const e=t.getAttribute("data-bb-template");e&&(this.templates.set(e,{element:t,originalHTML:t.outerHTML,parent:t.parentElement}),t.style.display="none",this.log("Registered template",{name:e,element:t}))}updateAuthElements(){document.querySelectorAll("[data-bb-auth]").forEach(t=>this.updateAuthElement(t))}updateAuthElement(t){let e=!1;switch(t.getAttribute("data-bb-auth")){case"required":e=this.authManager?.isAuthenticated||!1;break;case"guest":e=!this.authManager?.isAuthenticated;break;default:e=!0}t.style.display=e?"":"none"}registerForm(t){const e=t.getAttribute("data-bb-form");if(!e)return;this.log("Registering form",{action:e,form:t}),t.addEventListener("submit",async a=>{a.preventDefault(),await this.handleFormSubmit(t,e)});if("live"===t.getAttribute("data-bb-validate")){t.querySelectorAll("input, select, textarea").forEach(t=>{t.addEventListener("input",()=>this.validateFormField(t)),t.addEventListener("blur",()=>this.validateFormField(t))})}}async handleFormSubmit(t,e){try{this.log("Form submission started",{action:e}),this.setFormLoading(t,!0);if(!this.validateForm(t))return void this.setFormLoading(t,!1);const a=this.collectFormData(t),s=this.getFormEndpoint(e,a),r=await this.submitForm(s,a,e);this.handleFormSuccess(t,r,e)}catch(a){this.log("Form submission failed",{action:e,error:a}),this.handleFormError(t,a,e)}finally{this.setFormLoading(t,!1)}}collectFormData(t){const e=new FormData(t),a={};for(const[t,s]of e.entries())a[t]?Array.isArray(a[t])?a[t].push(s):a[t]=[a[t],s]:a[t]=s;return a}getFormEndpoint(t,e){switch(t){case"create-job":return"/v1/jobs";case"update-profile":return"/v1/auth/profile";case"create-organisation":return"/v1/organisations";default:const e=document.querySelector(`[data-bb-form="${t}"]`);return e?.getAttribute("data-bb-endpoint")||`/v1/${t}`}}async submitForm(t,e,a){const s=this.getFormMethod(a),r={"Content-Type":"application/json"};this.authManager?.session?.access_token&&(r.Authorization=`Bearer ${this.authManager.session.access_token}`);const i=await fetch(`${this.apiBaseUrl}${t}`,{method:s,headers:r,body:JSON.stringify(e)});if(!i.ok){const t=await i.json().catch(()=>({}));throw new Error(t.message||`HTTP ${i.status}: ${i.statusText}`)}return await i.json()}getFormMethod(t){switch(t){case"create-job":case"create-organisation":default:return"POST";case"update-profile":return"PUT";case"delete-job":return"DELETE"}}validateForm(t){const e=t.querySelectorAll("input, select, textarea");let a=!0;return e.forEach(t=>{this.validateFormField(t)||(a=!1)}),a}validateFormField(t){const e=this.getValidationRules(t),a=t.value.trim(),s=[];if(e.required&&!a&&s.push("This field is required"),a&&e.type)switch(e.type){case"email":/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(a)||s.push("Please enter a valid email address");break;case"url":try{new URL(a)}catch{s.push("Please enter a valid URL")}break;case"number":isNaN(Number(a))&&s.push("Please enter a valid number")}return a&&e.minLength&&a.length<e.minLength&&s.push(`Must be at least ${e.minLength} characters`),a&&e.maxLength&&a.length>e.maxLength&&s.push(`Must be no more than ${e.maxLength} characters`),a&&e.pattern&&!new RegExp(e.pattern).test(a)&&s.push(e.patternMessage||"Invalid format"),this.updateFieldValidation(t,s),0===s.length}getValidationRules(t){return{required:t.hasAttribute("required"),type:t.getAttribute("data-bb-validate-type")||t.type,minLength:parseInt(t.getAttribute("data-bb-validate-min"))||null,maxLength:parseInt(t.getAttribute("data-bb-validate-max"))||null,pattern:t.getAttribute("data-bb-validate-pattern"),patternMessage:t.getAttribute("data-bb-validate-message")}}updateFieldValidation(t,e){const a=0===e.length;t.classList.remove("bb-field-valid","bb-field-invalid");const s=t.parentElement.querySelector(".bb-field-error");if(s&&s.remove(),t.value.trim()&&(t.classList.add(a?"bb-field-valid":"bb-field-invalid"),!a)){const a=document.createElement("div");a.className="bb-field-error",a.textContent=e[0],a.style.cssText="color: #dc2626; font-size: 12px; margin-top: 4px;",t.parentElement.appendChild(a)}}setFormLoading(t,e){const a=t.querySelector('button[type="submit"], input[type="submit"]'),s=t.querySelectorAll("[data-bb-loading]");if(a)if(a.disabled=e,e)a.setAttribute("data-original-text",a.textContent),a.textContent="Loading...";else{const t=a.getAttribute("data-original-text");t&&(a.textContent=t,a.removeAttribute("data-original-text"))}s.forEach(t=>{t.style.display=e?"":"none"})}handleFormSuccess(t,e,a){this.log("Form submission successful",{action:a,result:e}),"true"===t.getAttribute("data-bb-clear-on-success")&&t.reset(),this.showFormMessage(t,"Success! Your request has been processed.","success");const s=new CustomEvent("bb-form-success",{detail:{action:a,result:e,form:t}});t.dispatchEvent(s);const r=t.getAttribute("data-bb-redirect");r&&setTimeout(()=>{window.location.href=r},1e3)}handleFormError(t,e,a){this.log("Form submission error",{action:a,error:e}),this.showFormMessage(t,e.message||"An error occurred. Please try again.","error");const s=new CustomEvent("bb-form-error",{detail:{action:a,error:e,form:t}});t.dispatchEvent(s)}showFormMessage(t,e,a){const s=t.querySelector(".bb-form-message");s&&s.remove();const r=document.createElement("div");r.className=`bb-form-message bb-form-message-${a}`,r.textContent=e;const i={padding:"12px 16px",borderRadius:"6px",marginBottom:"16px",fontSize:"14px",fontWeight:"500"};"success"===a?(i.background="#dcfce7",i.color="#16a34a",i.border="1px solid #bbf7d0"):(i.background="#fee2e2",i.color="#dc2626",i.border="1px solid #fecaca"),Object.assign(r.style,i),t.insertBefore(r,t.firstChild),setTimeout(()=>{r.parentElement&&r.remove()},5e3)}async fetchData(t,e={}){try{const a={"Content-Type":"application/json",...e.headers};this.authManager?.session?.access_token&&(a.Authorization=`Bearer ${this.authManager.session.access_token}`);const s={method:e.method||"GET",headers:a};e.body&&(s.body=e.body);const r=await fetch(`${this.apiBaseUrl}${t}`,s);if(!r.ok)throw new Error(`HTTP ${r.status}: ${r.statusText}`);const i=await r.json();return i.data||i}catch(e){throw this.log("API fetch failed",{endpoint:t,error:e}),e}}updateElements(t){this.log("Updating elements with data",t);for(const[e,a]of this.boundElements){const s=this.getValueByPath(t,e);a.forEach(e=>{switch(e.type){case"text":e.element.textContent=s??e.element.textContent;break;case"style":const a=this.processTemplate(e.template,t);null!==a&&(e.element.style[e.property]=a);break;case"attribute":const r=this.processTemplate(e.template,t);null!==r&&e.element.setAttribute(e.attribute,r)}})}}renderTemplate(t,e){const a=this.templates.get(t);if(!a)return void this.log("Template not found",t);this.log("Rendering template",{name:t,items:e?.length});a.parent.querySelectorAll(`[data-bb-template-instance="${t}"]`).forEach(t=>t.remove()),Array.isArray(e)&&e.length>0&&e.forEach((t,e)=>{const s=this.createTemplateInstance(a,t,e);s&&a.parent.appendChild(s)})}createTemplateInstance(t,e,a){const s=document.createElement("div");s.innerHTML=t.originalHTML;const r=s.firstElementChild;if(!r)return null;r.setAttribute("data-bb-template-instance",t.element.getAttribute("data-bb-template")),r.removeAttribute("data-bb-template"),r.style.display="";r.querySelectorAll("[data-bb-bind]").forEach(t=>{const a=t.getAttribute("data-bb-bind"),s=this.getValueByPath(e,a);void 0!==s&&(t.textContent=s)});r.querySelectorAll("[data-bb-bind-style]").forEach(t=>{const a=t.getAttribute("data-bb-bind-style").match(/^([^:]+):(.+)$/);if(a){const[,s,r]=a,i=this.processTemplate(r,e);null!==i&&(t.style[s]=i)}});return r.querySelectorAll("[data-bb-bind-attr]").forEach(t=>{const a=t.getAttribute("data-bb-bind-attr").match(/^([^:]+):(.+)$/);if(a){const[,s,r]=a,i=this.processTemplate(r,e);null!==i&&t.setAttribute(s,i)}}),r}processTemplate(t,e){return t.replace(/\{([^}]+)\}/g,(t,a)=>{const s=this.getValueByPath(e,a);return void 0!==s?s:t})}getValueByPath(t,e){return e.split(".").reduce((t,e)=>t&&void 0!==t[e]?t[e]:void 0,t)}startAutoRefresh(){this.refreshTimer&&clearInterval(this.refreshTimer),this.refreshTimer=setInterval(()=>{this.refresh()},1e3*this.refreshInterval),this.log("Auto-refresh started",{interval:this.refreshInterval})}stopAutoRefresh(){this.refreshTimer&&(clearInterval(this.refreshTimer),this.refreshTimer=null),this.log("Auto-refresh stopped")}async refresh(){this.log("Refresh called - override this method in your implementation")}async loadAndBind(t){try{const e=Object.entries(t).map(async([t,e])=>[t,await this.fetchData(e)]),a=await Promise.all(e),s=Object.fromEntries(a);return this.updateElements(s),s}catch(t){throw this.log("Load and bind failed",t),t}}bindTemplates(t){Object.entries(t).forEach(([t,e])=>{this.renderTemplate(t,e)})}log(t,e=null){this.debug&&console.log(`[BBDataBinder] ${t}`,e)}destroy(){this.stopAutoRefresh(),this.boundElements.clear(),this.templates.clear(),this.log("Data binder destroyed")}}"undefined"!=typeof module&&module.exports?module.exports=t:window.BBDataBinder=t}();
