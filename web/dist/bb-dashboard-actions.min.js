!function(){"use strict";let t=null,e=0,s="created_at",a="desc",i=!1;async function n(i){if(!i)return void console.error("No job ID provided");t=i,e=0,s="created_at",a="desc";document.querySelectorAll("#modalTaskFilterTabs .filter-tab").forEach(t=>{t.classList.remove("active"),""===t.dataset.status&&t.classList.add("active")});try{const t=await window.dataBinder.fetchData(`/v1/jobs/${i}`);t.id=i,t.progress_formatted=`${Math.round(t.progress||0)}%`;const e=t.started_at?new Date(t.started_at):null,s=t.completed_at?new Date(t.completed_at):null;if(t.started_at_formatted=e?e.toLocaleString():"-",t.completed_at_formatted=s?s.toLocaleString():"-",null!=t.duration_seconds){const e=t.duration_seconds,s=Math.floor(e/3600),a=Math.floor(e%3600/60),i=e%60;t.duration_formatted=s>0?`${s}h ${a}m ${i}s`:a>0?`${a}m ${i}s`:`${i}s`}else t.duration_formatted="-";if(null!=t.avg_time_per_task_seconds){const e=parseFloat(t.avg_time_per_task_seconds);if(e>=60){const s=Math.floor(e/60),a=(e%60).toFixed(2);t.avg_time_formatted=`${s}m ${a}s`}else t.avg_time_formatted=`${e.toFixed(2)}s`}else t.avg_time_formatted="-";t.stats&&(t.stats.cache_stats&&t.stats.cache_stats.hit_rate&&(t.stats.cache_stats.hit_rate=`${t.stats.cache_stats.hit_rate}%`),t.stats.cache_warming_effect&&t.stats.cache_warming_effect.total_time_saved_seconds&&(t.stats.cache_warming_effect.total_time_saved_seconds=`${t.stats.cache_warming_effect.total_time_saved_seconds}s`),t.stats.response_times&&(t.stats.response_times.avg_ms&&(t.stats.response_times.avg_ms=`${Math.round(t.stats.response_times.avg_ms)}ms`),t.stats.response_times.p95_ms&&(t.stats.response_times.p95_ms=`${Math.round(t.stats.response_times.p95_ms)}ms`)));const a=document.getElementById("modal-job-data");if(a&&window.dataBinder){a.querySelectorAll("[data-bb-bind]").forEach(e=>{const s=e.getAttribute("data-bb-bind"),a=function(t,e){return e.split(".").reduce((t,e)=>t?.[e],t)}(t,s);null!=a&&(e.textContent=a)})}t.stats&&function(t){if(!t)return;let e=document.getElementById("modal-stats-container");if(!e){const t=document.querySelector(".bb-job-info-grid");if(!t)return;e=document.createElement("div"),e.id="modal-stats-container",e.className="bb-modal-section",t.parentElement.insertAdjacentElement("afterend",e)}let s='<div class="bb-modal-section-title">Performance Statistics</div>';if(t.slow_page_buckets){const e=t.slow_page_buckets;s+='<div style="margin-bottom: 24px;">',s+='<h4 style="font-size: 14px; font-weight: 600; margin-bottom: 12px;">Response Time Distribution</h4>',s+='<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 12px;">',e.over_10s>0&&(s+=`<div class="bb-info-item" style="background: #fee2e2;">\n        <div class="bb-info-label">Over 10s</div>\n        <div class="bb-info-value" style="color: #dc2626;">${e.over_10s}</div>\n      </div>`),e["5_to_10s"]>0&&(s+=`<div class="bb-info-item" style="background: #fed7aa;">\n        <div class="bb-info-label">5-10s</div>\n        <div class="bb-info-value" style="color: #ea580c;">${e["5_to_10s"]}</div>\n      </div>`),e["3_to_5s"]>0&&(s+=`<div class="bb-info-item" style="background: #fef3c7;">\n        <div class="bb-info-label">3-5s</div>\n        <div class="bb-info-value" style="color: #d97706;">${e["3_to_5s"]}</div>\n      </div>`),e["2_to_3s"]>0&&(s+=`<div class="bb-info-item">\n        <div class="bb-info-label">2-3s</div>\n        <div class="bb-info-value">${e["2_to_3s"]}</div>\n      </div>`),e["1_5_to_2s"]>0&&(s+=`<div class="bb-info-item">\n        <div class="bb-info-label">1.5-2s</div>\n        <div class="bb-info-value">${e["1_5_to_2s"]}</div>\n      </div>`),e["1_to_1_5s"]>0&&(s+=`<div class="bb-info-item">\n        <div class="bb-info-label">1-1.5s</div>\n        <div class="bb-info-value">${e["1_to_1_5s"]}</div>\n      </div>`),s+=`<div class="bb-info-item">\n      <div class="bb-info-label">500ms-1s</div>\n      <div class="bb-info-value">${e["500ms_to_1s"]||0}</div>\n    </div>`,s+=`<div class="bb-info-item" style="background: #dcfce7;">\n      <div class="bb-info-label">Under 500ms</div>\n      <div class="bb-info-value" style="color: #16a34a;">${e.under_500ms||0}</div>\n    </div>`,e.total_slow_over_3s>0&&(s+=`<div class="bb-info-item" style="grid-column: span 2; background: #fee2e2;">\n        <div class="bb-info-label">Total Slow (>3s)</div>\n        <div class="bb-info-value" style="color: #dc2626; font-size: 20px;">${e.total_slow_over_3s}</div>\n      </div>`),s+="</div></div>"}if(t.cache_stats||t.cache_warming_effect){if(s+='<div style="margin-bottom: 24px;">',s+='<h4 style="font-size: 14px; font-weight: 600; margin-bottom: 12px;">Cache Performance</h4>',s+='<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 12px;">',t.cache_stats&&(s+=`<div class="bb-info-item">\n        <div class="bb-info-label">Cache Hits</div>\n        <div class="bb-info-value">${t.cache_stats.hits}</div>\n      </div>`,s+=`<div class="bb-info-item">\n        <div class="bb-info-label">Cache Misses</div>\n        <div class="bb-info-value">${t.cache_stats.misses}</div>\n      </div>`,t.cache_stats.hit_rate&&(s+=`<div class="bb-info-item" style="background: ${t.cache_stats.hit_rate>80?"#dcfce7":"#f9fafb"};">\n          <div class="bb-info-label">Hit Rate</div>\n          <div class="bb-info-value" style="color: ${t.cache_stats.hit_rate>80?"#16a34a":"#1f2937"};">${t.cache_stats.hit_rate}%</div>\n        </div>`)),t.cache_warming_effect){const e=t.cache_warming_effect;e.total_time_saved_seconds>0&&(s+=`<div class="bb-info-item" style="background: #dbeafe;">\n          <div class="bb-info-label">Time Saved</div>\n          <div class="bb-info-value" style="color: #1d4ed8;">${e.total_time_saved_seconds}s</div>\n        </div>`),e.avg_time_saved_per_page_ms>0&&(s+=`<div class="bb-info-item">\n          <div class="bb-info-label">Avg Saved/Page</div>\n          <div class="bb-info-value">${Math.round(e.avg_time_saved_per_page_ms)}ms</div>\n        </div>`),e.improvement_rate>0&&(s+=`<div class="bb-info-item">\n          <div class="bb-info-label">Improvement Rate</div>\n          <div class="bb-info-value">${e.improvement_rate}%</div>\n        </div>`)}s+="</div></div>"}if(t.response_times){const e=t.response_times;s+='<div style="margin-bottom: 24px;">',s+='<h4 style="font-size: 14px; font-weight: 600; margin-bottom: 12px;">Response Time Percentiles</h4>',s+='<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 12px;">',s+=`<div class="bb-info-item">\n      <div class="bb-info-label">P25</div>\n      <div class="bb-info-value">${Math.round(e.p25_ms)}ms</div>\n    </div>`,s+=`<div class="bb-info-item">\n      <div class="bb-info-label">Median</div>\n      <div class="bb-info-value">${Math.round(e.median_ms)}ms</div>\n    </div>`,s+=`<div class="bb-info-item">\n      <div class="bb-info-label">P75</div>\n      <div class="bb-info-value">${Math.round(e.p75_ms)}ms</div>\n    </div>`,s+=`<div class="bb-info-item">\n      <div class="bb-info-label">P90</div>\n      <div class="bb-info-value">${Math.round(e.p90_ms)}ms</div>\n    </div>`,s+=`<div class="bb-info-item">\n      <div class="bb-info-label">P95</div>\n      <div class="bb-info-value">${Math.round(e.p95_ms)}ms</div>\n    </div>`,s+=`<div class="bb-info-item">\n      <div class="bb-info-label">P99</div>\n      <div class="bb-info-value">${Math.round(e.p99_ms)}ms</div>\n    </div>`,s+="</div></div>"}(t.total_broken_links>0||t.total_404s>0||t.redirect_stats)&&(s+='<div style="margin-bottom: 24px;">',s+='<h4 style="font-size: 14px; font-weight: 600; margin-bottom: 12px;">Issues Found</h4>',s+='<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 12px;">',t.total_broken_links>0&&(s+=`<div class="bb-info-item" style="background: #fee2e2;">\n        <div class="bb-info-label">Broken Links</div>\n        <div class="bb-info-value" style="color: #dc2626;">${t.total_broken_links}</div>\n      </div>`),t.total_404s>0&&(s+=`<div class="bb-info-item" style="background: #fee2e2;">\n        <div class="bb-info-label">404 Errors</div>\n        <div class="bb-info-value" style="color: #dc2626;">${t.total_404s}</div>\n      </div>`),t.total_server_errors>0&&(s+=`<div class="bb-info-item" style="background: #fee2e2;">\n        <div class="bb-info-label">Server Errors</div>\n        <div class="bb-info-value" style="color: #dc2626;">${t.total_server_errors}</div>\n      </div>`),t.redirect_stats&&t.redirect_stats.total>0&&(s+=`<div class="bb-info-item">\n        <div class="bb-info-label">Total Redirects</div>\n        <div class="bb-info-value">${t.redirect_stats.total}</div>\n      </div>`,t.redirect_stats["301_permanent"]>0&&(s+=`<div class="bb-info-item">\n          <div class="bb-info-label">301 Permanent</div>\n          <div class="bb-info-value">${t.redirect_stats["301_permanent"]}</div>\n        </div>`),t.redirect_stats["302_temporary"]>0&&(s+=`<div class="bb-info-item">\n          <div class="bb-info-label">302 Temporary</div>\n          <div class="bb-info-value">${t.redirect_stats["302_temporary"]}</div>\n        </div>`)),s+="</div></div>");if(t.discovery_sources){const e=t.discovery_sources;s+='<div style="margin-bottom: 24px;">',s+='<h4 style="font-size: 14px; font-weight: 600; margin-bottom: 12px;">URL Discovery</h4>',s+='<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 12px;">',e.sitemap>0&&(s+=`<div class="bb-info-item">\n        <div class="bb-info-label">From Sitemap</div>\n        <div class="bb-info-value">${e.sitemap}</div>\n      </div>`),e.discovered>0&&(s+=`<div class="bb-info-item">\n        <div class="bb-info-label">Discovered</div>\n        <div class="bb-info-value">${e.discovered}</div>\n      </div>`),e.manual>0&&(s+=`<div class="bb-info-item">\n        <div class="bb-info-label">Manual</div>\n        <div class="bb-info-value">${e.manual}</div>\n      </div>`),s+="</div></div>"}e.innerHTML=s}(t.stats);const n=document.getElementById("modal-restart-btn"),d=document.getElementById("modal-cancel-btn");["completed","failed","cancelled"].includes(t.status)?(n.style.display="inline-block",d.style.display="none"):["running","pending"].includes(t.status)?(n.style.display="none",d.style.display="inline-block"):(n.style.display="none",d.style.display="none"),await o(i),function(){const t=document.getElementById("jobDetailsModal");t&&(t.style.display="flex")}()}catch(t){console.error("Failed to load job details:",t),window.Sentry&&window.Sentry.captureException(t,{tags:{component:"dashboard",action:"view_job_details"}}),l("Failed to load job details. Please check your connection and try again.")}}async function o(t){const n=document.getElementById("tasksContent"),o=document.getElementById("tasksPagination"),d=document.getElementById("tasksLimit");n.innerHTML='<div class="bb-loading">Loading tasks...</div>',o.style.display="none";try{const l=d?parseInt(d.value):50,c=e*l,r="desc"===a?"-"+s:s,b=document.querySelector("#modalTaskFilterTabs .filter-tab.active"),v=b?b.dataset.status:"";let m=`/v1/jobs/${t}/tasks?limit=${l}&offset=${c}&sort=${r}`;v&&(m+=`&status=${v}`);const f=await window.dataBinder.fetchData(m),_=f.tasks||[];if(0===_.length&&0===e)return void(n.innerHTML='<div class="bb-loading">No tasks found</div>');const p=t=>s===t?"desc"===a?" ↓":" ↑":"";let u=`\n    <table class="bb-tasks-table">\n      <thead>\n        <tr>\n          <th style="cursor: pointer;" onclick="sortTasks('path')">Path${p("path")}</th>\n          <th style="cursor: pointer;" onclick="sortTasks('status')">Status${p("status")}</th>\n          <th style="cursor: pointer;" onclick="sortTasks('response_time')">Response Time${p("response_time")}</th>\n          <th style="cursor: pointer;" onclick="sortTasks('cache_status')">Cache Status${p("cache_status")}</th>\n          <th style="cursor: pointer;" onclick="sortTasks('second_response_time')">2nd Request${p("second_response_time")}</th>\n          <th style="cursor: pointer;" onclick="sortTasks('status_code')">Status Code${p("status_code")}</th>\n        </tr>\n      </thead>\n      <tbody id="tasks-table-body">\n    `;if(_.forEach((t,e)=>{const s=`bb-status-${t.status}`;t.response_time_formatted=t.response_time?`${t.response_time}ms`:"-",t.second_response_time_formatted=t.second_response_time?`${t.second_response_time}ms`:"-",t.cache_status_display=t.cache_status||"-",t.status_code_display=t.status_code||"-",t.error_tooltip=t.error?t.error.substring(0,50)+(t.error.length>50?"...":""):"",u+=`\n        <tr data-task-index="${e}">\n          <td><a href="${t.url}" target="_blank"><code class="bb-task-path" data-bb-bind="tasks.${e}.path">${t.path}</code></a></td>\n          <td><span class="bb-task-status ${s}" data-bb-bind="tasks.${e}.status" ${t.error_tooltip?`title="${t.error_tooltip}"`:""}>${t.status}</span></td>\n          <td data-bb-bind="tasks.${e}.response_time_formatted">${t.response_time_formatted}</td>\n          <td data-bb-bind="tasks.${e}.cache_status_display" ${t.error_tooltip?`title="${t.error_tooltip}"`:""}>${t.cache_status_display}</td>\n          <td data-bb-bind="tasks.${e}.second_response_time_formatted">${t.second_response_time_formatted}</td>\n          <td data-bb-bind="tasks.${e}.status_code_display">${t.status_code_display}</td>\n        </tr>\n      `}),u+="</tbody></table>",n.innerHTML=u,window.currentTasksData?window.currentTasksData.tasks=_:window.currentTasksData={tasks:_},f.pagination){const{total:t,has_next:e,has_prev:s}=f.pagination;i=e;const a=c+1,n=Math.min(c+parseInt(l),t);document.getElementById("tasksPageInfo").textContent=`${a}-${n} of ${t} tasks`,document.getElementById("prevTasksBtn").disabled=!s,document.getElementById("nextTasksBtn").disabled=!e,o.style.display=t>l?"block":"none"}}catch(t){console.error("Failed to load tasks:",t),n.innerHTML='<div class="bb-error">Failed to load tasks</div>'}}function d(){const e=document.getElementById("jobDetailsModal");e&&(e.style.display="none"),t=null}function l(t){const e=document.createElement("div");e.style.cssText="\n    position: fixed; top: 20px; right: 20px; z-index: 10000;\n    background: #fee2e2; color: #dc2626; border: 1px solid #fecaca;\n    padding: 16px 20px; border-radius: 8px; max-width: 400px;\n    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);\n  ",e.innerHTML=`\n    <div style="display: flex; align-items: center; gap: 12px;">\n      <span>⚠️</span>\n      <span>${t}</span>\n      <button onclick="this.parentElement.parentElement.remove()" style="background: none; border: none; font-size: 18px; cursor: pointer;">×</button>\n    </div>\n  `,document.body.appendChild(e),setTimeout(()=>e.remove(),5e3)}"undefined"!=typeof window&&(window.setupDashboardActions=function(){document.addEventListener("click",s=>{const a=s.target.closest("[bb-action]");if(a){const c=a.getAttribute("bb-action");c&&(s.preventDefault(),function(s,a){switch(s){case"refresh-dashboard":window.dataBinder&&window.dataBinder.refresh();break;case"view-job-details":const c=a.getAttribute("bb-data-job-id");c&&n(c);break;case"close-modal":d();break;case"refresh-tasks":t&&o(t);break;case"tasks-prev-page":e>0&&(e--,o(t));break;case"tasks-next-page":i&&(e++,o(t));break;case"toggle-export-menu":const r=document.getElementById("exportDropdownMenu");r&&(r.style.display="block"===r.style.display?"none":"block");break;case"export-job":case"export-broken-links":case"export-slow-pages":!async function(e){if(t)try{let s=`/v1/jobs/${t}/export`;"job"!==e&&(s+=`?type=${e}`);const a=await window.dataBinder.fetchData(s),i=new Blob([JSON.stringify(a,null,2)],{type:"application/json"}),n=URL.createObjectURL(i),o=document.createElement("a");o.href=n,o.download=`${t}-${e}.json`,o.click(),URL.revokeObjectURL(n)}catch(t){console.error("Failed to export tasks:",t),l("Failed to export tasks")}}(s.replace("export-",""));break;case"restart-job":case"restart-job-modal":const b=a.getAttribute("bb-data-job-id")||t;b&&async function(t){if(t)try{await window.dataBinder.fetchData(`/v1/jobs/${t}/restart`,{method:"POST"}),d(),window.dataBinder&&window.dataBinder.refresh()}catch(t){console.error("Failed to restart job:",t),l("Failed to restart job")}}(b);break;case"cancel-job":case"cancel-job-modal":const v=a.getAttribute("bb-data-job-id")||t;v&&async function(t){if(t)try{await window.dataBinder.fetchData(`/v1/jobs/${t}/cancel`,{method:"POST"}),d(),window.dataBinder&&window.dataBinder.refresh()}catch(t){console.error("Failed to cancel job:",t),l("Failed to cancel job")}}(v);break;case"create-job":!function(){const t=document.getElementById("createJobModal");t&&(t.style.display="flex")}();break;case"close-create-job-modal":!function(){const t=document.getElementById("createJobModal");t&&(t.style.display="none")}();break;case"refresh-slow-pages":case"refresh-redirects":!async function(){window.dataBinder&&await window.dataBinder.refresh()}();break;default:console.log("Unhandled action:",s)}}(c,a))}}),document.addEventListener("click",s=>{const a=s.target.closest("#modalTaskFilterTabs .filter-tab");var i;a&&(s.preventDefault(),i=a,document.querySelectorAll("#modalTaskFilterTabs .filter-tab").forEach(t=>t.classList.remove("active")),i.classList.add("active"),e=0,t&&o(t))}),console.log("Dashboard action handlers initialized")},window.sortTasks=function(e){s===e?a="desc"===a?"asc":"desc":(s=e,a="desc"),o(t)},window.viewJobDetails=n,window.loadJobTasks=o)}();
