#!/bin/bash
# Pre-commit hook to automatically format files before committing
# This hook runs gofmt on Go files and prettier on docs/config files
# Compatible with: Mac, Linux, Windows (Git Bash)

set -e

echo "Running pre-commit formatting checks..."

# Detect if we're on Windows (Git Bash)
IS_WINDOWS=false
if [[ "$OSTYPE" == "msys" || "$OSTYPE" == "win32" ]]; then
    IS_WINDOWS=true
fi

# Colours for output (disable on Windows if needed)
if [ "$IS_WINDOWS" = true ]; then
    RED=''
    GREEN=''
    YELLOW=''
    NC=''
else
    RED='\033[0;31m'
    GREEN='\033[0;32m'
    YELLOW='\033[1;33m'
    NC='\033[0m'
fi

# Track if any files were formatted
FILES_FORMATTED=false

# === FORMAT GO FILES ===
echo ""
echo "üìù Formatting Go files..."

# Get list of staged Go files
STAGED_GO_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep '\.go$' || true)

if [ -n "$STAGED_GO_FILES" ]; then
    echo "Found Go files to format:"
    echo "$STAGED_GO_FILES"

    # Format each file
    for file in $STAGED_GO_FILES; do
        if [ -f "$file" ]; then
            gofmt -w "$file"
            git add "$file"
            echo "  ‚úÖ Formatted: $file"
            FILES_FORMATTED=true
        fi
    done
else
    echo "  ‚ÑπÔ∏è  No Go files to format"
fi

# === FORMAT DOCS/CONFIG FILES ===
echo ""
echo "üìù Formatting docs and config files..."

# Check if prettier is installed
if ! command -v prettier &> /dev/null; then
    echo -e "${YELLOW}‚ö†Ô∏è  Prettier not installed. Install with: npm install -g prettier${NC}"
    echo "Skipping prettier formatting..."
else
    # Get list of staged markdown/YAML/JSON files
    STAGED_DOC_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.(md|yml|yaml|json)$' || true)

    if [ -n "$STAGED_DOC_FILES" ]; then
        echo "Found docs/config files to format:"
        echo "$STAGED_DOC_FILES"

        # Format files with prettier (suppress warnings)
        echo "$STAGED_DOC_FILES" | xargs prettier --write --log-level warn 2>/dev/null || \
        echo "$STAGED_DOC_FILES" | xargs prettier --write

        # Re-add formatted files
        echo "$STAGED_DOC_FILES" | xargs git add

        echo "  ‚úÖ Formatted with prettier"
        FILES_FORMATTED=true
    else
        echo "  ‚ÑπÔ∏è  No docs/config files to format"
    fi
fi

# === SUMMARY ===
echo ""
if [ "$FILES_FORMATTED" = true ]; then
    echo -e "${GREEN}‚ú® Files formatted successfully!${NC}"
    echo "Changes have been staged. Your commit will now proceed."
else
    echo -e "${GREEN}‚úÖ All staged files were already formatted${NC}"
fi

echo ""
exit 0
