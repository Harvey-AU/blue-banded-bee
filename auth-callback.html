<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Authentication - Blue Banded Bee</title>
    
    <!-- Supabase CDN -->
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            margin: 0;
            padding: 0;
            background: #f5f7fa;
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .auth-container {
            max-width: 400px;
            padding: 40px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            text-align: center;
        }

        .bee-icon {
            font-size: 48px;
            margin-bottom: 16px;
        }

        h1 {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 8px;
            color: #1a1a1a;
        }

        .status-message {
            color: #6b7280;
            font-size: 14px;
            margin-bottom: 24px;
        }

        .spinner {
            width: 32px;
            height: 32px;
            border: 3px solid #e5e7eb;
            border-top: 3px solid #3b82f6;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 16px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error-message {
            background: #fee2e2;
            color: #dc2626;
            padding: 12px 16px;
            border-radius: 6px;
            margin-bottom: 16px;
            font-size: 14px;
            border: 1px solid #fecaca;
        }

        .success-message {
            background: #dcfce7;
            color: #16a34a;
            padding: 12px 16px;
            border-radius: 6px;
            margin-bottom: 16px;
            font-size: 14px;
            border: 1px solid #bbf7d0;
        }

        .redirect-info {
            font-size: 12px;
            color: #9ca3af;
            margin-top: 16px;
        }

        .manual-link {
            display: inline-block;
            margin-top: 16px;
            padding: 8px 16px;
            background: #3b82f6;
            color: white;
            text-decoration: none;
            border-radius: 6px;
            font-weight: 500;
            transition: background-color 0.2s;
        }

        .manual-link:hover {
            background: #2563eb;
        }
    </style>
</head>
<body>
    <div class="auth-container">
        <div class="bee-icon">üêù</div>
        <h1>Blue Banded Bee</h1>
        
        <div id="loading" class="status-content">
            <div class="spinner"></div>
            <div class="status-message">Processing authentication...</div>
        </div>

        <div id="success" class="status-content" style="display: none;">
            <div class="success-message">Authentication successful!</div>
            <div class="status-message">Redirecting you back to the application...</div>
            <div class="redirect-info">If you're not redirected automatically, <a href="#" id="manualRedirectLink" class="manual-link">click here</a></div>
        </div>

        <div id="error" class="status-content" style="display: none;">
            <div class="error-message" id="errorMessage">Authentication failed</div>
            <div class="status-message">There was a problem with your authentication.</div>
            <a href="/" class="manual-link">Return to Home</a>
        </div>
    </div>

    <script>
        // Supabase configuration
        const SUPABASE_URL = 'https://auth.bluebandedbee.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imdwemp0Ymd0ZGp4bmFjZGZ1anZ4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDUwNjYxNjMsImV4cCI6MjA2MDY0MjE2M30.eJjM2-3X8oXsFex_lQKvFkP1-_yLMHsueIn7_hCF6YI';
        
        let supabase;
        
        // Show specific status
        function showStatus(statusId, message = null) {
            document.querySelectorAll('.status-content').forEach(el => {
                el.style.display = 'none';
            });
            
            const statusEl = document.getElementById(statusId);
            if (statusEl) {
                statusEl.style.display = 'block';
            }
            
            if (message && statusId === 'error') {
                document.getElementById('errorMessage').textContent = message;
            }
        }
        
        // Validate return URL for security
        function isValidReturnUrl(url) {
            try {
                const parsedUrl = new URL(url);
                const allowedDomains = [
                    'bluebandedbee.co',
                    'app.bluebandedbee.co',
                    'fly.dev',
                    'localhost'
                ];
                
                return allowedDomains.some(domain => 
                    parsedUrl.hostname === domain || 
                    parsedUrl.hostname.endsWith('.' + domain)
                );
            } catch {
                return false;
            }
        }
        
        // Register user with backend
        async function registerUserWithBackend(user, session) {
            try {
                const response = await fetch('/v1/auth/register', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${session.access_token}`
                    },
                    body: JSON.stringify({
                        user_id: user.id,
                        email: user.email,
                        full_name: user.user_metadata?.full_name || null
                    })
                });

                if (response.ok || response.status === 409) {
                    console.log('User registered with backend');
                    return true;
                }
            } catch (error) {
                console.error('Backend registration error:', error);
            }
            return false;
        }
        
        // Handle authentication callback
        async function handleAuthCallback() {
            try {
                // Initialize Supabase
                supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                
                // Get auth data from URL hash
                const hashParams = new URLSearchParams(window.location.hash.substring(1));
                const accessToken = hashParams.get('access_token');
                const refreshToken = hashParams.get('refresh_token');
                const state = hashParams.get('state');
                const error = hashParams.get('error');
                const errorDescription = hashParams.get('error_description');
                
                // Check for auth errors
                if (error) {
                    throw new Error(errorDescription || error);
                }
                
                // Check for tokens
                if (!accessToken || !refreshToken) {
                    throw new Error('No authentication tokens received');
                }
                
                console.log('Processing OAuth callback...');
                
                // Set session in Supabase
                const { data: { session }, error: sessionError } = await supabase.auth.setSession({
                    access_token: accessToken,
                    refresh_token: refreshToken
                });
                
                if (sessionError) {
                    throw sessionError;
                }
                
                if (!session) {
                    throw new Error('Failed to establish session');
                }
                
                console.log('Session established for:', session.user.email);
                
                // Register user with backend
                await registerUserWithBackend(session.user, session);
                
                // Determine return URL
                let returnUrl = '/dashboard'; // Default return URL
                
                if (state) {
                    try {
                        const stateData = JSON.parse(atob(state));
                        if (stateData.returnUrl && isValidReturnUrl(stateData.returnUrl)) {
                            returnUrl = stateData.returnUrl;
                            console.log('Using return URL from state:', returnUrl);
                        }
                    } catch (e) {
                        console.warn('Invalid state parameter:', e);
                    }
                }
                
                // Show success
                showStatus('success');
                
                // Set up manual redirect link
                const manualLink = document.getElementById('manualRedirectLink');
                if (manualLink) {
                    manualLink.href = returnUrl;
                }
                
                // Redirect after a short delay
                setTimeout(() => {
                    window.location.href = returnUrl;
                }, 2000);
                
            } catch (error) {
                console.error('Auth callback error:', error);
                showStatus('error', error.message || 'Authentication failed');
            }
        }
        
        // Handle page load
        document.addEventListener('DOMContentLoaded', () => {
            // Check if we have auth data in the URL
            if (window.location.hash && window.location.hash.includes('access_token')) {
                handleAuthCallback();
            } else {
                // No auth data, redirect to home
                showStatus('error', 'No authentication data received');
                setTimeout(() => {
                    window.location.href = '/';
                }, 3000);
            }
        });
    </script>
</body>
</html>