<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Blue Banded Bee - Job Dashboard</title>
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      margin: 0;
      padding: 0;
      background: #f5f7fa;
      min-height: 100vh;
    }

    .page-header {
      background: white;
      border-bottom: 1px solid #e5e7eb;
      padding: 24px 0;
      position: sticky;
      top: 0;
      z-index: 100;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }

    .page-header .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 0 24px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .page-title {
      display: flex;
      align-items: center;
      gap: 12px;
      margin: 0;
      font-size: 1.5rem;
      font-weight: 700;
      color: #1a1a1a;
    }

    .bee-icon {
      font-size: 1.8rem;
    }

    .page-nav {
      display: flex;
      gap: 24px;
      align-items: center;
    }

    .nav-link {
      color: #6b7280;
      text-decoration: none;
      font-weight: 500;
      transition: color 0.2s ease;
    }

    .nav-link:hover,
    .nav-link.active {
      color: #3b82f6;
    }

    .user-menu {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .user-avatar {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      background: #3b82f6;
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
      font-size: 14px;
    }

    .main-content {
      max-width: 1200px;
      margin: 0 auto;
      padding: 24px;
    }

    .auth-required {
      text-align: center;
      padding: 60px 20px;
      background: white;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    .auth-required h2 {
      margin: 0 0 16px 0;
      color: #374151;
    }

    .auth-required p {
      margin: 0 0 32px 0;
      color: #6b7280;
    }

    .auth-container {
      max-width: 400px;
      margin: 0 auto;
    }

    .dashboard-actions {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 24px;
      padding: 20px;
      background: white;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    .dashboard-filters {
      display: flex;
      gap: 16px;
      align-items: center;
    }

    .filter-group {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .filter-label {
      font-size: 12px;
      font-weight: 500;
      color: #6b7280;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .filter-select {
      padding: 8px 12px;
      border: 1px solid #d1d5db;
      border-radius: 6px;
      font-size: 14px;
      background: white;
      color: #374151;
    }

    .filter-select:focus {
      outline: none;
      border-color: #3b82f6;
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }

    .page-actions {
      display: flex;
      gap: 12px;
    }

    .status-indicator {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-size: 12px;
      color: #6b7280;
    }

    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: #22c55e;
      animation: pulse 2s infinite;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }

    @media (max-width: 768px) {
      .page-header .container {
        padding: 0 16px;
      }

      .page-nav {
        display: none;
      }

      .main-content {
        padding: 16px;
      }

      .dashboard-actions {
        flex-direction: column;
        align-items: stretch;
        gap: 16px;
      }

      .dashboard-filters {
        justify-content: space-between;
      }

      .page-actions {
        justify-content: center;
      }
    }
  </style>
</head>
<body>
  <!-- Page Header -->
  <header class="page-header">
    <div class="container">
      <h1 class="page-title">
        <span class="bee-icon">üêù</span>
        Blue Banded Bee
      </h1>
      
      <nav class="page-nav">
        <a href="/dashboard" class="nav-link active">Dashboard</a>
        <a href="/jobs" class="nav-link">Jobs</a>
        <a href="/settings" class="nav-link">Settings</a>
        <a href="/help" class="nav-link">Help</a>
      </nav>

      <div class="user-menu">
        <div class="status-indicator">
          <span class="status-dot"></span>
          <span>Live</span>
        </div>
        <div class="user-avatar" id="userAvatar">?</div>
      </div>
    </div>
  </header>

  <!-- Main Content -->
  <main class="main-content">
    <!-- Dashboard Controls -->
    <div class="dashboard-actions">
      <div class="dashboard-filters">
        <div class="filter-group">
          <label class="filter-label">Date Range</label>
          <select class="filter-select" id="dateRange">
            <option value="today">Today</option>
            <option value="last7" selected>Last 7 Days</option>
            <option value="last30">Last 30 Days</option>
            <option value="last90">Last 90 Days</option>
            <option value="all">All Time</option>
          </select>
        </div>
        
        <div class="filter-group">
          <label class="filter-label">Refresh</label>
          <select class="filter-select" id="refreshInterval">
            <option value="0">Manual</option>
            <option value="10" selected>10 seconds</option>
            <option value="30">30 seconds</option>
            <option value="60">1 minute</option>
          </select>
        </div>
      </div>

      <div class="page-actions">
        <button class="bb-btn bb-btn-secondary" onclick="refreshDashboard()">
          <span>‚Üª</span> Refresh
        </button>
        <button class="bb-btn bb-btn-primary" onclick="createNewJob()">
          <span>+</span> New Job
        </button>
      </div>
    </div>

    <!-- Authentication Check -->
    <bb-auth-login id="authCheck" style="display: none;">
      <div class="auth-required">
        <h2>Authentication Required</h2>
        <p>Please sign in to access your cache warming dashboard.</p>
        <div class="auth-container">
          <!-- Auth component will populate here -->
        </div>
      </div>
    </bb-auth-login>

    <!-- Job Dashboard Component -->
    <bb-job-dashboard 
      id="jobDashboard"
      auto-load="true"
      refresh-interval="10"
      show-charts="true"
      date-range="last7"
      limit="10"
      style="display: none;">
    </bb-job-dashboard>
  </main>

  <!-- Load Blue Banded Bee Components -->
  <script src="/js/bb-components.min.js"></script>

  <script>
    // Dashboard state management
    let currentUser = null;
    let dashboardComponent = null;

    // Initialize page
    document.addEventListener('DOMContentLoaded', async () => {
      console.log('Dashboard page initializing...');
      
      // Get component references
      const authComponent = document.getElementById('authCheck');
      dashboardComponent = document.getElementById('jobDashboard');
      
      // Check authentication status
      const authManager = await BBComponents.getAuthManager();
      
      // Listen for auth state changes
      authComponent.addEventListener('authenticated', handleAuthenticated);
      authComponent.addEventListener('unauthenticated', handleUnauthenticated);
      
      // Listen for dashboard events
      dashboardComponent.addEventListener('create-job-requested', handleCreateJobRequest);
      dashboardComponent.addEventListener('job-details-requested', handleJobDetailsRequest);
      dashboardComponent.addEventListener('job-cancelled', handleJobAction);
      dashboardComponent.addEventListener('job-retried', handleJobAction);
      dashboardComponent.addEventListener('dashboard-loaded', handleDashboardLoaded);
      dashboardComponent.addEventListener('dashboard-error', handleDashboardError);

      // Setup filter controls
      setupFilters();

      // Check initial auth state
      const session = await authManager.getSession();
      if (session?.user) {
        handleAuthenticated({ detail: { user: session.user } });
      } else {
        handleUnauthenticated();
      }
    });

    function handleAuthenticated(event) {
      currentUser = event.detail.user;
      console.log('User authenticated:', currentUser);
      
      // Update user avatar
      const avatar = document.getElementById('userAvatar');
      if (currentUser.email) {
        avatar.textContent = currentUser.email.charAt(0).toUpperCase();
        avatar.title = currentUser.email;
      }
      
      // Show dashboard, hide auth
      document.getElementById('authCheck').style.display = 'none';
      document.getElementById('jobDashboard').style.display = 'block';
      
      // Load dashboard data
      dashboardComponent.refresh();
    }

    function handleUnauthenticated() {
      currentUser = null;
      console.log('User not authenticated');
      
      // Show auth, hide dashboard
      document.getElementById('authCheck').style.display = 'block';
      document.getElementById('jobDashboard').style.display = 'none';
      
      // Reset user avatar
      document.getElementById('userAvatar').textContent = '?';
    }

    function handleCreateJobRequest() {
      // Redirect to job creation page or show modal
      console.log('Create job requested');
      // For now, just alert - this would typically open a modal or redirect
      alert('Job creation interface would open here');
    }

    function handleJobDetailsRequest(event) {
      const { jobId } = event.detail;
      console.log('Job details requested for:', jobId);
      // Redirect to job details page
      window.location.href = `/jobs/${jobId}`;
    }

    function handleJobAction(event) {
      console.log('Job action completed:', event.type, event.detail);
      // Show success message
      showNotification(`Job ${event.type.replace('job-', '')} successfully`);
    }

    function handleDashboardLoaded(event) {
      console.log('Dashboard loaded:', event.detail.data);
      // Could update page title with stats, etc.
    }

    function handleDashboardError(event) {
      console.error('Dashboard error:', event.detail.error);
      showNotification('Failed to load dashboard data', 'error');
    }

    function setupFilters() {
      const dateRange = document.getElementById('dateRange');
      const refreshInterval = document.getElementById('refreshInterval');

      dateRange.addEventListener('change', () => {
        if (dashboardComponent) {
          dashboardComponent.setAttribute('date-range', dateRange.value);
        }
      });

      refreshInterval.addEventListener('change', () => {
        if (dashboardComponent) {
          dashboardComponent.setAttribute('refresh-interval', refreshInterval.value);
        }
      });
    }

    function refreshDashboard() {
      if (dashboardComponent) {
        dashboardComponent.refresh();
      }
    }

    function createNewJob() {
      handleCreateJobRequest();
    }

    function showNotification(message, type = 'success') {
      // Simple notification system
      const notification = document.createElement('div');
      notification.style.cssText = `
        position: fixed;
        top: 24px;
        right: 24px;
        padding: 16px 24px;
        border-radius: 8px;
        color: white;
        font-weight: 500;
        z-index: 1000;
        animation: slideIn 0.3s ease;
        background: ${type === 'error' ? '#ef4444' : '#22c55e'};
      `;
      notification.textContent = message;
      
      document.body.appendChild(notification);
      
      setTimeout(() => {
        notification.style.animation = 'slideOut 0.3s ease';
        setTimeout(() => notification.remove(), 300);
      }, 3000);
    }

    // Add keyframe animations
    const style = document.createElement('style');
    style.textContent = `
      @keyframes slideIn {
        from { transform: translateX(100%); opacity: 0; }
        to { transform: translateX(0); opacity: 1; }
      }
      @keyframes slideOut {
        from { transform: translateX(0); opacity: 1; }
        to { transform: translateX(100%); opacity: 0; }
      }
    `;
    document.head.appendChild(style);
  </script>
</body>
</html>